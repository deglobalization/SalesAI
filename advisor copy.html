<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì—…ì‚¬ì› AI ë¹„ì„œ - ë°ì´í„° ë¶„ì„ í”Œë«í¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0b0d;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .background-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.03;
            background-image: 
                radial-gradient(circle at 20% 50%, #00d4ff 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, #ff6b35 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, #7c3aed 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 40px;
            padding: 40px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(124, 58, 237, 0.1));
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .header-content {
            flex: 1;
            text-align: center;
        }

        .map-container {
            width: 400px;
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(17, 24, 39, 0.8);
            position: relative;
        }

        .map-title {
            position: absolute;
            top: 10px;
            left: 15px;
            background: rgba(17, 24, 39, 0.9);
            color: #00d4ff;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 1000;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        #salesMap {
            width: 100%;
            height: 100%;
            border-radius: 13px;
        }

        /* ì§€ì—­ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .leaflet-interactive.top-region {
            filter: drop-shadow(0 0 10px rgba(255, 107, 53, 0.8));
            transition: all 0.3s ease;
        }

        .leaflet-interactive.region-highlight {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .leaflet-interactive.region-highlight:hover {
            filter: brightness(1.3) drop-shadow(0 0 8px currentColor);
            transform: scale(1.02);
        }

        /* ì„¸ë¶€ ì§€ì—­ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .leaflet-interactive.top-detailed-region {
            filter: drop-shadow(0 0 15px rgba(255, 23, 68, 1.0));
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .leaflet-interactive.detailed-region-highlight {
            transition: all 0.2s ease;
            cursor: pointer;
            z-index: 999;
        }

        .leaflet-interactive.detailed-region-highlight:hover {
            filter: brightness(1.4) drop-shadow(0 0 12px currentColor);
            transform: scale(1.05);
        }

        /* ì„¸ë¶€ ì§€ì—­ ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        .detailed-region-label div {
            transition: all 0.3s ease;
        }

        .detailed-region-label div:hover {
            transform: scale(1.1) !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6) !important;
        }

        /* íŒì—… ìŠ¤íƒ€ì¼ ê°œì„  */
        .leaflet-popup-content-wrapper {
            background: rgba(17, 24, 39, 0.95) !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px) !important;
        }

        .leaflet-popup-tip {
            background: rgba(17, 24, 39, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 1.2rem;
            color: #a1a1aa;
            font-weight: 400;
        }

        .control-panel {
            background: rgba(17, 24, 39, 0.8);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(75, 85, 99, 0.3);
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .file-input-area {
            border: 2px dashed rgba(75, 85, 99, 0.5);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 25px;
            background: rgba(31, 41, 55, 0.3);
        }

        .file-input-area:hover, .file-input-area.dragover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.05);
        }

        .file-input {
            display: none;
        }

        .file-input-label, .demo-data-btn {
            display: inline-block;
            padding: 14px 28px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .file-input-label {
            background: linear-gradient(135deg, #00d4ff, #0ea5e9);
            color: white;
            margin-right: 15px;
        }

        .demo-data-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .file-input-label:hover, .demo-data-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .analysis-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            background: rgba(31, 41, 55, 0.8);
            color: #ffffff;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            border-color: #00d4ff;
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(75, 85, 99, 0.3);
            border-radius: 2px;
            overflow: hidden;
            margin: 25px 0 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
            width: 0%;
            transition: width 0.8s ease;
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
            border-left: 4px solid;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-left-color: #10b981;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-left-color: #ef4444;
        }

        .status-info {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            border-left-color: #00d4ff;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .analysis-card {
            background: rgba(17, 24, 39, 0.8);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(75, 85, 99, 0.3);
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .analysis-card h3 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(31, 41, 55, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(75, 85, 99, 0.2);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #00d4ff;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #9ca3af;
            font-weight: 500;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(31, 41, 55, 0.3);
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(75, 85, 99, 0.2);
        }

        th {
            background: rgba(17, 24, 39, 0.8);
            color: #00d4ff;
            font-weight: 600;
            font-size: 0.9rem;
        }

        td {
            color: #d1d5db;
            font-size: 0.9rem;
        }

        tr:hover {
            background: rgba(75, 85, 99, 0.1);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 212, 255, 0.2);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* ë§¤ì¶œì•¡ ê¸°ì¤€ ì„¸ê·¸ë¨¼íŠ¸ ìŠ¤íƒ€ì¼ */
        .segment-sales-premium {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.2), rgba(126, 34, 206, 0.1));
            border-left: 4px solid #9333ea;
        }

        .segment-sales-high {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1));
            border-left: 4px solid #10b981;
        }

        .segment-sales-medium {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1));
            border-left: 4px solid #3b82f6;
        }

        .segment-sales-low {
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(75, 85, 99, 0.1));
            border-left: 4px solid #6b7280;
        }

        /* BCG Matrix ì„¸ê·¸ë¨¼íŠ¸ ìŠ¤íƒ€ì¼ */
        .segment-bcg-star {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 193, 7, 0.1));
            border-left: 4px solid #FFD700;
        }

        .segment-bcg-cash-cow {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.1));
            border-left: 4px solid #22C55E;
        }

        .segment-bcg-question-mark {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1));
            border-left: 4px solid #f59e0b;
        }

        .segment-bcg-dog {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
            border-left: 4px solid #ef4444;
        }

        .segment-bcg-basic {
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(75, 85, 99, 0.1));
            border-left: 4px solid #6b7280;
        }

        .recommendation-item {
            background: rgba(31, 41, 55, 0.5);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #7c3aed;
        }

        .recommendation-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .recommendation-description {
            color: #d1d5db;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .recommendation-metrics {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #9ca3af;
        }

        .export-formats {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .export-btn {
            padding: 8px 16px;
            background: rgba(124, 58, 237, 0.8);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: rgba(124, 58, 237, 1);
            transform: translateY(-1px);
        }

        .clickable-product {
            transition: all 0.3s ease;
        }

        .clickable-product:hover {
            color: #7c3aed !important;
            text-shadow: 0 0 8px rgba(0, 212, 255, 0.5);
            transform: scale(1.05);
        }

        .clickable-segment {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .clickable-segment:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            filter: brightness(1.2);
        }

        .clickable-segment:active {
            transform: translateY(-1px) scale(1.02);
        }

        .clickable-segment::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .clickable-segment:hover::before {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .header-content {
                flex: none;
            }
            
            .map-container {
                width: 100%;
                height: 250px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            .analysis-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
                text-align: center;
            }
        }
        

    </style>
    
    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Papa Parse (CSV íŒŒì‹±) -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Leaflet ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="background-pattern"></div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>ğŸ¤– ì˜ì—…ì‚¬ì› AI ë¹„ì„œ</h1>
                <p>ë°ì´í„° ê¸°ë°˜ ì˜ì—… ë¶„ì„ ë° ì¶”ì²œ ì‹œìŠ¤í…œ</p>
            </div>
            <div class="map-container">
                <div class="map-title">ğŸ“ ì§€ì—­ ì§€ë„</div>
                <div id="salesMap"></div>
            </div>
        </div>

        <div class="control-panel">
            <div class="file-input-area" id="fileInputArea" style="display: none;">
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls">
                <label for="fileInput" class="file-input-label">ğŸ“ CSV íŒŒì¼ ì—…ë¡œë“œ</label>
                <button class="demo-data-btn" onclick="generateDemoData()">ğŸ¯ ë°ëª¨ ë°ì´í„° ìƒì„±</button>
                <p style="margin-top: 15px; color: #9ca3af; font-size: 0.9rem;">
                    CSV íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”
                </p>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div id="statusMessage" class="status-message hidden">
                ìƒíƒœ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>

            <div class="analysis-controls">
                <button class="btn" id="basicAnalysisBtn" onclick="performBasicAnalysis()" disabled>
                    ğŸ“Š ê¸°ë³¸ ë¶„ì„
                </button>
                <button class="btn" id="segmentationBtn" onclick="performCustomerSegmentation()" disabled>
                    ğŸ¯ ê³ ê° ì„¸ë¶„í™”
                </button>
                <button class="btn" id="recommendationBtn" onclick="generateRecommendations()" disabled>
                    ğŸ’¡ ì¶”ì²œ ìƒì„±
                </button>
                <button class="btn" id="exportBtn" onclick="exportAnalysis()" disabled>
                    ğŸ“¤ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°
                </button>
                <button class="btn" id="manualUploadBtn" onclick="showManualUpload()" style="display: none;">
                    ğŸ“ ë‹¤ë¥¸ íŒŒì¼ ì—…ë¡œë“œ
                </button>
            </div>
        </div>

        <div class="analysis-grid" id="analysisGrid">
            <!-- ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë“¤
        let salesData = [];
        let processedData = {};
        let analysisResults = {};
        let librariesLoaded = false;
        let salesMap = null;

        // í•œêµ­ ì§€ì—­ ì •ë³´ (ì¤‘ì‹¬ì¢Œí‘œ, ê²½ê³„, ì§€ì—­ëª…)
        const regionData = {
            'ì„œìš¸': { 
                lat: 37.5665, lng: 126.9780, name: 'ì„œìš¸íŠ¹ë³„ì‹œ',
                bounds: [[37.7, 126.7], [37.4, 127.2]] // [ë¶ì„œ, ë‚¨ë™]
            },
            'ë¶€ì‚°': { 
                lat: 35.1796, lng: 129.0756, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ',
                bounds: [[35.4, 128.8], [35.0, 129.3]]
            },
            'ëŒ€êµ¬': { 
                lat: 35.8722, lng: 128.6014, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ',
                bounds: [[36.0, 128.4], [35.7, 128.8]]
            },
            'ì¸ì²œ': { 
                lat: 37.4563, lng: 126.7052, name: 'ì¸ì²œê´‘ì—­ì‹œ',
                bounds: [[37.7, 126.3], [37.2, 126.9]]
            },
            'ê´‘ì£¼': { 
                lat: 35.1595, lng: 126.8526, name: 'ê´‘ì£¼ê´‘ì—­ì‹œ',
                bounds: [[35.3, 126.7], [35.0, 127.0]]
            },
            'ëŒ€ì „': { 
                lat: 36.3504, lng: 127.3845, name: 'ëŒ€ì „ê´‘ì—­ì‹œ',
                bounds: [[36.5, 127.2], [36.2, 127.5]]
            },
            'ìš¸ì‚°': { 
                lat: 35.5384, lng: 129.3114, name: 'ìš¸ì‚°ê´‘ì—­ì‹œ',
                bounds: [[35.7, 129.0], [35.4, 129.5]]
            },
            'ì„¸ì¢…': { 
                lat: 36.4800, lng: 127.2890, name: 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ',
                bounds: [[36.6, 127.1], [36.3, 127.4]]
            },
            'ê²½ê¸°': { 
                lat: 37.4138, lng: 127.5183, name: 'ê²½ê¸°ë„',
                bounds: [[38.0, 126.4], [36.8, 127.9]]
            },
            'ê°•ì›': { 
                lat: 37.8228, lng: 128.1555, name: 'ê°•ì›ë„',
                bounds: [[38.6, 127.0], [37.0, 129.4]]
            },
            'ì¶©ë¶': { 
                lat: 36.8, lng: 127.7, name: 'ì¶©ì²­ë¶ë„',
                bounds: [[37.2, 127.2], [36.2, 128.5]]
            },
            'ì¶©ë‚¨': { 
                lat: 36.5, lng: 126.8, name: 'ì¶©ì²­ë‚¨ë„',
                bounds: [[37.1, 125.9], [36.0, 127.6]]
            },
            'ì „ë¶': { 
                lat: 35.7175, lng: 127.153, name: 'ì „ë¼ë¶ë„',
                bounds: [[36.2, 126.4], [35.2, 127.8]]
            },
            'ì „ë‚¨': { 
                lat: 34.8679, lng: 126.991, name: 'ì „ë¼ë‚¨ë„',
                bounds: [[35.4, 126.0], [34.0, 127.7]]
            },
            'ê²½ë¶': { 
                lat: 36.4919, lng: 128.888, name: 'ê²½ìƒë¶ë„',
                bounds: [[37.5, 128.0], [35.7, 130.0]]
            },
            'ê²½ë‚¨': { 
                lat: 35.4606, lng: 128.2132, name: 'ê²½ìƒë‚¨ë„',
                bounds: [[36.0, 127.5], [34.6, 129.2]]
            },
            'ì œì£¼': { 
                lat: 33.4996, lng: 126.5312, name: 'ì œì£¼íŠ¹ë³„ìì¹˜ë„',
                bounds: [[33.6, 126.1], [33.1, 127.0]]
            }
        };

        // ì‹œ/êµ°/êµ¬ ì„¸ë¶€ ì§€ì—­ ì •ë³´
        const detailedRegionData = {
            // ì„œìš¸ êµ¬
            'ê°•ë‚¨': { lat: 37.5173, lng: 127.0473, name: 'ê°•ë‚¨êµ¬', parent: 'ì„œìš¸', bounds: [[37.54, 127.02], [37.49, 127.07]] },
            'ê°•ë¶': { lat: 37.6379, lng: 127.0258, name: 'ê°•ë¶êµ¬', parent: 'ì„œìš¸', bounds: [[37.66, 127.00], [37.61, 127.05]] },
            'ì†¡íŒŒ': { lat: 37.5145, lng: 127.1059, name: 'ì†¡íŒŒêµ¬', parent: 'ì„œìš¸', bounds: [[37.54, 127.08], [37.49, 127.13]] },
            'ë§ˆí¬': { lat: 37.5663, lng: 126.9019, name: 'ë§ˆí¬êµ¬', parent: 'ì„œìš¸', bounds: [[37.59, 126.88], [37.54, 126.93]] },
            'ìš©ì‚°': { lat: 37.5326, lng: 126.9906, name: 'ìš©ì‚°êµ¬', parent: 'ì„œìš¸', bounds: [[37.56, 126.97], [37.51, 127.02]] },
            'ì¢…ë¡œ': { lat: 37.5735, lng: 126.9788, name: 'ì¢…ë¡œêµ¬', parent: 'ì„œìš¸', bounds: [[37.60, 126.96], [37.55, 127.01]] },
            'ì„œì´ˆ': { lat: 37.4837, lng: 127.0324, name: 'ì„œì´ˆêµ¬', parent: 'ì„œìš¸', bounds: [[37.51, 127.01], [37.46, 127.06]] },
            'ê´€ì•…': { lat: 37.4781, lng: 126.9515, name: 'ê´€ì•…êµ¬', parent: 'ì„œìš¸', bounds: [[37.50, 126.93], [37.45, 126.98]] },
            'ë™ì‘': { lat: 37.5124, lng: 126.9393, name: 'ë™ì‘êµ¬', parent: 'ì„œìš¸', bounds: [[37.54, 126.92], [37.49, 126.97]] },
            'ì˜ë“±í¬': { lat: 37.5264, lng: 126.8963, name: 'ì˜ë“±í¬êµ¬', parent: 'ì„œìš¸', bounds: [[37.55, 126.88], [37.50, 126.93]] },
            
            // ê²½ê¸°ë„ ì£¼ìš” ì‹œ
            'ìˆ˜ì›': { lat: 37.2636, lng: 127.0286, name: 'ìˆ˜ì›ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.32, 126.98], [37.21, 127.08]] },
            'ì„±ë‚¨': { lat: 37.4201, lng: 127.1262, name: 'ì„±ë‚¨ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.47, 127.08], [37.37, 127.17]] },
            'ê³ ì–‘': { lat: 37.6584, lng: 126.8320, name: 'ê³ ì–‘ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.72, 126.78], [37.60, 126.88]] },
            'ìš©ì¸': { lat: 37.2411, lng: 127.1776, name: 'ìš©ì¸ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.30, 127.13], [37.18, 127.22]] },
            'ë¶€ì²œ': { lat: 37.5034, lng: 126.7660, name: 'ë¶€ì²œì‹œ', parent: 'ê²½ê¸°', bounds: [[37.53, 126.74], [37.48, 126.79]] },
            'ì•ˆì‚°': { lat: 37.3219, lng: 126.8309, name: 'ì•ˆì‚°ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.36, 126.79], [37.28, 126.87]] },
            'ì•ˆì–‘': { lat: 37.3943, lng: 126.9568, name: 'ì•ˆì–‘ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.42, 126.93], [37.37, 126.98]] },
            'ë‚¨ì–‘ì£¼': { lat: 37.6364, lng: 127.2167, name: 'ë‚¨ì–‘ì£¼ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.72, 127.15], [37.55, 127.28]] },
            'í™”ì„±': { lat: 37.1999, lng: 126.8310, name: 'í™”ì„±ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.28, 126.75], [37.12, 126.91]] },
            'í‰íƒ': { lat: 37.0000, lng: 127.1120, name: 'í‰íƒì‹œ', parent: 'ê²½ê¸°', bounds: [[37.05, 127.06], [36.95, 127.16]] },
            'ì˜ì •ë¶€': { lat: 37.7381, lng: 127.0338, name: 'ì˜ì •ë¶€ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.77, 127.00], [37.71, 127.07]] },
            'ì‹œí¥': { lat: 37.3803, lng: 126.8028, name: 'ì‹œí¥ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.42, 126.76], [37.34, 126.85]] },
            'íŒŒì£¼': { lat: 37.7595, lng: 126.7804, name: 'íŒŒì£¼ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.82, 126.72], [37.70, 126.84]] },
            'ê´‘ëª…': { lat: 37.4786, lng: 126.8645, name: 'ê´‘ëª…ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.50, 126.84], [37.46, 126.89]] },
            'ê¹€í¬': { lat: 37.6152, lng: 126.7157, name: 'ê¹€í¬ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.67, 126.67], [37.56, 126.76]] },
            'êµ°í¬': { lat: 37.3617, lng: 126.9353, name: 'êµ°í¬ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.38, 126.91], [37.34, 126.96]] },
            'ì´ì²œ': { lat: 37.2721, lng: 127.4350, name: 'ì´ì²œì‹œ', parent: 'ê²½ê¸°', bounds: [[37.32, 127.38], [37.22, 127.49]] },
            'ì–‘ì£¼': { lat: 37.7855, lng: 127.0459, name: 'ì–‘ì£¼ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.82, 127.00], [37.75, 127.09]] },
            'ì˜¤ì‚°': { lat: 37.1500, lng: 127.0772, name: 'ì˜¤ì‚°ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.17, 127.05], [37.13, 127.10]] },
            'êµ¬ë¦¬': { lat: 37.5943, lng: 127.1295, name: 'êµ¬ë¦¬ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.62, 127.10], [37.57, 127.16]] },
            'í•˜ë‚¨': { lat: 37.5394, lng: 127.2148, name: 'í•˜ë‚¨ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.57, 127.19], [37.51, 127.24]] },
            'ì–‘í‰': { lat: 37.4919, lng: 127.4875, name: 'ì–‘í‰êµ°', parent: 'ê²½ê¸°', bounds: [[37.57, 127.40], [37.41, 127.57]] },
            'ì—°ì²œ': { lat: 38.0960, lng: 127.0757, name: 'ì—°ì²œêµ°', parent: 'ê²½ê¸°', bounds: [[38.18, 127.01], [38.01, 127.14]] },
            
            // ë¶€ì‚° êµ¬
            'í•´ìš´ëŒ€': { lat: 35.1631, lng: 129.1635, name: 'í•´ìš´ëŒ€êµ¬', parent: 'ë¶€ì‚°', bounds: [[35.19, 129.14], [35.14, 129.19]] },
            'ì‚¬ìƒ': { lat: 35.1520, lng: 128.9910, name: 'ì‚¬ìƒêµ¬', parent: 'ë¶€ì‚°', bounds: [[35.17, 128.97], [35.13, 129.01]] },
            'ë¶€ì‚°ì§„': { lat: 35.1622, lng: 129.0537, name: 'ë¶€ì‚°ì§„êµ¬', parent: 'ë¶€ì‚°', bounds: [[35.18, 129.03], [35.14, 129.08]] },
            
            // ì¸ì²œ êµ¬
            'ë¶€í‰': { lat: 37.5070, lng: 126.7219, name: 'ë¶€í‰êµ¬', parent: 'ì¸ì²œ', bounds: [[37.53, 126.70], [37.48, 126.75]] },
            'ë‚¨ë™': { lat: 37.4470, lng: 126.7314, name: 'ë‚¨ë™êµ¬', parent: 'ì¸ì²œ', bounds: [[37.48, 126.70], [37.41, 126.76]] },
            'ê³„ì–‘': { lat: 37.5372, lng: 126.7379, name: 'ê³„ì–‘êµ¬', parent: 'ì¸ì²œ', bounds: [[37.56, 126.71], [37.51, 126.77]] },
            
            // ê°•ì›ë„ ì£¼ìš” ì‹œ
            'ì¶˜ì²œ': { lat: 37.8813, lng: 127.7298, name: 'ì¶˜ì²œì‹œ', parent: 'ê°•ì›', bounds: [[37.94, 127.67], [37.82, 127.79]] },
            'ì›ì£¼': { lat: 37.3422, lng: 127.9202, name: 'ì›ì£¼ì‹œ', parent: 'ê°•ì›', bounds: [[37.39, 127.87], [37.29, 127.97]] },
            'ê°•ë¦‰': { lat: 37.7519, lng: 128.8761, name: 'ê°•ë¦‰ì‹œ', parent: 'ê°•ì›', bounds: [[37.80, 128.83], [37.70, 128.92]] },
            'ì†ì´ˆ': { lat: 38.2070, lng: 128.5918, name: 'ì†ì´ˆì‹œ', parent: 'ê°•ì›', bounds: [[38.24, 128.56], [38.17, 128.62]] },
            
            // ì¶©ì²­ë¶ë„ ì£¼ìš” ì‹œ
            'ì²­ì£¼': { lat: 36.6424, lng: 127.4890, name: 'ì²­ì£¼ì‹œ', parent: 'ì¶©ë¶', bounds: [[36.70, 127.44], [36.58, 127.54]] },
            'ì¶©ì£¼': { lat: 36.9910, lng: 127.9259, name: 'ì¶©ì£¼ì‹œ', parent: 'ì¶©ë¶', bounds: [[37.04, 127.88], [36.94, 127.97]] },
            'ì œì²œ': { lat: 37.1326, lng: 128.1907, name: 'ì œì²œì‹œ', parent: 'ì¶©ë¶', bounds: [[37.18, 128.14], [37.09, 128.24]] },
            
            // ì¶©ì²­ë‚¨ë„ ì£¼ìš” ì‹œ
            'ì²œì•ˆ': { lat: 36.8151, lng: 127.1139, name: 'ì²œì•ˆì‹œ', parent: 'ì¶©ë‚¨', bounds: [[36.87, 127.06], [36.76, 127.17]] },
            'ì•„ì‚°': { lat: 36.7898, lng: 127.0016, name: 'ì•„ì‚°ì‹œ', parent: 'ì¶©ë‚¨', bounds: [[36.83, 126.96], [36.75, 127.04]] },
            'ì„œì‚°': { lat: 36.7848, lng: 126.4503, name: 'ì„œì‚°ì‹œ', parent: 'ì¶©ë‚¨', bounds: [[36.82, 126.41], [36.75, 126.49]] },
            'ê³µì£¼': { lat: 36.4465, lng: 127.1189, name: 'ê³µì£¼ì‹œ', parent: 'ì¶©ë‚¨', bounds: [[36.49, 127.08], [36.40, 127.16]] }
        };

        // ê±°ë˜ì²˜ëª…ì—ì„œ ì§€ì—­ ì¶”ì • í•¨ìˆ˜ (ì„¸ë¶€ ì§€ì—­ ìš°ì„ )
        function estimateRegionFromName(accountName) {
            // 1. ë¨¼ì € ì„¸ë¶€ ì§€ì—­(ì‹œ/êµ°/êµ¬) í™•ì¸
            for (const [detailRegion, info] of Object.entries(detailedRegionData)) {
                if (accountName.includes(detailRegion) || accountName.includes(info.name)) {
                    return {
                        region: info.parent,
                        detailedRegion: detailRegion,
                        detailedInfo: info
                    };
                }
            }
            
            // 2. ê´‘ì—­ ì§€ì—­ëª…ì´ ê±°ë˜ì²˜ëª…ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            for (const [region, info] of Object.entries(regionData)) {
                if (accountName.includes(region) || accountName.includes(info.name)) {
                    return {
                        region: region,
                        detailedRegion: null,
                        detailedInfo: null
                    };
                }
            }
            
            // 3. íŠ¹ì • í‚¤ì›Œë“œë¡œ ì„¸ë¶€ ì§€ì—­ ì¶”ì •
            for (const [detailRegion, info] of Object.entries(detailedRegionData)) {
                if (accountName.includes(detailRegion)) {
                    return {
                        region: info.parent,
                        detailedRegion: detailRegion,
                        detailedInfo: info
                    };
                }
            }
            
            // 4. ê´‘ì—­ ì§€ì—­ í‚¤ì›Œë“œë¡œ ì¶”ì •
            const regionKeywords = {
                'ì„œìš¸': ['ê°•ì„œ', 'ì¤‘êµ¬', 'ê¸ˆì²œ', 'êµ¬ë¡œ', 'ë…¸ì›', 'ë„ë´‰', 'ì„±ë¶', 'ì„œëŒ€ë¬¸', 'ì¤‘ë‘', 'ë™ëŒ€ë¬¸', 'ì„±ë™', 'ê´‘ì§„', 'ì€í‰'],
                'ë¶€ì‚°': ['ë™ë˜', 'ë‚¨êµ¬', 'ë¶êµ¬', 'ì‚¬í•˜', 'ê¸ˆì •', 'ì—°ì œ', 'ìˆ˜ì˜', 'ê°•ì„œêµ¬', 'ê¸°ì¥'],
                'ëŒ€êµ¬': ['ë‹¬ì„œ', 'ìˆ˜ì„±', 'ë‹¬ì„±', 'ë¶êµ¬', 'ì¤‘êµ¬', 'ë™êµ¬', 'ì„œêµ¬', 'ë‚¨êµ¬'],
                'ì¸ì²œ': ['ì„œêµ¬', 'ì¤‘êµ¬', 'ë™êµ¬', 'ì—°ìˆ˜', 'ë‚¨êµ¬', 'ê°•í™”', 'ì˜¹ì§„'],
                'ê²½ê¸°': ['ê´‘ì£¼ì‹œ', 'ì•ˆì„±', 'í¬ì²œ', 'ì˜ì™•', 'ì—¬ì£¼', 'ë™ë‘ì²œ', 'ê³¼ì²œ', 'ê°€í‰'],
                'ê°•ì›': ['ë™í•´', 'íƒœë°±', 'ì‚¼ì²™', 'í™ì²œ', 'íš¡ì„±', 'ì˜ì›”', 'í‰ì°½', 'ì •ì„ ', 'ì² ì›', 'í™”ì²œ', 'ì–‘êµ¬', 'ì¸ì œ', 'ê³ ì„±', 'ì–‘ì–‘'],
                'ì¶©ë¶': ['ë³´ì€', 'ì˜¥ì²œ', 'ì˜ë™', 'ì¦í‰', 'ì§„ì²œ', 'ê´´ì‚°', 'ìŒì„±', 'ë‹¨ì–‘'],
                'ì¶©ë‚¨': ['ë³´ë ¹', 'ë…¼ì‚°', 'ê³„ë£¡', 'ë‹¹ì§„', 'ê¸ˆì‚°', 'ë¶€ì—¬', 'ì„œì²œ', 'ì²­ì–‘', 'í™ì„±', 'ì˜ˆì‚°', 'íƒœì•ˆ'],
                'ì „ë¶': ['ì „ì£¼', 'êµ°ì‚°', 'ìµì‚°', 'ì •ì', 'ë‚¨ì›', 'ê¹€ì œ', 'ì™„ì£¼', 'ì§„ì•ˆ', 'ë¬´ì£¼', 'ì¥ìˆ˜', 'ì„ì‹¤', 'ìˆœì°½', 'ê³ ì°½', 'ë¶€ì•ˆ'],
                'ì „ë‚¨': ['ëª©í¬', 'ì—¬ìˆ˜', 'ìˆœì²œ', 'ë‚˜ì£¼', 'ê´‘ì–‘', 'ë‹´ì–‘', 'ê³¡ì„±', 'êµ¬ë¡€', 'ê³ í¥', 'ë³´ì„±', 'í™”ìˆœ', 'ì¥í¥', 'ê°•ì§„', 'í•´ë‚¨', 'ì˜ì•”', 'ë¬´ì•ˆ', 'í•¨í‰', 'ì˜ê´‘', 'ì¥ì„±', 'ì™„ë„', 'ì§„ë„', 'ì‹ ì•ˆ'],
                'ê²½ë¶': ['í¬í•­', 'ê²½ì£¼', 'ê¹€ì²œ', 'ì•ˆë™', 'êµ¬ë¯¸', 'ì˜ì£¼', 'ì˜ì²œ', 'ìƒì£¼', 'ë¬¸ê²½', 'ê²½ì‚°', 'êµ°ìœ„', 'ì˜ì„±', 'ì²­ì†¡', 'ì˜ì–‘', 'ì˜ë•', 'ì²­ë„', 'ê³ ë ¹', 'ì„±ì£¼', 'ì¹ ê³¡', 'ì˜ˆì²œ', 'ë´‰í™”', 'ìš¸ì§„', 'ìš¸ë¦‰'],
                'ê²½ë‚¨': ['ì°½ì›', 'ì§„ì£¼', 'í†µì˜', 'ì‚¬ì²œ', 'ê¹€í•´', 'ë°€ì–‘', 'ê±°ì œ', 'ì–‘ì‚°', 'ì˜ë ¹', 'í•¨ì•ˆ', 'ì°½ë…•', 'ê³ ì„±', 'ë‚¨í•´', 'í•˜ë™', 'ì‚°ì²­', 'í•¨ì–‘', 'ê±°ì°½', 'í•©ì²œ'],
                'ì œì£¼': ['ì œì£¼ì‹œ', 'ì„œê·€í¬']
            };
            
            for (const [region, keywords] of Object.entries(regionKeywords)) {
                for (const keyword of keywords) {
                    if (accountName.includes(keyword)) {
                        return {
                            region: region,
                            detailedRegion: null,
                            detailedInfo: null
                        };
                    }
                }
            }
            
            // ì¶”ì • ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ê¸°ë³¸ê°’
            return {
                region: 'ê¸°íƒ€',
                detailedRegion: null,
                detailedInfo: null
            };
        }

        // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
        function ensureLibrariesLoaded() {
            if (typeof Chart === 'undefined' || typeof Papa === 'undefined' || typeof L === 'undefined') {
                showStatus('í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...', 'info');
                return false;
            }
            return true;
        }

        // ì§€ë„ ì´ˆê¸°í™”
        function initializeMap() {
            if (salesMap) {
                salesMap.remove();
            }

            // í•œêµ­ ì¤‘ì‹¬ ì¢Œí‘œë¡œ ì§€ë„ ì´ˆê¸°í™”
            salesMap = L.map('salesMap', {
                center: [36.5, 127.8],
                zoom: 7,
                zoomControl: false,
                attributionControl: false,
                dragging: true,
                touchZoom: true,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                minZoom: 6,
                maxZoom: 12
            });

            // ì–´ë‘ìš´ í…Œë§ˆì˜ íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(salesMap);

            // ì „ì²´ ë³´ê¸° ë²„íŠ¼ ì¶”ê°€
            const resetControl = L.control({position: 'topright'});
            resetControl.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                div.innerHTML = '<button onclick="resetMapView()" style="background: rgba(17, 24, 39, 0.9); color: #00d4ff; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸŒ ì „ì²´</button>';
                div.style.backgroundColor = 'transparent';
                div.style.border = 'none';
                return div;
            };
            resetControl.addTo(salesMap);

            updateRegionalMap();
        }

        // ì§€ì—­ë³„ ë§¤ì¶œ ë°ì´í„°ë¡œ ì§€ë„ ì—…ë°ì´íŠ¸ (ì§€ì—­ ê°•ì¡° ì‹œìŠ¤í…œ)
        let currentRegionLayers = [];
        
        function updateRegionalMap() {
            if (!salesMap || !salesData || salesData.length === 0) return;

            // ê¸°ì¡´ ë ˆì´ì–´ ì œê±°
            currentRegionLayers.forEach(layer => {
                salesMap.removeLayer(layer);
            });
            currentRegionLayers = [];

            // ìµœê·¼ ì›” ë°ì´í„°ë¡œ ì§€ì—­ë³„ ë§¤ì¶œ ê³„ì‚° (ì„¸ë¶€ ì§€ì—­ í¬í•¨)
            const recentMonthData = salesData.filter(row => row['ê¸°ì¤€ë…„ì›”'] === processedData.recentMonth);
            const regionalSales = {};
            const detailedRegionalSales = {};

            recentMonthData.forEach(row => {
                const estimatedResult = estimateRegionFromName(row['ê±°ë˜ì²˜ëª…']);
                
                if (estimatedResult.region !== 'ê¸°íƒ€') {
                    // ê´‘ì—­ ì§€ì—­ë³„ ë§¤ì¶œ
                    if (regionData[estimatedResult.region]) {
                        regionalSales[estimatedResult.region] = (regionalSales[estimatedResult.region] || 0) + (row['ì´ë§¤ì¶œ'] || 0);
                    }
                    
                    // ì„¸ë¶€ ì§€ì—­ë³„ ë§¤ì¶œ (ì„¸ë¶€ ì§€ì—­ì´ í™•ì¸ëœ ê²½ìš°)
                    if (estimatedResult.detailedRegion && estimatedResult.detailedInfo) {
                        const detailKey = `${estimatedResult.region}-${estimatedResult.detailedRegion}`;
                        detailedRegionalSales[detailKey] = {
                            sales: (detailedRegionalSales[detailKey]?.sales || 0) + (row['ì´ë§¤ì¶œ'] || 0),
                            region: estimatedResult.region,
                            detailedRegion: estimatedResult.detailedRegion,
                            detailedInfo: estimatedResult.detailedInfo,
                            accounts: [...(detailedRegionalSales[detailKey]?.accounts || []), row['ê±°ë˜ì²˜ëª…']]
                        };
                    }
                }
            });

            // ìµœëŒ€ê°’ ê³„ì‚° ë° ì •ë ¬
            const sortedRegions = Object.entries(regionalSales)
                .sort((a, b) => b[1] - a[1]);
            
            // ì„¸ë¶€ ì§€ì—­ ì •ë ¬ (ê°€ì¥ ë†’ì€ ë§¤ì¶œì˜ ì„¸ë¶€ ì§€ì—­ ì°¾ê¸°)
            const sortedDetailedRegions = Object.entries(detailedRegionalSales)
                .sort((a, b) => b[1].sales - a[1].sales);
            
            if (sortedRegions.length === 0) return;

            const maxSales = sortedRegions[0][1];
            const topRegion = sortedRegions[0][0];

            // "í•˜ë‚¨" ì§€ì—­ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ìš°ì„  ê°•ì¡°
            const hanamRegion = detailedRegionalSales['ê²½ê¸°-í•˜ë‚¨'];
            if (hanamRegion) {
                setTimeout(() => {
                    highlightHanamRegion(hanamRegion);
                }, 500);
            } else if (sortedDetailedRegions.length > 0) {
                const topDetailedRegion = sortedDetailedRegions[0][1];
                setTimeout(() => {
                    highlightTopDetailedRegion(topDetailedRegion);
                }, 500);
            } else {
                setTimeout(() => {
                    highlightTopRegion(topRegion, regionalSales[topRegion]);
                }, 500);
            }

            // ëª¨ë“  ì§€ì—­ì— ë™ì¼í•œ ìŠ¤íƒ€ì¼ë¡œ ê²½ê³„ í‘œì‹œ
            sortedRegions.forEach(([region, sales], index) => {
                const regionInfo = regionData[region];
                if (!regionInfo) return;

                // ëª¨ë“  ì§€ì—­ ë™ì¼í•œ ìƒ‰ìƒê³¼ ìŠ¤íƒ€ì¼
                const color = '#00d4ff';
                const fillOpacity = 0.1;
                const strokeWeight = 1;

                // ì§€ì—­ ê²½ê³„ ì‚¬ê°í˜• (ì‹¤ì œ ê²½ê³„ ê·¼ì‚¬)
                const bounds = regionInfo.bounds;
                const rectangle = L.rectangle(bounds, {
                    color: color,
                    fillColor: color,
                    fillOpacity: fillOpacity,
                    weight: strokeWeight,
                    opacity: 0.5,
                    className: 'region-highlight'
                }).addTo(salesMap);

                currentRegionLayers.push(rectangle);
            });

            // ì„¸ë¶€ ì§€ì—­ í‘œì‹œëŠ” í•˜ë‚¨ë§Œ ìœ ì§€ (í™•ëŒ€ ê¸°ëŠ¥ë§Œ)
            sortedDetailedRegions.forEach(([detailKey, detailData], index) => {
                const { detailedInfo, sales } = detailData;
                const isHanamRegion = detailData.detailedRegion === 'í•˜ë‚¨';
                
                // í•˜ë‚¨ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ê°„ë‹¨í•œ ë°•ìŠ¤ ìƒì„±
                if (!isHanamRegion) {
                    // ì„¸ë¶€ ì§€ì—­ ê²½ê³„ (ë‹¨ìˆœí•œ ìŠ¤íƒ€ì¼)
                    const detailRectangle = L.rectangle(detailedInfo.bounds, {
                        color: '#7c3aed',
                        fillColor: '#7c3aed',
                        fillOpacity: 0.1,
                        weight: 1,
                        opacity: 0.5,
                        className: 'detailed-region-highlight'
                    }).addTo(salesMap);

                    currentRegionLayers.push(detailRectangle);
                }
            });
        }

        // í•˜ë‚¨ ì§€ì—­ ì „ìš© ê°•ì¡° (í™•ëŒ€ë§Œ)
        function highlightHanamRegion(detailData) {
            const { detailedInfo } = detailData;
            
            // í•˜ë‚¨ ì§€ì—­ìœ¼ë¡œ í™•ëŒ€
            salesMap.flyToBounds(detailedInfo.bounds, {
                paddingTopLeft: [8, 8],
                paddingBottomRight: [8, 8],
                duration: 2.0,
                maxZoom: 12
            });
        }

        // ìµœìƒìœ„ ë§¤ì¶œ ì„¸ë¶€ ì§€ì—­ ìë™ í™•ëŒ€ (í™•ëŒ€ë§Œ)
        function highlightTopDetailedRegion(detailData) {
            const { detailedInfo } = detailData;
            
            // ì„¸ë¶€ ì§€ì—­ìœ¼ë¡œ í™•ëŒ€
            salesMap.flyToBounds(detailedInfo.bounds, {
                paddingTopLeft: [10, 10],
                paddingBottomRight: [10, 10],
                duration: 2.0,
                maxZoom: 12
            });
        }

        // ìµœìƒìœ„ ë§¤ì¶œ ì§€ì—­ ìë™ í™•ëŒ€ (í™•ëŒ€ë§Œ)
        function highlightTopRegion(region, sales) {
            const regionInfo = regionData[region];
            if (!regionInfo) return;

            // ë¶€ë“œëŸ¬ìš´ í™•ëŒ€
            salesMap.flyToBounds(regionInfo.bounds, {
                paddingTopLeft: [20, 20],
                paddingBottomRight: [20, 20],
                duration: 2,
                maxZoom: 9
            });
        }

        // ì„¸ë¶€ ì§€ì—­ í™•ëŒ€ ë° ê°•ì¡°
        function highlightDetailedRegion(detailData) {
            const { detailedInfo, sales, accounts } = detailData;
            
            salesMap.flyToBounds(detailedInfo.bounds, {
                paddingTopLeft: [10, 10],
                paddingBottomRight: [10, 10],
                duration: 1.5,
                maxZoom: 12
            });

            const salesInEok = Math.round(sales / 100000000);
            const uniqueAccounts = [...new Set(accounts)];
            const popup = L.popup()
                .setLatLng([detailedInfo.lat, detailedInfo.lng])
                .setContent(`
                    <div style="text-align: center; padding: 12px;">
                        <div style="font-weight: bold; font-size: 1.1rem; color: #7c3aed;">${detailedInfo.name}</div>
                        <div style="margin: 8px 0; color: #ef4444; font-size: 1rem;">ë§¤ì¶œ: ${salesInEok.toLocaleString()}ì–µì›</div>
                        <div style="margin: 6px 0; color: #ffffff; font-size: 0.9rem;">ê±°ë˜ì²˜: ${uniqueAccounts.length}ê°œ</div>
                        <div style="margin: 8px 0; font-size: 0.8rem; color: #9ca3af;">
                            ${uniqueAccounts.slice(0, 2).join(', ')}${uniqueAccounts.length > 2 ? ` ì™¸ ${uniqueAccounts.length - 2}ê°œ` : ''}
                        </div>
                        <button onclick="resetMapView()" style="
                            background: #7c3aed; 
                            color: white; 
                            border: none; 
                            padding: 6px 12px; 
                            border-radius: 6px; 
                            font-size: 0.8rem; 
                            cursor: pointer;
                            margin-top: 8px;
                        ">ì „ì²´ ì§€ë„ ë³´ê¸°</button>
                    </div>
                `)
                .openOn(salesMap);
        }

        // íŠ¹ì • ì§€ì—­ í™•ëŒ€ ë° ê°•ì¡°
        function highlightRegion(region, sales) {
            const regionInfo = regionData[region];
            if (!regionInfo) return;

            salesMap.flyToBounds(regionInfo.bounds, {
                paddingTopLeft: [20, 20],
                paddingBottomRight: [20, 20],
                duration: 1.5,
                maxZoom: 10
            });

            const salesInEok = Math.round(sales / 100000000);
            const popup = L.popup()
                .setLatLng([regionInfo.lat, regionInfo.lng])
                .setContent(`
                    <div style="text-align: center; padding: 10px;">
                        <div style="font-weight: bold; font-size: 1.1rem; color: #00d4ff;">${regionInfo.name}</div>
                        <div style="margin: 8px 0; color: #ef4444; font-size: 1rem;">ë§¤ì¶œ: ${salesInEok.toLocaleString()}ì–µì›</div>
                        <button onclick="resetMapView()" style="
                            background: #7c3aed; 
                            color: white; 
                            border: none; 
                            padding: 6px 12px; 
                            border-radius: 6px; 
                            font-size: 0.8rem; 
                            cursor: pointer;
                            margin-top: 8px;
                        ">ì „ì²´ ì§€ë„ ë³´ê¸°</button>
                    </div>
                `)
                .openOn(salesMap);
        }

        // ì§€ë„ ì „ì²´ ë³´ê¸° ë¦¬ì…‹
        function resetMapView() {
            salesMap.flyTo([36.5, 127.8], 7, {
                duration: 1.5
            });
            salesMap.closePopup();
        }

        // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
        function loadLibraries() {
            const checkLibraries = () => {
                if (typeof Chart !== 'undefined' && typeof Papa !== 'undefined' && typeof L !== 'undefined') {
                    librariesLoaded = true;
                    showStatus('ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    initializeMap(); // ì§€ë„ ì´ˆê¸°í™”
                } else {
                    setTimeout(checkLibraries, 100);
                }
            };
            checkLibraries();
        }

        // íŒŒì¼ ì²˜ë¦¬ ì„¤ì •
        function setupFileHandling() {
            const fileInput = document.getElementById('fileInput');
            const fileInputArea = document.getElementById('fileInputArea');

            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
            fileInputArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileInputArea.classList.add('dragover');
            });

            fileInputArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                fileInputArea.classList.remove('dragover');
            });

            fileInputArea.addEventListener('drop', function(e) {
                e.preventDefault();
                fileInputArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
        }

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.classList.remove('hidden');
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(percentage) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${percentage}%`;
        }

        // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
        function showLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        // í—¬í¼ í•¨ìˆ˜ë“¤
        const groupBy = (array, key) => {
            return array.reduce((result, item) => {
                const group = typeof key === 'function' ? key(item) : item[key];
                (result[group] = result[group] || []).push(item);
                return result;
            }, {});
        };

        const sumBy = (array, key) => {
            return array.reduce((sum, item) => sum + (typeof key === 'function' ? key(item) : item[key]), 0);
        };

        const uniqBy = (array, key) => {
            const seen = new Set();
            return array.filter(item => {
                const val = typeof key === 'function' ? key(item) : item[key];
                if (seen.has(val)) {
                    return false;
                }
                seen.add(val);
                return true;
            });
        };

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleFileUpload(file) {
            if (!ensureLibrariesLoaded()) return;

            showStatus('íŒŒì¼ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            showLoading(true);
            updateProgress(20);

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    try {
                        if (results.errors.length > 0) {
                            console.warn('CSV íŒŒì‹± ê²½ê³ :', results.errors);
                        }

                        if (!results.data || results.data.length === 0) {
                            showStatus('íŒŒì¼ì— ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                            showLoading(false);
                            return;
                        }

                        salesData = results.data.filter(row => {
                            return Object.values(row).some(value => 
                                value !== null && value !== undefined && value !== ''
                            );
                        });

                        if (salesData.length === 0) {
                            showStatus('íŒŒì¼ì—ì„œ ìœ íš¨í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                            showLoading(false);
                            return;
                        }

                        preprocessData();
                        showStatus(`ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${salesData.length.toLocaleString()}ê°œ ë ˆì½”ë“œ`, 'success');
                        enableAnalysisButtons();
                        updateProgress(100);
                        showLoading(false);
                        
                        // ìë™ìœ¼ë¡œ ê¸°ë³¸ ë¶„ì„ ì‹¤í–‰
                        setTimeout(() => {
                            performBasicAnalysis();
                        }, 500);
                    } catch (error) {
                        console.error('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                        showStatus('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                        showLoading(false);
                    }
                },
                error: function(error) {
                    console.error('CSV íŒŒì‹± ì˜¤ë¥˜:', error);
                    showStatus('CSV íŒŒì¼ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    showLoading(false);
                }
            });
        }

        // ë°ëª¨ ë°ì´í„° ìƒì„± (ì›”ë³„ ì§‘ê³„ êµ¬ì¡°ë¡œ ê°œì„ )
        function generateDemoData() {
            if (!ensureLibrariesLoaded()) return;

            showStatus('ë°ëª¨ ë°ì´í„°ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            showLoading(true);
            updateProgress(30);

            try {
                const accounts = 50;
                const products = 20;
                const months = 24;

                const accountCodes = Array.from({length: accounts}, (_, i) => `A${String(i+1).padStart(3, '0')}`);
                const regions = ['ì„œìš¸', 'ê²½ê¸°', 'ì¸ì²œ', 'ë¶€ì‚°', 'ëŒ€êµ¬', 'ê´‘ì£¼', 'ëŒ€ì „', 'ìš¸ì‚°', 'ê°•ì›', 'ì¶©ë¶', 'ì¶©ë‚¨', 'ì „ë¶', 'ì „ë‚¨', 'ê²½ë¶', 'ê²½ë‚¨', 'ì œì£¼'];
                const regionSubAreas = {
                    'ì„œìš¸': ['ê°•ë‚¨', 'ê°•ë¶', 'ì†¡íŒŒ', 'ë§ˆí¬', 'ìš©ì‚°', 'ì¢…ë¡œ', 'ì„œì´ˆ', 'ê´€ì•…', 'ì˜ë“±í¬'],
                    'ê²½ê¸°': ['ìˆ˜ì›', 'ì„±ë‚¨', 'ê³ ì–‘', 'ìš©ì¸', 'ë¶€ì²œ', 'ì•ˆì‚°', 'ì•ˆì–‘', 'í™”ì„±', 'í‰íƒ'],
                    'ì¸ì²œ': ['ë¶€í‰', 'ë‚¨ë™', 'ê³„ì–‘', 'ì„œêµ¬', 'ì—°ìˆ˜'],
                    'ë¶€ì‚°': ['í•´ìš´ëŒ€', 'ì‚¬ìƒ', 'ë¶€ì‚°ì§„', 'ë™ë˜', 'ì‚¬í•˜'],
                    'ëŒ€êµ¬': ['ë‹¬ì„œ', 'ìˆ˜ì„±', 'ë¶êµ¬', 'ì¤‘êµ¬'],
                    'ê´‘ì£¼': ['ì„œêµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'ê´‘ì‚°'],
                    'ëŒ€ì „': ['ìœ ì„±', 'ì„œêµ¬', 'ì¤‘êµ¬', 'ë™êµ¬'],
                    'ìš¸ì‚°': ['ë‚¨êµ¬', 'ì¤‘êµ¬', 'ë™êµ¬', 'ë¶êµ¬'],
                    'ê°•ì›': ['ì¶˜ì²œ', 'ì›ì£¼', 'ê°•ë¦‰', 'ì†ì´ˆ'],
                    'ì¶©ë¶': ['ì²­ì£¼', 'ì¶©ì£¼', 'ì œì²œ'],
                    'ì¶©ë‚¨': ['ì²œì•ˆ', 'ì•„ì‚°', 'ì„œì‚°', 'ê³µì£¼'],
                    'ì „ë¶': ['ì „ì£¼', 'êµ°ì‚°', 'ìµì‚°'],
                    'ì „ë‚¨': ['ëª©í¬', 'ì—¬ìˆ˜', 'ìˆœì²œ'],
                    'ê²½ë¶': ['í¬í•­', 'ê²½ì£¼', 'êµ¬ë¯¸', 'ì•ˆë™'],
                    'ê²½ë‚¨': ['ì°½ì›', 'ì§„ì£¼', 'ê¹€í•´', 'ê±°ì œ'],
                    'ì œì£¼': ['ì œì£¼ì‹œ', 'ì„œê·€í¬']
                };
                
                // ì§€ì—­ ì •ë³´ê°€ í¬í•¨ëœ ê±°ë˜ì²˜ëª… ìƒì„±
                const accountNames = Array.from({length: accounts}, (_, i) => {
                    const region = regions[i % regions.length];
                    const subAreas = regionSubAreas[region];
                    const subArea = subAreas[Math.floor(Math.random() * subAreas.length)];
                    return `${subArea}${Math.random() > 0.5 ? 'ìƒì‚¬' : 'ê¸°ì—…'}${i+1}`;
                });
                const managers = ['ê¹€ë‹´ë‹¹', 'ì´ë‹´ë‹¹', 'ë°•ë‹´ë‹¹', 'ìµœë‹´ë‹¹', 'ì •ë‹´ë‹¹'];
                const productCodes = Array.from({length: products}, (_, i) => `P${String(i+1).padStart(3, '0')}`);
                const productNames = Array.from({length: products}, (_, i) => `í’ˆëª©êµ°${i+1}`);

                salesData = [];

                const now = new Date();
                const startDate = new Date(now.getFullYear(), now.getMonth() - months, 1);
                const monthsList = [];
                
                for (let i = 0; i < months; i++) {
                    const date = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
                    monthsList.push(date.getFullYear() * 100 + (date.getMonth() + 1));
                }

                // ê±°ë˜ì²˜ë³„ íŠ¹ì„± ë¯¸ë¦¬ ì •ì˜
                const accountProfiles = [];
                for (let i = 0; i < accounts; i++) {
                    const customerType = Math.random();
                    accountProfiles.push({
                        accountCode: accountCodes[i],
                        accountName: accountNames[i],
                        region: regions[Math.floor(Math.random() * regions.length)],
                        manager: managers[Math.floor(Math.random() * managers.length)],
                        // ê±°ë˜ì²˜ë³„ íŠ¹ì„±
                        productCount: customerType > 0.8 ? Math.floor(Math.random() * 8) + 5 : Math.floor(Math.random() * 5) + 1,
                        monthlyActivityRate: customerType > 0.7 ? 0.8 : customerType > 0.4 ? 0.6 : 0.3, // ì›”ë³„ í™œë™ í™•ë¥ 
                        salesTier: customerType > 0.8 ? 'high' : customerType > 0.5 ? 'medium' : 'low', // ë§¤ì¶œ ë“±ê¸‰
                        preferredProducts: [] // ì„ í˜¸ í’ˆëª©ë“¤
                    });
                }

                // ê° ê±°ë˜ì²˜ì˜ ì„ í˜¸ í’ˆëª© í• ë‹¹
                accountProfiles.forEach(profile => {
                    const availableProducts = Array.from({length: products}, (_, i) => i);
                    for (let j = 0; j < profile.productCount; j++) {
                        if (availableProducts.length === 0) break;
                        const randomIndex = Math.floor(Math.random() * availableProducts.length);
                        profile.preferredProducts.push(availableProducts.splice(randomIndex, 1)[0]);
                    }
                });

                // ì›”ë³„ ì§‘ê³„ ë°ì´í„° ìƒì„± (ê±°ë˜ì²˜ + í’ˆëª© + ì›” ë‹¨ìœ„)
                let recordCount = 0;
                accountProfiles.forEach((profile, accountIndex) => {
                    updateProgress(30 + (accountIndex / accounts) * 50);

                    monthsList.forEach(month => {
                        // í•´ë‹¹ ì›”ì— ê±°ë˜ê°€ ìˆëŠ”ì§€ í™•ë¥ ì ìœ¼ë¡œ ê²°ì •
                        if (Math.random() < profile.monthlyActivityRate) {
                            
                            // ì´ ì›”ì— êµ¬ë§¤í•  í’ˆëª©ë“¤ ê²°ì • (ì„ í˜¸ í’ˆëª© ì¤‘ ì¼ë¶€)
                            const monthlyProducts = profile.preferredProducts.filter(() => Math.random() < 0.7);
                            
                            monthlyProducts.forEach(productIdx => {
                                const productCode = productCodes[productIdx];
                                const productName = productNames[productIdx];

                                // í’ˆëª©ë³„ ê¸°ë³¸ ë‹¨ê°€ ì„¤ì • (í’ˆëª©êµ°ë§ˆë‹¤ ë‹¤ë¥¸ ê°€ê²©ëŒ€)
                                const baseUnitPrice = 20000 + (productIdx * 2000) + Math.floor(Math.random() * 10000);
                                
                                // ê±°ë˜ì²˜ ë“±ê¸‰ë³„ ìˆ˜ëŸ‰ ë° ë§¤ì¶œ ë°°ìˆ˜
                                let qtyMultiplier, salesMultiplier;
                                switch(profile.salesTier) {
                                    case 'high':
                                        qtyMultiplier = 2.5 + Math.random() * 2;
                                        salesMultiplier = 2.8 + Math.random() * 1.2;
                                        break;
                                    case 'medium':
                                        qtyMultiplier = 1.2 + Math.random() * 1;
                                        salesMultiplier = 1.3 + Math.random() * 0.7;
                                        break;
                                    default: // low
                                        qtyMultiplier = 0.5 + Math.random() * 0.8;
                                        salesMultiplier = 0.6 + Math.random() * 0.6;
                                }

                                // ì›”ë³„ ì§‘ê³„ëœ ìˆ˜ëŸ‰ ë° ë§¤ì¶œ ê³„ì‚°
                                const baseMonthlyQty = Math.floor((50 + Math.random() * 150) * qtyMultiplier);
                                const inQtyMr = Math.floor(baseMonthlyQty * (0.4 + Math.random() * 0.3));
                                const outQtyMr = baseMonthlyQty - inQtyMr;
                                const totalQty = inQtyMr + outQtyMr;

                                // ì‹¤ì œ ë‹¨ê°€ëŠ” ê¸°ë³¸ ë‹¨ê°€ì— ë³€ë™ ì ìš©
                                const actualUnitPrice = Math.floor(baseUnitPrice * salesMultiplier);
                                
                                const inSales = Math.floor(inQtyMr * actualUnitPrice);
                                const outSales = Math.floor(outQtyMr * actualUnitPrice);
                                const totalSales = inSales + outSales;

                                // í• ì¸ìœ¨ ì ìš© (Net ë§¤ì¶œ)
                                const inDiscount = 0.03 + Math.random() * 0.04; // 3-7%
                                const outDiscount = 0.05 + Math.random() * 0.05; // 5-10%

                                if (totalQty > 0 && totalSales > 0) {
                                    salesData.push({
                                        'ê¸°ì¤€ë…„ì›”': month,
                                        'ê±°ë˜ì²˜ì½”ë“œ': profile.accountCode,
                                        'ê±°ë˜ì²˜ëª…': profile.accountName,
                                        'ê¶Œì—­': profile.region,
                                        'ë‹´ë‹¹ì': profile.manager,
                                        'í’ˆëª©êµ°ì½”ë“œ': productCode,
                                        'í’ˆëª©êµ°': productName,
                                        'ì›ë‚´ìˆ˜ëŸ‰(MR)': inQtyMr,
                                        'ì›ë‚´ìˆ˜ëŸ‰(ê¸°íš)': 0,
                                        'ì›ë‚´ë§¤ì¶œ': inSales,
                                        'ì›ë‚´ë§¤ì¶œ(Net)': Math.floor(inSales * (1 - inDiscount)),
                                        'ì›ë‚´í• ì¸ìœ¨': inDiscount,
                                        'ì›ì™¸ìˆ˜ëŸ‰(MR)': outQtyMr,
                                        'ì›ì™¸ìˆ˜ëŸ‰(ê¸°íš)': 0,
                                        'ì›ì™¸ë§¤ì¶œ': outSales,
                                        'ì›ì™¸ë§¤ì¶œ(Net)': Math.floor(outSales * (1 - outDiscount)),
                                        'ì›ì™¸í• ì¸ìœ¨': outDiscount,
                                        'ì´ìˆ˜ëŸ‰': totalQty,
                                        'ì´ë§¤ì¶œ': totalSales
                                    });
                                    recordCount++;
                                }
                            });
                        }
                    });
                });

                updateProgress(80);
                preprocessData();
                showStatus(`ì›”ë³„ ì§‘ê³„ ë°ëª¨ ë°ì´í„° ìƒì„± ì™„ë£Œ: ${salesData.length.toLocaleString()}ê°œ ë ˆì½”ë“œ (${accounts}ê°œ ê±°ë˜ì²˜, ${products}ê°œ í’ˆëª©êµ°, ${months}ê°œì›”)`, 'success');
                enableAnalysisButtons();
                updateProgress(100);
                showLoading(false);
                
                // ìë™ìœ¼ë¡œ ê¸°ë³¸ ë¶„ì„ ì‹¤í–‰
                setTimeout(() => {
                    performBasicAnalysis();
                }, 500);
            } catch (error) {
                console.error('ë°ëª¨ ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                showStatus('ë°ëª¨ ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                showLoading(false);
            }
        }

        // ë°ì´í„° ì „ì²˜ë¦¬
        function preprocessData() {
            salesData.forEach(row => {
                const yearMonth = String(row['ê¸°ì¤€ë…„ì›”']);
                const year = parseInt(yearMonth.substring(0, 4));
                const month = parseInt(yearMonth.substring(4, 6));
                row['ê¸°ì¤€ë…„ì›”_dt'] = new Date(year, month - 1, 1);
            });

            const numericColumns = ['ì›ë‚´ìˆ˜ëŸ‰(MR)', 'ì›ë‚´ìˆ˜ëŸ‰(ê¸°íš)', 'ì›ë‚´ë§¤ì¶œ', 'ì›ë‚´ë§¤ì¶œ(Net)', 
                                   'ì›ì™¸ìˆ˜ëŸ‰(MR)', 'ì›ì™¸ìˆ˜ëŸ‰(ê¸°íš)', 'ì›ì™¸ë§¤ì¶œ', 'ì›ì™¸ë§¤ì¶œ(Net)', 
                                   'ì›ë‚´í• ì¸ìœ¨', 'ì›ì™¸í• ì¸ìœ¨', 'ì´ìˆ˜ëŸ‰', 'ì´ë§¤ì¶œ'];
            
            salesData.forEach(row => {
                numericColumns.forEach(col => {
                    if (row[col] === null || row[col] === undefined || isNaN(row[col])) {
                        row[col] = 0;
                    }
                });
            });

            // ìµœê·¼ ì›” ë°ì´í„° ê³„ì‚°
            const monthlyData = groupBy(salesData, 'ê¸°ì¤€ë…„ì›”');
            const sortedMonths = Object.keys(monthlyData).map(Number).sort((a, b) => b - a);
            const recentMonth = sortedMonths[0];
            const recentMonthData = monthlyData[recentMonth] || [];
            const recentMonthSales = sumBy(recentMonthData, 'ì´ë§¤ì¶œ');

            processedData = {
                totalRecords: salesData.length,
                dateRange: {
                    start: salesData.reduce((min, row) => row['ê¸°ì¤€ë…„ì›”_dt'] < min ? row['ê¸°ì¤€ë…„ì›”_dt'] : min, salesData[0]['ê¸°ì¤€ë…„ì›”_dt']),
                    end: salesData.reduce((max, row) => row['ê¸°ì¤€ë…„ì›”_dt'] > max ? row['ê¸°ì¤€ë…„ì›”_dt'] : max, salesData[0]['ê¸°ì¤€ë…„ì›”_dt'])
                },
                uniqueAccounts: uniqBy(salesData, 'ê±°ë˜ì²˜ì½”ë“œ').length,
                uniqueProducts: uniqBy(salesData, 'í’ˆëª©êµ°').length,
                totalSales: sumBy(salesData, 'ì´ë§¤ì¶œ'), // ì „ì²´ ê¸°ê°„ ì´ë§¤ì¶œ (ì°¸ê³ ìš©)
                recentMonth: recentMonth,
                recentMonthSales: recentMonthSales, // ìµœê·¼ ì›” ë§¤ì¶œ
                recentMonthAccounts: uniqBy(recentMonthData, 'ê±°ë˜ì²˜ì½”ë“œ').length, // ìµœê·¼ ì›” í™œì„± ê±°ë˜ì²˜
                recentMonthProducts: uniqBy(recentMonthData, 'í’ˆëª©êµ°').length // ìµœê·¼ ì›” ê±°ë˜ í’ˆëª©
            };

            // ì§€ë„ ì—…ë°ì´íŠ¸
            setTimeout(() => {
                if (salesMap) {
                    updateRegionalMap();
                }
            }, 100);
        }

        // ë¶„ì„ ë²„íŠ¼ í™œì„±í™”
        function enableAnalysisButtons() {
            document.getElementById('basicAnalysisBtn').disabled = false;
            document.getElementById('segmentationBtn').disabled = false;
            document.getElementById('recommendationBtn').disabled = false;
            document.getElementById('exportBtn').disabled = false;
        }

        // ê¸°ë³¸ ë¶„ì„ ìˆ˜í–‰
        function performBasicAnalysis() {
            if (!ensureLibrariesLoaded()) return;
            
            showStatus('ê¸°ë³¸ ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            showLoading(true);
            updateProgress(0);

            try {
                // ì›”ë³„ ë§¤ì¶œ ì¶”ì´ (ê°œì„ ëœ ì›”ë³„ ì§‘ê³„ ë¶„ì„)
                const monthlyData = groupBy(salesData, row => row['ê¸°ì¤€ë…„ì›”']);
                const monthlySales = Object.entries(monthlyData)
                    .map(([month, data]) => {
                        const totalSales = sumBy(data, 'ì´ë§¤ì¶œ');
                        const recordCount = data.length; // ì›”ë³„ ê±°ë˜ ë ˆì½”ë“œ ìˆ˜ (ê±°ë˜ì²˜-í’ˆëª© ì¡°í•© ìˆ˜)
                        const uniqueAccounts = uniqBy(data, 'ê±°ë˜ì²˜ì½”ë“œ').length;
                        const uniqueProducts = uniqBy(data, 'í’ˆëª©êµ°').length;
                        return [month, totalSales, recordCount, uniqueAccounts, uniqueProducts];
                    })
                    .sort((a, b) => a[0] - b[0]);

                updateProgress(25);

                // í’ˆëª©ë³„ ë¶„ì„ (ìµœê·¼ ì›” ê¸°ì¤€)
                const recentMonthData = salesData.filter(row => row['ê¸°ì¤€ë…„ì›”'] === processedData.recentMonth);
                const productData = groupBy(recentMonthData, 'í’ˆëª©êµ°');
                const productAnalysis = Object.entries(productData)
                    .map(([product, data]) => ({
                        product,
                        recentMonthSales: sumBy(data, 'ì´ë§¤ì¶œ'), // ìµœê·¼ ì›” ë§¤ì¶œ
                        recentMonthQty: sumBy(data, 'ì´ìˆ˜ëŸ‰'), // ìµœê·¼ ì›” ìˆ˜ëŸ‰
                        accountCount: uniqBy(data, 'ê±°ë˜ì²˜ì½”ë“œ').length, // ìµœê·¼ ì›” ê±°ë˜ì²˜ ìˆ˜
                        avgPrice: sumBy(data, 'ì´ë§¤ì¶œ') / sumBy(data, 'ì´ìˆ˜ëŸ‰') // ìµœê·¼ ì›” í‰ê·  ë‹¨ê°€
                    }))
                    .sort((a, b) => b.recentMonthSales - a.recentMonthSales);

                updateProgress(50);

                // ê¶Œì—­ë³„ ë¶„ì„
                const regionData = groupBy(salesData, 'ê¶Œì—­');
                const regionalAnalysis = Object.entries(regionData)
                    .map(([region, data]) => {
                        const accountCount = uniqBy(data, 'ê±°ë˜ì²˜ì½”ë“œ').length;
                        const managerCount = uniqBy(data, 'ë‹´ë‹¹ì').length;
                        const totalSales = sumBy(data, 'ì´ë§¤ì¶œ');
                        return {
                            region,
                            totalSales,
                            accountCount,
                            managerCount,
                            salesPerAccount: totalSales / accountCount,
                            salesPerManager: totalSales / managerCount
                        };
                    })
                    .sort((a, b) => b.totalSales - a.totalSales);

                updateProgress(75);

                // ë‹´ë‹¹ìë³„ ë¶„ì„ (ìµœê·¼ ì›” ê¸°ì¤€)
                const managerData = groupBy(recentMonthData, 'ë‹´ë‹¹ì');
                const managerAnalysis = Object.entries(managerData)
                    .map(([manager, data]) => {
                        const accountCount = uniqBy(data, 'ê±°ë˜ì²˜ì½”ë“œ').length;
                        const productCount = uniqBy(data, 'í’ˆëª©êµ°').length;
                        const recentMonthSales = sumBy(data, 'ì´ë§¤ì¶œ');
                        return {
                            manager,
                            recentMonthSales,
                            accountCount,
                            productCount
                        };
                    })
                    .sort((a, b) => b.recentMonthSales - a.recentMonthSales);

                analysisResults.basic = {
                    monthlySales,
                    productAnalysis,
                    regionalAnalysis,
                    managerAnalysis
                };

                updateProgress(100);
                displayBasicAnalysis();
                showStatus('ê¸°ë³¸ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                showLoading(false);
            } catch (error) {
                console.error('ê¸°ë³¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
                showStatus('ê¸°ë³¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // ê¸°ë³¸ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function displayBasicAnalysis() {
            const analysisGrid = document.getElementById('analysisGrid');
            analysisGrid.innerHTML = '';

            // ê¸°ë³¸ í†µê³„ ì¹´ë“œ + ì›”ë³„ ë§¤ì¶œ ì°¨íŠ¸
            const avgMonthlySales = processedData.totalSales / analysisResults.basic.monthlySales.length;
            const avgMonthlyRecords = processedData.totalRecords / analysisResults.basic.monthlySales.length;
            const recentMonthFormatted = processedData.recentMonth ? `${Math.floor(processedData.recentMonth / 100)}ë…„ ${processedData.recentMonth % 100}ì›”` : '';
            
            const basicStatsCard = document.createElement('div');
            basicStatsCard.className = 'analysis-card';
            basicStatsCard.innerHTML = `
                <h3>ğŸ“Š í•µì‹¬ ì§€í‘œ (${recentMonthFormatted} ê¸°ì¤€)</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${processedData.recentMonthAccounts.toLocaleString()}</div>
                        <div class="stat-label">ìµœê·¼ì›” í™œì„± ê±°ë˜ì²˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${processedData.recentMonthProducts.toLocaleString()}</div>
                        <div class="stat-label">ìµœê·¼ì›” ê±°ë˜ í’ˆëª©êµ°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${Math.round(processedData.recentMonthSales / 100000000).toLocaleString()}</div>
                        <div class="stat-label">ìµœê·¼ì›” ë§¤ì¶œ (ì–µì›)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${processedData.totalRecords.toLocaleString()}</div>
                        <div class="stat-label">ì „ì²´ ê±°ë˜ ì§‘ê³„ ìˆ˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${Math.round(avgMonthlySales / 100000000 * 10) / 10}</div>
                        <div class="stat-label">ì›”í‰ê·  ë§¤ì¶œ (ì–µì›)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${processedData.uniqueAccounts.toLocaleString()}</div>
                        <div class="stat-label">ì „ì²´ ê±°ë˜ì²˜ ìˆ˜</div>
                    </div>
                </div>
                
                <hr style="margin: 30px 0; border: none; border-top: 1px solid rgba(75, 85, 99, 0.3);">
                
                <h4 style="margin-bottom: 15px; color: #ffffff; font-size: 1.1rem;">ğŸ“ˆ ì›”ë³„ ë§¤ì¶œ ë° ê±°ë˜ í™œë™ ì¶”ì´</h4>
                <p style="margin-bottom: 15px; color: #9ca3af; font-size: 0.9rem;">
                    ì›”ë³„ ì§‘ê³„ëœ ë§¤ì¶œì•¡ê³¼ ê±°ë˜ì²˜-í’ˆëª© ì¡°í•© ìˆ˜ì˜ ë³€í™”ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
                </p>
                <div class="chart-container">
                    <canvas id="monthlySalesChart"></canvas>
                </div>
            `;
            analysisGrid.appendChild(basicStatsCard);



            // ìƒìœ„ í’ˆëª© í…Œì´ë¸” (ìµœê·¼ ì›” ê¸°ì¤€)
            const topProductsCard = document.createElement('div');
            topProductsCard.className = 'analysis-card';
            topProductsCard.innerHTML = `
                <h3>ğŸ† ìƒìœ„ í’ˆëª© ì„±ê³¼ (${recentMonthFormatted})</h3>
                <p style="margin-bottom: 15px; color: #9ca3af; font-size: 0.9rem;">
                    í’ˆëª©ëª…ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ í’ˆëª©ì„ êµ¬ë§¤í•˜ëŠ” ê±°ë˜ì²˜ ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>í’ˆëª©êµ°</th>
                                <th>ìµœê·¼ì›” ë§¤ì¶œì•¡</th>
                                <th>ê±°ë˜ì²˜ ìˆ˜</th>
                                <th>í‰ê· ë‹¨ê°€</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analysisResults.basic.productAnalysis.slice(0, 10).map((item, index) => `
                                <tr>
                                    <td><strong>${index + 1}</strong></td>
                                    <td><span class="clickable-product" onclick="showProductCustomers('${item.product}')" style="color: #00d4ff; cursor: pointer; text-decoration: underline;">${item.product}</span></td>
                                    <td><strong>${Math.round(item.recentMonthSales / 10000).toLocaleString()}</strong>ë§Œì›</td>
                                    <td>${item.accountCount}ê°œ</td>
                                    <td>${Math.round(item.avgPrice).toLocaleString()}ì›</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            analysisGrid.appendChild(topProductsCard);



            // ë‹´ë‹¹ìë³„ ì„±ê³¼ (ìµœê·¼ì›” ê¸°ì¤€)
            const managerRecentMonthFormatted = processedData.recentMonth ? `${Math.floor(processedData.recentMonth / 100)}ë…„ ${processedData.recentMonth % 100}ì›”` : '';
            const managerCard = document.createElement('div');
            managerCard.className = 'analysis-card';
            managerCard.innerHTML = `
                <h3>ğŸ‘¤ ë‹´ë‹¹ì ì‹¤ì  (${managerRecentMonthFormatted})</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ë‹´ë‹¹ì</th>
                                <th>ìµœê·¼ì›” ë§¤ì¶œ</th>
                                <th>ê±°ë˜ì²˜ ìˆ˜</th>
                                <th>ì·¨ê¸‰ í’ˆëª©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analysisResults.basic.managerAnalysis.map(item => `
                                <tr>
                                    <td><strong>${item.manager}</strong></td>
                                    <td>${Math.round(item.recentMonthSales / 10000).toLocaleString()}ë§Œì›</td>
                                    <td>${item.accountCount}ê°œ</td>
                                    <td>${item.productCount}ê°œ</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            analysisGrid.appendChild(managerCard);

            // ì°¨íŠ¸ ìƒì„±
            setTimeout(() => {
                createMonthlySalesChart();
            }, 100);
        }

        // í’ˆëª©ë³„ ì›”ë³„ ë§¤ì¶œ ì°¨íŠ¸ ìƒì„±
        function createProductMonthlySalesChart(monthlyProductSales, productName) {
            const ctx = document.getElementById('productMonthlySalesChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyProductSales.map(item => {
                        const yearMonth = item[0];
                        const year = yearMonth.toString().substring(0, 4);
                        const month = yearMonth.toString().substring(4, 6);
                        return `${year}-${month}`;
                    }),
                    datasets: [{
                        label: 'ì›”ë³„ ë§¤ì¶œ (ì–µì›)',
                        data: monthlyProductSales.map(item => item[1]),
                        borderColor: '#ff6b35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#ff6b35',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        yAxisID: 'y'
                    }, {
                        label: 'ì›”ë³„ ê±°ë˜ì§‘ê³„ ìˆ˜',
                        data: monthlyProductSales.map(item => item[2]), // recordCount
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        yAxisID: 'y1'
                    }, {
                        label: 'í™œì„± ê±°ë˜ì²˜ ìˆ˜',
                        data: monthlyProductSales.map(item => item[3]), // uniqueAccounts
                        borderColor: '#7c3aed',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: '#7c3aed',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#d1d5db',
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#d1d5db',
                            borderColor: 'rgba(75, 85, 99, 0.5)',
                            borderWidth: 1,
                            callbacks: {
                                afterBody: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    const monthData = monthlyProductSales[dataIndex];
                                    return [
                                        `ì´ ìˆ˜ëŸ‰: ${monthData[4].toLocaleString()}ê°œ`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)',
                                borderColor: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)',
                                borderColor: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return Math.round(value / 100000000 * 10) / 10 + 'ì–µì›';
                                }
                            },
                            title: {
                                display: true,
                                text: 'ë§¤ì¶œì•¡ (ì–µì›)',
                                color: '#ff6b35'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                color: '#9ca3af'
                            },
                            title: {
                                display: true,
                                text: 'ê±°ë˜ì§‘ê³„/ê±°ë˜ì²˜ ìˆ˜',
                                color: '#10b981'
                            }
                        }
                    }
                }
            });
        }

        // ì›”ë³„ ë§¤ì¶œ ì°¨íŠ¸ ìƒì„± (ê°œì„ ëœ ì›”ë³„ ì§‘ê³„ ì •ë³´ í¬í•¨)
        function createMonthlySalesChart() {
            const ctx = document.getElementById('monthlySalesChart').getContext('2d');
            const data = analysisResults.basic.monthlySales;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => {
                        const yearMonth = item[0];
                        const year = yearMonth.toString().substring(0, 4);
                        const month = yearMonth.toString().substring(4, 6);
                        return `${year}-${month}`;
                    }),
                    datasets: [{
                        label: 'ì›”ë³„ ë§¤ì¶œ (ì–µì›)',
                        data: data.map(item => item[1]),
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#00d4ff',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        yAxisID: 'y'
                    }, {
                        label: 'ì›”ë³„ ê±°ë˜ì§‘ê³„ ìˆ˜',
                        data: data.map(item => item[2]), // recordCount
                        borderColor: '#7c3aed',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: '#7c3aed',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#d1d5db',
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#d1d5db',
                            borderColor: 'rgba(75, 85, 99, 0.5)',
                            borderWidth: 1,
                            callbacks: {
                                afterBody: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    const monthData = data[dataIndex];
                                    return [
                                        `í™œì„± ê±°ë˜ì²˜: ${monthData[3]}ê°œ`,
                                        `ê±°ë˜ í’ˆëª©êµ°: ${monthData[4]}ê°œ`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)',
                                borderColor: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)',
                                borderColor: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return Math.round(value / 100000000 * 10) / 10 + 'ì–µì›';
                                }
                            },
                            title: {
                                display: true,
                                text: 'ë§¤ì¶œì•¡ (ì–µì›)',
                                color: '#00d4ff'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                color: '#9ca3af'
                            },
                            title: {
                                display: true,
                                text: 'ê±°ë˜ì§‘ê³„ ìˆ˜',
                                color: '#7c3aed'
                            }
                        }
                    }
                }
            });
        }



        // BCG Matrix ì„¸ë¶„í™” ê¸°ì¤€ ì„¤ì •
        const bcgMatrixCriteria = {
            star: {
                minRecentSales: 50000000,    // 5ì²œë§Œì›
                minGrowth3Month: 0           // 3ê°œì›” ëŒ€ë¹„ ì„±ì¥ ì–‘ìˆ˜
            },
            cashCow: {
                minRecentSales: 20000000,    // 2ì²œë§Œì›
                minGrowthYearAgo: 0,         // ì‘ë…„ ë™ì›” ëŒ€ë¹„ ì„±ì¥ ì–‘ìˆ˜
                minGrowth3Month: -5000000    // 3ê°œì›” ëŒ€ë¹„ ì•ˆì •ì (-500ë§Œì› ì´ìƒ)
            },
            questionMark: {
                growthRate3Month: 0.2,       // 3ê°œì›” ëŒ€ë¹„ 20% ì„±ì¥
                growthRateYearAgo: 0.2       // ì‘ë…„ ë™ì›” ëŒ€ë¹„ 20% ì„±ì¥
            },
            dog: {
                maxRecentSales: 5000000,     // 500ë§Œì› ë¯¸ë§Œ
                maxGrowth3Month: -10000000,  // 3ê°œì›” ëŒ€ë¹„ -1ì²œë§Œì› ì´í•˜
                maxGrowthYearAgo: -5000000   // ì‘ë…„ ë™ì›” ëŒ€ë¹„ -500ë§Œì› ì´í•˜
            }
        };

        // ê¸°ë³¸ ë§¤ì¶œì•¡ ê¸°ì¤€ ì„¸ë¶„í™” í•¨ìˆ˜
        function applySalesBasedSegmentation(customerMetrics) {
            customerMetrics.forEach(customer => {
                const recentSales = customer.recentMonthSales;
                
                if (recentSales >= 10000000) {
                    customer.salesSegment = 'premium';
                    customer.salesSegmentName = '1,000ë§Œì› ì´ìƒ';
                } else if (recentSales >= 5000000) {
                    customer.salesSegment = 'high';
                    customer.salesSegmentName = '500~1,000ë§Œì›';
                } else if (recentSales >= 1000000) {
                    customer.salesSegment = 'medium';
                    customer.salesSegmentName = '100~500ë§Œì›';
                } else {
                    customer.salesSegment = 'low';
                    customer.salesSegmentName = '100ë§Œì› ë¯¸ë§Œ';
                }
            });
        }

        // BCG Matrix ì„¸ë¶„í™” ë¡œì§ í•¨ìˆ˜
        function applyBCGSegmentation(customerMetrics) {
            customerMetrics.forEach(customer => {
                const recentSales = customer.recentMonthSales;
                const growth3Month = customer.growthVs3Month;
                const growthYearAgo = customer.growthVsYearAgo;
                
                // Star (ë†’ì€ ì„±ì¥, ë†’ì€ ë§¤ì¶œ)
                if (recentSales >= bcgMatrixCriteria.star.minRecentSales && 
                    growth3Month >= bcgMatrixCriteria.star.minGrowth3Month) {
                    customer.bcgSegment = 'star';
                    customer.bcgSegmentName = 'Star (ìŠ¤íƒ€)';
                }
                // Cash Cow (ì•ˆì •ì  ì„±ì¥, ë†’ì€ ë§¤ì¶œ)
                else if (recentSales >= bcgMatrixCriteria.cashCow.minRecentSales && 
                         growthYearAgo >= bcgMatrixCriteria.cashCow.minGrowthYearAgo && 
                         growth3Month >= bcgMatrixCriteria.cashCow.minGrowth3Month) {
                    customer.bcgSegment = 'cash-cow';
                    customer.bcgSegmentName = 'Cash Cow (ê¸ˆê³ )';
                }
                // Question Mark (ë†’ì€ ì„±ì¥ ì ì¬ë ¥, ë‚®ì€ í˜„ì¬ ë§¤ì¶œ)
                else if ((growth3Month > recentSales * bcgMatrixCriteria.questionMark.growthRate3Month) || 
                         (growthYearAgo > recentSales * bcgMatrixCriteria.questionMark.growthRateYearAgo)) {
                    customer.bcgSegment = 'question-mark';
                    customer.bcgSegmentName = 'Question Mark (ë¬¼ìŒí‘œ)';
                }
                // Dog (ë‚®ì€ ì„±ì¥, ë‚®ì€ ë§¤ì¶œ)
                else if (recentSales < bcgMatrixCriteria.dog.maxRecentSales || 
                         (growth3Month < bcgMatrixCriteria.dog.maxGrowth3Month && 
                          growthYearAgo < bcgMatrixCriteria.dog.maxGrowthYearAgo)) {
                    customer.bcgSegment = 'dog';
                    customer.bcgSegmentName = 'Dog (ê°œ)';
                }
                // ê¸°ë³¸ (ë¶„ë¥˜ë˜ì§€ ì•Šì€ ê³ ê°)
                else {
                    customer.bcgSegment = 'basic';
                    customer.bcgSegmentName = 'Basic (ê¸°ë³¸)';
                }
            });
        }

        // ì‹¤ì‹œê°„ ì„¸ë¶„í™” ì—…ë°ì´íŠ¸
        function updateBCGSegmentationRealtime() {
            if (!analysisResults.segmentation || !analysisResults.segmentation.customerMetrics) {
                return;
            }

            // BCG ì„¸ë¶„í™” ì¬ì ìš©
            applyBCGSegmentation(analysisResults.segmentation.customerMetrics);

            // BCG ì„¸ê·¸ë¨¼íŠ¸ë³„ í†µê³„ ì¬ê³„ì‚°
            const bcgSegmentStats = {};
            ['star', 'cash-cow', 'question-mark', 'dog', 'basic'].forEach(segment => {
                const segmentCustomers = analysisResults.segmentation.customerMetrics.filter(c => c.bcgSegment === segment);
                bcgSegmentStats[segment] = {
                    count: segmentCustomers.length,
                    totalRecentMonthSales: sumBy(segmentCustomers, 'recentMonthSales'),
                    avgRecentMonthSales: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'recentMonthSales') / segmentCustomers.length : 0,
                    avgGrowth3Month: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'growthVs3Month') / segmentCustomers.length : 0,
                    avgGrowthYearAgo: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'growthVsYearAgo') / segmentCustomers.length : 0,
                    customers: segmentCustomers
                };
            });

            analysisResults.segmentation.bcgSegmentStats = bcgSegmentStats;

            // í™”ë©´ ì—…ë°ì´íŠ¸
            displaySegmentationAnalysis();
        }

        // ê³ ê° ì„¸ë¶„í™” ë¶„ì„
        function performCustomerSegmentation() {
            if (!ensureLibrariesLoaded()) return;
            
            showStatus('ê³ ê° ì„¸ë¶„í™” ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            showLoading(true);
            updateProgress(0);

            try {
                // ê±°ë˜ì²˜ë³„ ì§€í‘œ ê³„ì‚° (ê°œì„ ëœ ì„¸ë¶„í™” ê¸°ì¤€)
                const accountData = groupBy(salesData, 'ê±°ë˜ì²˜ì½”ë“œ');
                const customerMetrics = Object.entries(accountData).map(([accountCode, data]) => {
                    const totalSales = sumBy(data, 'ì´ë§¤ì¶œ');
                    const uniqueProducts = uniqBy(data, 'í’ˆëª©êµ°').length;
                    
                    // ì›”ë³„ ë°ì´í„° ì •ë ¬ (ìµœì‹ ìˆœ)
                    const monthlyData = groupBy(data, 'ê¸°ì¤€ë…„ì›”');
                    const sortedMonths = Object.keys(monthlyData).map(Number).sort((a, b) => b - a);
                    
                    // 1. ê°€ì¥ ìµœê·¼ ì›”ì˜ ë§¤ì¶œ
                    const recentMonth = sortedMonths[0];
                    const recentMonthSales = recentMonth ? sumBy(monthlyData[recentMonth], 'ì´ë§¤ì¶œ') : 0;
                    
                    // 2. ìµœê·¼ ì›”ì„ ì œì™¸í•œ ë§ˆì§€ë§‰ 3ê°œì›” í‰ê·  ë§¤ì¶œ
                    const last3MonthsExcludingRecent = sortedMonths.slice(1, 4);
                    const avg3MonthSales = last3MonthsExcludingRecent.length > 0 
                        ? last3MonthsExcludingRecent.reduce((sum, month) => sum + sumBy(monthlyData[month] || [], 'ì´ë§¤ì¶œ'), 0) / last3MonthsExcludingRecent.length 
                        : 0;
                    const growthVs3Month = recentMonthSales - avg3MonthSales;
                    
                    // 3. ì‘ë…„ ë™ì›” ëŒ€ë¹„ ì„±ì¥ê¸ˆì•¡
                    const recentYear = Math.floor(recentMonth / 100);
                    const recentMonthNum = recentMonth % 100;
                    const lastYearSameMonth = (recentYear - 1) * 100 + recentMonthNum;
                    const lastYearSameMonthSales = monthlyData[lastYearSameMonth] ? sumBy(monthlyData[lastYearSameMonth], 'ì´ë§¤ì¶œ') : 0;
                    const growthVsYearAgo = recentMonthSales - lastYearSameMonthSales;

                    return {
                        accountCode,
                        accountName: data[0]['ê±°ë˜ì²˜ëª…'],
                        region: data[0]['ê¶Œì—­'],
                        manager: data[0]['ë‹´ë‹¹ì'],
                        totalSales,
                        uniqueProducts,
                        recentMonthSales,        // ê°€ì¥ ìµœê·¼ ì›” ë§¤ì¶œ
                        growthVs3Month,          // 3ê°œì›” í‰ê·  ëŒ€ë¹„ ì„±ì¥ê¸ˆì•¡
                        growthVsYearAgo,         // ì‘ë…„ ë™ì›” ëŒ€ë¹„ ì„±ì¥ê¸ˆì•¡
                        avgOrderValue: totalSales / sortedMonths.length
                    };
                });

                updateProgress(40);

                // ê¸°ë³¸ ë§¤ì¶œì•¡ ê¸°ì¤€ ì„¸ë¶„í™” ì ìš©
                applySalesBasedSegmentation(customerMetrics);
                
                // BCG Matrix ì„¸ë¶„í™” ì ìš©
                applyBCGSegmentation(customerMetrics);

                updateProgress(60);

                // ë§¤ì¶œì•¡ ê¸°ì¤€ ì„¸ê·¸ë¨¼íŠ¸ë³„ í†µê³„
                const salesSegmentStats = {};
                ['premium', 'high', 'medium', 'low'].forEach(segment => {
                    const segmentCustomers = customerMetrics.filter(c => c.salesSegment === segment);
                    salesSegmentStats[segment] = {
                        count: segmentCustomers.length,
                        totalRecentMonthSales: sumBy(segmentCustomers, 'recentMonthSales'),
                        avgRecentMonthSales: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'recentMonthSales') / segmentCustomers.length : 0,
                        avgGrowth3Month: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'growthVs3Month') / segmentCustomers.length : 0,
                        avgGrowthYearAgo: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'growthVsYearAgo') / segmentCustomers.length : 0,
                        customers: segmentCustomers
                    };
                });

                updateProgress(80);

                // BCG Matrix ì„¸ê·¸ë¨¼íŠ¸ë³„ í†µê³„
                const bcgSegmentStats = {};
                ['star', 'cash-cow', 'question-mark', 'dog', 'basic'].forEach(segment => {
                    const segmentCustomers = customerMetrics.filter(c => c.bcgSegment === segment);
                    bcgSegmentStats[segment] = {
                        count: segmentCustomers.length,
                        totalRecentMonthSales: sumBy(segmentCustomers, 'recentMonthSales'),
                        avgRecentMonthSales: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'recentMonthSales') / segmentCustomers.length : 0,
                        avgGrowth3Month: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'growthVs3Month') / segmentCustomers.length : 0,
                        avgGrowthYearAgo: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'growthVsYearAgo') / segmentCustomers.length : 0,
                        customers: segmentCustomers
                    };
                });

                analysisResults.segmentation = {
                    customerMetrics,
                    salesSegmentStats,
                    bcgSegmentStats
                };

                updateProgress(100);
                displaySegmentationAnalysis();
                showStatus('ê³ ê° ì„¸ë¶„í™” ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                showLoading(false);
            } catch (error) {
                console.error('ê³ ê° ì„¸ë¶„í™” ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
                showStatus('ê³ ê° ì„¸ë¶„í™” ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // ì„¸ë¶„í™” ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function displaySegmentationAnalysis() {
            const analysisGrid = document.getElementById('analysisGrid');
            analysisGrid.innerHTML = '';

            // 1. í†µí•© ì„¸ë¶„í™” ê°œìš” (ë§¤ì¶œ ê¸°ì¤€ + BCG Matrix)
            const combinedSegmentOverviewCard = document.createElement('div');
            combinedSegmentOverviewCard.className = 'analysis-card';
            combinedSegmentOverviewCard.innerHTML = `
                <h3>ğŸ’° ë§¤ì¶œì•¡ ê¸°ì¤€ ê³ ê° ì„¸ë¶„í™”</h3>
                <p style="margin-bottom: 15px; color: #9ca3af; font-size: 0.9rem;">
                    í´ë¦­í•˜ì—¬ í•´ë‹¹ ì„¸ê·¸ë¨¼íŠ¸ì˜ ê±°ë˜ì²˜ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”
                </p>
                <div class="stats-grid">
                    ${Object.entries(analysisResults.segmentation.salesSegmentStats).map(([segment, stats]) => `
                        <div class="stat-item segment-sales-${segment} clickable-segment" 
                             onclick="showSegmentDetails('sales', '${segment}')" 
                             style="cursor: pointer; transition: transform 0.2s ease;">
                            <div class="stat-value">${stats.count}</div>
                            <div class="stat-label">${getSalesSegmentName(segment)}</div>
                        </div>
                    `).join('')}
                </div>
                
                <hr style="margin: 30px 0; border: none; border-top: 1px solid rgba(75, 85, 99, 0.3);">
                
                <h3>ğŸ“Š BCG Matrix ê³ ê° ì„¸ë¶„í™”</h3>
                <p style="margin-bottom: 15px; color: #9ca3af; font-size: 0.9rem;">
                    ì„±ì¥ë¥ ê³¼ ë§¤ì¶œ ê·œëª¨ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•œ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ - í´ë¦­í•˜ì—¬ ì„¸ë¶€ ì •ë³´ í™•ì¸
                </p>
                <div class="stats-grid">
                    ${Object.entries(analysisResults.segmentation.bcgSegmentStats).map(([segment, stats]) => `
                        <div class="stat-item segment-bcg-${segment} clickable-segment" 
                             onclick="showSegmentDetails('bcg', '${segment}')" 
                             style="cursor: pointer; transition: transform 0.2s ease;">
                            <div class="stat-value">${stats.count}</div>
                            <div class="stat-label">${getBCGSegmentName(segment)}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            analysisGrid.appendChild(combinedSegmentOverviewCard);

            // 2. BCG Matrix ê¸°ì¤€ ì„¤ì • ì»¨íŠ¸ë¡¤ íŒ¨ë„
            const criteriaCard = document.createElement('div');
            criteriaCard.className = 'analysis-card';
            criteriaCard.innerHTML = `
                <h3>âš™ï¸ BCG Matrix ê¸°ì¤€ ì„¤ì •</h3>
                <p style="margin-bottom: 20px; color: #9ca3af; font-size: 0.9rem;">
                    ìŠ¬ë¼ì´ë”ë¥¼ ì¡°ì •í•˜ì—¬ BCG Matrix ì„¸ë¶„í™” ê¸°ì¤€ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    
                    <!-- Star ê¸°ì¤€ -->
                    <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #FFD700;">
                        <h4 style="color: #FFD700; margin-bottom: 15px;">â­ Star (ìŠ¤íƒ€)</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">ìµœê·¼ ì›” ìµœì†Œ ë§¤ì¶œ (ë§Œì›)</label>
                            <input type="range" id="starMinSales" min="1000" max="10000" step="500" value="${bcgMatrixCriteria.star.minRecentSales / 10000}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('star', 'minRecentSales', this.value * 10000)">
                            <span id="starMinSalesValue" style="font-size: 0.8rem; color: #9ca3af;">${(bcgMatrixCriteria.star.minRecentSales / 10000).toLocaleString()}ë§Œì›</span>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">3ê°œì›” ëŒ€ë¹„ ìµœì†Œ ì„±ì¥ (ë§Œì›)</label>
                            <input type="range" id="starMinGrowth" min="-1000" max="1000" step="100" value="${bcgMatrixCriteria.star.minGrowth3Month / 10000}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('star', 'minGrowth3Month', this.value * 10000)">
                            <span id="starMinGrowthValue" style="font-size: 0.8rem; color: #9ca3af;">${(bcgMatrixCriteria.star.minGrowth3Month / 10000).toLocaleString()}ë§Œì›</span>
                        </div>
                    </div>

                    <!-- Cash Cow ê¸°ì¤€ -->
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #22C55E;">
                        <h4 style="color: #22C55E; margin-bottom: 15px;">ğŸ„ Cash Cow (ê¸ˆê³ )</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">ìµœê·¼ ì›” ìµœì†Œ ë§¤ì¶œ (ë§Œì›)</label>
                            <input type="range" id="cashCowMinSales" min="500" max="5000" step="100" value="${bcgMatrixCriteria.cashCow.minRecentSales / 10000}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('cashCow', 'minRecentSales', this.value * 10000)">
                            <span id="cashCowMinSalesValue" style="font-size: 0.8rem; color: #9ca3af;">${(bcgMatrixCriteria.cashCow.minRecentSales / 10000).toLocaleString()}ë§Œì›</span>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">3ê°œì›” ëŒ€ë¹„ ìµœì†Œ ì„±ì¥ (ë§Œì›)</label>
                            <input type="range" id="cashCowMinGrowth3M" min="-1000" max="500" step="50" value="${bcgMatrixCriteria.cashCow.minGrowth3Month / 10000}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('cashCow', 'minGrowth3Month', this.value * 10000)">
                            <span id="cashCowMinGrowth3MValue" style="font-size: 0.8rem; color: #9ca3af;">${(bcgMatrixCriteria.cashCow.minGrowth3Month / 10000).toLocaleString()}ë§Œì›</span>
                        </div>
                    </div>

                    <!-- Question Mark ê¸°ì¤€ -->
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #f59e0b; margin-bottom: 15px;">â“ Question Mark (ë¬¼ìŒí‘œ)</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">3ê°œì›” ëŒ€ë¹„ ì„±ì¥ë¥  (%)</label>
                            <input type="range" id="questionMarkRate3M" min="5" max="50" step="5" value="${bcgMatrixCriteria.questionMark.growthRate3Month * 100}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('questionMark', 'growthRate3Month', this.value / 100)">
                            <span id="questionMarkRate3MValue" style="font-size: 0.8rem; color: #9ca3af;">${(bcgMatrixCriteria.questionMark.growthRate3Month * 100)}%</span>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">ì‘ë…„ ë™ì›” ëŒ€ë¹„ ì„±ì¥ë¥  (%)</label>
                            <input type="range" id="questionMarkRateYear" min="5" max="50" step="5" value="${bcgMatrixCriteria.questionMark.growthRateYearAgo * 100}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('questionMark', 'growthRateYearAgo', this.value / 100)">
                            <span id="questionMarkRateYearValue" style="font-size: 0.8rem; color: #9ca3af;">${(bcgMatrixCriteria.questionMark.growthRateYearAgo * 100)}%</span>
                        </div>
                    </div>

                    <!-- Dog ê¸°ì¤€ -->
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #ef4444;">
                        <h4 style="color: #ef4444; margin-bottom: 15px;">ğŸ• Dog (ê°œ)</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">ìµœê·¼ ì›” ìµœëŒ€ ë§¤ì¶œ (ë§Œì›)</label>
                            <input type="range" id="dogMaxSales" min="100" max="1000" step="50" value="${bcgMatrixCriteria.dog.maxRecentSales / 10000}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('dog', 'maxRecentSales', this.value * 10000)">
                            <span id="dogMaxSalesValue" style="font-size: 0.8rem; color: #9ca3af;">${(bcgMatrixCriteria.dog.maxRecentSales / 10000).toLocaleString()}ë§Œì›</span>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">3ê°œì›” ëŒ€ë¹„ ìµœëŒ€ ì„±ì¥ (ë§Œì›)</label>
                            <input type="range" id="dogMaxGrowth3M" min="-2000" max="-200" step="100" value="${bcgMatrixCriteria.dog.maxGrowth3Month / 10000}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('dog', 'maxGrowth3Month', this.value * 10000)">
                            <span id="dogMaxGrowth3MValue" style="font-size: 0.8rem; color: #9ca3af;">${(bcgMatrixCriteria.dog.maxGrowth3Month / 10000).toLocaleString()}ë§Œì›</span>
                        </div>
                    </div>
                </div>
            `;
            analysisGrid.appendChild(criteriaCard);
        }

        // ì¶”ì²œ ìƒì„±
        function generateRecommendations() {
            if (!analysisResults.basic || !analysisResults.segmentation) {
                showStatus('ê¸°ë³¸ ë¶„ì„ê³¼ ê³ ê° ì„¸ë¶„í™”ë¥¼ ë¨¼ì € ìˆ˜í–‰í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            showStatus('ê°œì¸í™”ëœ ì¶”ì²œì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            showLoading(true);
            updateProgress(0);

            try {
                const recommendations = [];

                // Premium/High ê³ ê° ëŒ€ìƒ ì‹ ì œí’ˆ ì¶”ì²œ
                const premiumCustomers = analysisResults.segmentation.salesSegmentStats['premium']?.customers || [];
                const highCustomers = analysisResults.segmentation.salesSegmentStats['high']?.customers || [];
                const highValueCustomers = [...premiumCustomers, ...highCustomers];

                if (highValueCustomers.length > 0) {
                    highValueCustomers.slice(0, 5).forEach(customer => {
                        // í•´ë‹¹ ê³ ê°ì´ êµ¬ë§¤í•˜ì§€ ì•Šì€ ì¸ê¸° ìƒí’ˆ ì°¾ê¸°
                        const customerProductData = salesData.filter(row => row['ê±°ë˜ì²˜ì½”ë“œ'] === customer.accountCode);
                        const customerProducts = uniqBy(customerProductData, 'í’ˆëª©êµ°').map(p => p['í’ˆëª©êµ°']);
                        const topProducts = analysisResults.basic.productAnalysis.slice(0, 10);
                        const recommendedProducts = topProducts.filter(p => !customerProducts.includes(p.product));

                        if (recommendedProducts.length > 0) {
                            recommendations.push({
                                type: 'product-recommendation',
                                customer: customer,
                                title: `${customer.accountName}ì—ê²Œ ${recommendedProducts[0].product} ì œì•ˆ`,
                                description: `ê³ ê°€ì¹˜ ê³ ê°ì¸ ${customer.accountName}ì—ê²Œ ì¸ê¸° ìƒí’ˆ ${recommendedProducts[0].product}ì„ ì œì•ˆí•˜ì„¸ìš”. ì´ ìƒí’ˆì€ í‰ê·  ${Math.round(recommendedProducts[0].avgPrice).toLocaleString()}ì›ì˜ ë‹¨ê°€ë¡œ ${recommendedProducts[0].accountCount}ê°œ ê±°ë˜ì²˜ì—ì„œ êµ¬ë§¤í•˜ê³  ìˆìŠµë‹ˆë‹¤.`,
                                expectedSales: Math.round(customer.recentMonthSales * 0.3),
                                priority: 'high'
                            });
                        }
                    });
                }

                updateProgress(30);

                // Dog ì„¸ê·¸ë¨¼íŠ¸ ê³ ê° ì¬ì°¸ì—¬ ì¶”ì²œ
                const dogCustomers = analysisResults.segmentation.bcgSegmentStats['dog']?.customers || [];
                if (dogCustomers.length > 0) {
                    dogCustomers.slice(0, 3).forEach(customer => {
                        recommendations.push({
                            type: 'retention',
                            customer: customer,
                            title: `${customer.accountName} ì¬ì°¸ì—¬ ìº í˜ì¸`,
                            description: `ë§¤ì¶œì´ ê°ì†Œí•˜ê³  ìˆëŠ” ${customer.accountName}ì—ê²Œ íŠ¹ë³„ í• ì¸ì´ë‚˜ ë§ì¶¤í˜• ìƒí’ˆì„ ì œì•ˆí•˜ì—¬ ì¬ì°¸ì—¬ë¥¼ ìœ ë„í•˜ì„¸ìš”. ìµœê·¼ 3ê°œì›” ì„±ì¥: ${Math.round(customer.growthVs3Month / 10000).toLocaleString()}ë§Œì›`,
                            expectedSales: Math.round(Math.abs(customer.growthVs3Month) * 0.5),
                            priority: 'high'
                        });
                    });
                }

                updateProgress(60);

                // Star ì„¸ê·¸ë¨¼íŠ¸ ê³ ê° ì—…ì…€ë§ ì¶”ì²œ
                const starCustomers = analysisResults.segmentation.bcgSegmentStats['star']?.customers || [];
                if (starCustomers.length > 0) {
                    starCustomers.slice(0, 3).forEach(customer => {
                        const growthPotential = customer.growthVs3Month > 0 ? customer.growthVs3Month : customer.recentMonthSales * 0.2;

                        recommendations.push({
                            type: 'upselling',
                            customer: customer,
                            title: `${customer.accountName} ë§¤ì¶œ í™•ëŒ€ ê¸°íšŒ`,
                            description: `ì„±ì¥ì„¸ê°€ ì¢‹ì€ Star ê³ ê° ${customer.accountName}ì˜ ë§¤ì¶œì„ ë”ìš± í™•ëŒ€í•  ê¸°íšŒì…ë‹ˆë‹¤. ì¶”ê°€ ìƒí’ˆ ì œì•ˆì´ë‚˜ ìˆ˜ëŸ‰ ì¦ëŒ€ë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”. í˜„ì¬ 3ê°œì›” ì„±ì¥ë¥ : +${Math.round(customer.growthVs3Month / 10000).toLocaleString()}ë§Œì›`,
                            expectedSales: Math.round(growthPotential * 0.5),
                            priority: 'medium'
                        });
                    });
                }

                updateProgress(80);

                // Question Mark ì„¸ê·¸ë¨¼íŠ¸ ì§‘ì¤‘ ê´€ë¦¬ ì¶”ì²œ
                const questionMarkCustomers = analysisResults.segmentation.bcgSegmentStats['question-mark']?.customers || [];
                if (questionMarkCustomers.length > 0) {
                    questionMarkCustomers.slice(0, 3).forEach(customer => {
                        recommendations.push({
                            type: 'focus-management',
                            customer: customer,
                            title: `${customer.accountName} ì§‘ì¤‘ ê´€ë¦¬ í•„ìš”`,
                            description: `Question Mark ê³ ê° ${customer.accountName}ì€ ì„±ì¥ ì ì¬ë ¥ì´ ìˆì§€ë§Œ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. ì •ê¸°ì ì¸ ì†Œí†µê³¼ ë§ì¶¤í˜• ì„œë¹„ìŠ¤ë¡œ Star ê³ ê°ìœ¼ë¡œ ì „í™˜ì„ ë„ëª¨í•˜ì„¸ìš”.`,
                            expectedSales: Math.round(customer.recentMonthSales * 0.4),
                            priority: 'medium'
                        });
                    });
                }

                updateProgress(90);

                // êµì°¨ íŒë§¤ ì¶”ì²œ (Cash Cow ê³ ê° ëŒ€ìƒ)
                const cashCowCustomers = analysisResults.segmentation.bcgSegmentStats['cash-cow']?.customers || [];
                const topProducts = analysisResults.basic.productAnalysis.slice(0, 5);
                
                if (cashCowCustomers.length > 0 && topProducts.length > 0) {
                    cashCowCustomers.slice(0, 2).forEach(customer => {
                        const customerProductData = salesData.filter(row => row['ê±°ë˜ì²˜ì½”ë“œ'] === customer.accountCode);
                        const customerProducts = uniqBy(customerProductData, 'í’ˆëª©êµ°').map(p => p['í’ˆëª©êµ°']);
                        const recommendedProducts = topProducts.filter(p => !customerProducts.includes(p.product));

                        if (recommendedProducts.length > 0) {
                            recommendations.push({
                                type: 'cross-selling',
                                customer: customer,
                                title: `${customer.accountName}ì—ê²Œ ${recommendedProducts[0].product} êµì°¨ íŒë§¤`,
                                description: `ì•ˆì •ì ì¸ Cash Cow ê³ ê° ${customer.accountName}ì´ ì•„ì§ êµ¬ë§¤í•˜ì§€ ì•Šì€ ì¸ê¸° ìƒí’ˆ ${recommendedProducts[0].product}ì„ ì œì•ˆí•˜ì„¸ìš”. ì´ ìƒí’ˆì€ í‰ê·  ${Math.round(recommendedProducts[0].avgPrice).toLocaleString()}ì›ì˜ ë‹¨ê°€ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.`,
                                expectedSales: Math.round(recommendedProducts[0].avgPrice * 30),
                                priority: 'low'
                            });
                        }
                    });
                }

                analysisResults.recommendations = recommendations;
                updateProgress(100);
                displayRecommendations();
                showStatus('ê°œì¸í™”ëœ ì¶”ì²œì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                showLoading(false);
            } catch (error) {
                console.error('ì¶”ì²œ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                showStatus('ì¶”ì²œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // ì¶”ì²œ ê²°ê³¼ í‘œì‹œ
        function displayRecommendations() {
            const analysisGrid = document.getElementById('analysisGrid');
            analysisGrid.innerHTML = '';

            // ì¶”ì²œ ìš”ì•½
            const recommendationSummaryCard = document.createElement('div');
            recommendationSummaryCard.className = 'analysis-card';
            const totalExpectedSales = sumBy(analysisResults.recommendations, 'expectedSales');
            recommendationSummaryCard.innerHTML = `
                <h3>ğŸ’¡ ì¶”ì²œ ìš”ì•½</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${analysisResults.recommendations.length}</div>
                        <div class="stat-label">ì´ ì¶”ì²œ ìˆ˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${Math.round(totalExpectedSales / 10000).toLocaleString()}</div>
                        <div class="stat-label">ì˜ˆìƒ ë§¤ì¶œ (ë§Œì›)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${analysisResults.recommendations.filter(r => r.priority === 'high').length}</div>
                        <div class="stat-label">ê³ ìš°ì„ ìˆœìœ„</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${uniqBy(analysisResults.recommendations, 'customer.accountCode').length}</div>
                        <div class="stat-label">ëŒ€ìƒ ê±°ë˜ì²˜</div>
                    </div>
                </div>
            `;
            analysisGrid.appendChild(recommendationSummaryCard);

            // ìš°ì„ ìˆœìœ„ë³„ ì¶”ì²œ
            const priorityOrder = ['high', 'medium', 'low'];
            priorityOrder.forEach(priority => {
                const priorityRecommendations = analysisResults.recommendations.filter(r => r.priority === priority);
                if (priorityRecommendations.length > 0) {
                    const priorityCard = document.createElement('div');
                    priorityCard.className = 'analysis-card';
                    priorityCard.innerHTML = `
                        <h3>${getPriorityEmoji(priority)} ${getPriorityName(priority)} ì¶”ì²œ (${priorityRecommendations.length}ê°œ)</h3>
                        <div>
                            ${priorityRecommendations.map(rec => `
                                <div class="recommendation-item">
                                    <div class="recommendation-title">${rec.title}</div>
                                    <div class="recommendation-description">${rec.description}</div>
                                    <div class="recommendation-metrics">
                                        <span><strong>ì˜ˆìƒ ë§¤ì¶œ:</strong> ${Math.round(rec.expectedSales / 10000).toLocaleString()}ë§Œì›</span>
                                        <span><strong>ë‹´ë‹¹ì:</strong> ${rec.customer.manager}</span>
                                        <span><strong>ê¶Œì—­:</strong> ${rec.customer.region}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    analysisGrid.appendChild(priorityCard);
                }
            });
        }

        // ë¶„ì„ ê²°ê³¼ ë‚´ë³´ë‚´ê¸° (ê¸°ë³¸ ë¶„ì„ì—ì„œ ì´ë¯¸ í†µí•©ë˜ì—ˆìœ¼ë¯€ë¡œ ë³„ë„ ì¹´ë“œ ìƒì„±í•˜ì§€ ì•ŠìŒ)
        function exportAnalysis() {
            if (!analysisResults.basic) {
                showStatus('ë‚´ë³´ë‚¼ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            showStatus('ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ê¸°ë³¸ ë¶„ì„ í™”ë©´ì˜ ìš°ì¸¡ ì¹´ë“œì—ì„œ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
        }

        // CSV ë‚´ë³´ë‚´ê¸°
        function exportToCSV() {
            try {
                let csvContent = "data:text/csv;charset=utf-8,";
                
                // ê¸°ë³¸ ë¶„ì„ ë°ì´í„°
                csvContent += "ë¶„ì„ ìœ í˜•,í•­ëª©,ê°’\n";
                csvContent += `ê¸°ë³¸í†µê³„,ì´ê±°ë˜ì²˜,${processedData.uniqueAccounts}\n`;
                csvContent += `ê¸°ë³¸í†µê³„,ì´í’ˆëª©ìˆ˜,${processedData.uniqueProducts}\n`;
                csvContent += `ê¸°ë³¸í†µê³„,ì´ë§¤ì¶œ,${processedData.totalSales}\n`;
                csvContent += `ê¸°ë³¸í†µê³„,ì´ê±°ë˜ê±´ìˆ˜,${processedData.totalRecords}\n`;
                
                // ìƒìœ„ í’ˆëª©
                csvContent += "\nìƒìœ„ í’ˆëª© ë¶„ì„\n";
                csvContent += "ìˆœìœ„,í’ˆëª©êµ°,ë§¤ì¶œì•¡,ê±°ë˜ì²˜ìˆ˜,í‰ê· ë‹¨ê°€\n";
                analysisResults.basic.productAnalysis.slice(0, 10).forEach((item, index) => {
                    csvContent += `${index + 1},${item.product},${item.totalSales},${item.accountCount},${Math.round(item.avgPrice)}\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "sales_analysis.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                showStatus('CSV ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // JSON ë‚´ë³´ë‚´ê¸°
        function exportToJSON() {
            try {
                const exportData = {
                    timestamp: new Date().toISOString(),
                    summary: processedData,
                    basicAnalysis: analysisResults.basic,
                    segmentation: analysisResults.segmentation,
                    recommendations: analysisResults.recommendations
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', 'sales_analysis.json');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('JSON íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                showStatus('JSON ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // PDF ë¦¬í¬íŠ¸ ìƒì„± (ê°„ë‹¨í•œ HTML ì¶œë ¥)
        function exportToPDF() {
            const printWindow = window.open('', '_blank');
            const printContent = `
                <html>
                <head>
                    <title>ì˜ì—… ë¶„ì„ ë¦¬í¬íŠ¸</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1, h2 { color: #333; }
                        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .stat { margin: 10px 0; }
                    </style>
                </head>
                <body>
                    <h1>ì˜ì—… ë¶„ì„ ë¦¬í¬íŠ¸</h1>
                    <p>ìƒì„±ì¼ì‹œ: ${new Date().toLocaleString()}</p>
                    
                    <h2>í•µì‹¬ ì§€í‘œ</h2>
                    <div class="stat">ì´ ê±°ë˜ì²˜: ${processedData.uniqueAccounts.toLocaleString()}ê°œ</div>
                    <div class="stat">ì´ í’ˆëª© ìˆ˜: ${processedData.uniqueProducts.toLocaleString()}ê°œ</div>
                    <div class="stat">ì´ ë§¤ì¶œ: ${Math.round(processedData.totalSales / 100000000).toLocaleString()}ì–µì›</div>
                    <div class="stat">ì´ ê±°ë˜ ê±´ìˆ˜: ${processedData.totalRecords.toLocaleString()}ê±´</div>
                    
                    <h2>ìƒìœ„ í’ˆëª© ì„±ê³¼</h2>
                    <table>
                        <thead>
                            <tr><th>ìˆœìœ„</th><th>í’ˆëª©êµ°</th><th>ë§¤ì¶œì•¡</th><th>ê±°ë˜ì²˜ ìˆ˜</th><th>í‰ê· ë‹¨ê°€</th></tr>
                        </thead>
                        <tbody>
                            ${analysisResults.basic.productAnalysis.slice(0, 10).map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.product}</td>
                                    <td>${Math.round(item.totalSales / 10000).toLocaleString()}ë§Œì›</td>
                                    <td>${item.accountCount}ê°œ</td>
                                    <td>${Math.round(item.avgPrice).toLocaleString()}ì›</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
            
            showStatus('PDF ì¸ì‡„ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'success');
        }

        // í—¬í¼ í•¨ìˆ˜ë“¤
        function getSalesSegmentName(segment) {
            const names = {
                'premium': '1,000ë§Œì› ì´ìƒ',
                'high': '500~1,000ë§Œì›',
                'medium': '100~500ë§Œì›',
                'low': '100ë§Œì› ë¯¸ë§Œ'
            };
            return names[segment] || segment;
        }

        function getSalesSegmentEmoji(segment) {
            const emojis = {
                'premium': 'ğŸ’',
                'high': 'ğŸ†',
                'medium': 'ğŸ“ˆ',
                'low': 'ğŸ”°'
            };
            return emojis[segment] || 'ğŸ“Š';
        }

        function getBCGSegmentName(segment) {
            const names = {
                'star': 'Star (ìŠ¤íƒ€)',
                'cash-cow': 'Cash Cow (ê¸ˆê³ )',
                'question-mark': 'Question Mark (ë¬¼ìŒí‘œ)',
                'dog': 'Dog (ê°œ)',
                'basic': 'Basic (ê¸°ë³¸)'
            };
            return names[segment] || segment;
        }

        function getBCGSegmentEmoji(segment) {
            const emojis = {
                'star': 'â­',
                'cash-cow': 'ğŸ„',
                'question-mark': 'â“',
                'dog': 'ğŸ•',
                'basic': 'ğŸ‘¤'
            };
            return emojis[segment] || 'ğŸ“Š';
        }

        function getPriorityName(priority) {
            const names = {
                'high': 'ë†’ì€ ìš°ì„ ìˆœìœ„',
                'medium': 'ë³´í†µ ìš°ì„ ìˆœìœ„',
                'low': 'ë‚®ì€ ìš°ì„ ìˆœìœ„'
            };
            return names[priority] || priority;
        }

        function getPriorityEmoji(priority) {
            const emojis = {
                'high': 'ğŸš¨',
                'medium': 'ğŸ“‹',
                'low': 'ğŸ’¡'
            };
            return emojis[priority] || 'ğŸ“Š';
        }

        // ì„¸ê·¸ë¨¼íŠ¸ë³„ ê±°ë˜ì²˜ ìƒì„¸ í‘œì‹œ í•¨ìˆ˜
        function showSegmentDetails(segmentType, segment) {
            if (!analysisResults.segmentation) {
                showStatus('ì„¸ë¶„í™” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ê¸°ì¡´ ì„¸ê·¸ë¨¼íŠ¸ ìƒì„¸ ì¹´ë“œê°€ ìˆìœ¼ë©´ ì œê±°
            const existingCard = document.getElementById('segmentDetailCard');
            if (existingCard) {
                existingCard.remove();
            }

            // ì„¸ê·¸ë¨¼íŠ¸ë³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            let segmentStats, segmentName, segmentEmoji, segmentClass;
            if (segmentType === 'sales') {
                segmentStats = analysisResults.segmentation.salesSegmentStats[segment];
                segmentName = getSalesSegmentName(segment);
                segmentEmoji = getSalesSegmentEmoji(segment);
                segmentClass = `segment-sales-${segment}`;
            } else if (segmentType === 'bcg') {
                segmentStats = analysisResults.segmentation.bcgSegmentStats[segment];
                segmentName = getBCGSegmentName(segment);
                segmentEmoji = getBCGSegmentEmoji(segment);
                segmentClass = `segment-bcg-${segment}`;
            }

            if (!segmentStats || segmentStats.count === 0) {
                showStatus(`${segmentName} ì„¸ê·¸ë¨¼íŠ¸ì— í•´ë‹¹í•˜ëŠ” ê±°ë˜ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.`, 'info');
                return;
            }

            // ìƒˆë¡œìš´ ìƒì„¸ ì¹´ë“œ ìƒì„±
            const analysisGrid = document.getElementById('analysisGrid');
            const segmentDetailCard = document.createElement('div');
            segmentDetailCard.id = 'segmentDetailCard';
            segmentDetailCard.className = `analysis-card ${segmentClass}`;
            segmentDetailCard.style.border = '2px solid rgba(0, 212, 255, 0.3)';

            const recentMonthFormatted = processedData.recentMonth ? `${Math.floor(processedData.recentMonth / 100)}ë…„ ${processedData.recentMonth % 100}ì›”` : '';

            segmentDetailCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">${segmentEmoji} ${segmentName} ì„¸ê·¸ë¨¼íŠ¸ ìƒì„¸ (${segmentStats.count}ê°œ)</h3>
                    <button onclick="document.getElementById('segmentDetailCard').remove()" 
                            style="background: rgba(239, 68, 68, 0.8); color: white; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 0.9rem;">
                        âœ• ë‹«ê¸°
                    </button>
                </div>
                
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(31, 41, 55, 0.3); border-radius: 10px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div>
                            <strong style="color: #00d4ff;">ìµœê·¼ì›” ë§¤ì¶œ í•©ê³„</strong><br>
                            <span style="font-size: 1.2rem; color: #ffffff;">${Math.round(segmentStats.totalRecentMonthSales / 100000000).toLocaleString()}ì–µì›</span>
                        </div>
                        <div>
                            <strong style="color: #00d4ff;">í‰ê·  ìµœê·¼ì›” ë§¤ì¶œ</strong><br>
                            <span style="font-size: 1.2rem; color: #ffffff;">${Math.round(segmentStats.avgRecentMonthSales / 10000).toLocaleString()}ë§Œì›</span>
                        </div>
                        <div>
                            <strong style="color: #00d4ff;">í‰ê·  3ê°œì›” ì„±ì¥</strong><br>
                            <span style="font-size: 1.2rem; color: ${segmentStats.avgGrowth3Month >= 0 ? '#10b981' : '#ef4444'};">${segmentStats.avgGrowth3Month >= 0 ? '+' : ''}${Math.round(segmentStats.avgGrowth3Month / 10000).toLocaleString()}ë§Œì›</span>
                        </div>
                        <div>
                            <strong style="color: #00d4ff;">í‰ê·  ì‘ë…„ ë™ì›” ì„±ì¥</strong><br>
                            <span style="font-size: 1.2rem; color: ${segmentStats.avgGrowthYearAgo >= 0 ? '#10b981' : '#ef4444'};">${segmentStats.avgGrowthYearAgo >= 0 ? '+' : ''}${Math.round(segmentStats.avgGrowthYearAgo / 10000).toLocaleString()}ë§Œì›</span>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>ê±°ë˜ì²˜ëª…</th>
                                <th>ìµœê·¼ì›” ë§¤ì¶œ</th>
                                <th>3ê°œì›” ì„±ì¥</th>
                                <th>ì‘ë…„ ë™ì›” ì„±ì¥</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${segmentStats.customers.map((customer, index) => `
                                <tr>
                                    <td><strong>${index + 1}</strong></td>
                                    <td><strong>${customer.accountName}</strong></td>
                                    <td><strong>${Math.round(customer.recentMonthSales / 10000).toLocaleString()}</strong>ë§Œì›</td>
                                    <td style="color: ${customer.growthVs3Month >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">${customer.growthVs3Month >= 0 ? '+' : ''}${Math.round(customer.growthVs3Month / 10000).toLocaleString()}ë§Œì›</td>
                                    <td style="color: ${customer.growthVsYearAgo >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">${customer.growthVsYearAgo >= 0 ? '+' : ''}${Math.round(customer.growthVsYearAgo / 10000).toLocaleString()}ë§Œì›</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // ì¹´ë“œë¥¼ ë§¨ ìœ„ì— ì‚½ì…
            analysisGrid.insertBefore(segmentDetailCard, analysisGrid.firstChild);
            
            // ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
            segmentDetailCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            showStatus(`${segmentName} ì„¸ê·¸ë¨¼íŠ¸ì˜ ê±°ë˜ì²˜ ${segmentStats.count}ê°œë¥¼ í‘œì‹œí–ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // í’ˆëª©ë³„ ê±°ë˜ì²˜ í‘œì‹œ í•¨ìˆ˜
        function showProductCustomers(productName) {
            if (!salesData || salesData.length === 0) {
                showStatus('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // í•´ë‹¹ í’ˆëª©ì˜ ì „ì²´ ë°ì´í„° í•„í„°ë§
            const productData = salesData.filter(row => row['í’ˆëª©êµ°'] === productName);

            if (productData.length === 0) {
                showStatus(`${productName} í’ˆëª©ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
                return;
            }

            // ì›”ë³„ í’ˆëª© ë§¤ì¶œ ë° í™œë™ ì¶”ì´ ê³„ì‚°
            const monthlyProductData = groupBy(productData, row => row['ê¸°ì¤€ë…„ì›”']);
            const monthlyProductSales = Object.entries(monthlyProductData)
                .map(([month, data]) => {
                    const totalSales = sumBy(data, 'ì´ë§¤ì¶œ');
                    const recordCount = data.length; // ê±°ë˜ì²˜-í’ˆëª© ì¡°í•© ìˆ˜
                    const uniqueAccounts = uniqBy(data, 'ê±°ë˜ì²˜ì½”ë“œ').length;
                    const totalQty = sumBy(data, 'ì´ìˆ˜ëŸ‰');
                    return [month, totalSales, recordCount, uniqueAccounts, totalQty];
                })
                .sort((a, b) => a[0] - b[0]);

            // í•´ë‹¹ í’ˆëª©ì„ êµ¬ë§¤í•˜ëŠ” ìµœê·¼ ì›” ë°ì´í„° í•„í„°ë§
            const recentMonthData = salesData.filter(row => 
                row['ê¸°ì¤€ë…„ì›”'] === processedData.recentMonth && row['í’ˆëª©êµ°'] === productName
            );

            // ê±°ë˜ì²˜ë³„ ì§‘ê³„
            const customerData = groupBy(recentMonthData, 'ê±°ë˜ì²˜ì½”ë“œ');
            const customerList = Object.entries(customerData).map(([accountCode, data]) => {
                const totalSales = sumBy(data, 'ì´ë§¤ì¶œ');
                const totalQty = sumBy(data, 'ì´ìˆ˜ëŸ‰');
                return {
                    accountCode,
                    accountName: data[0]['ê±°ë˜ì²˜ëª…'],
                    region: data[0]['ê¶Œì—­'],
                    manager: data[0]['ë‹´ë‹¹ì'],
                    totalSales,
                    totalQty,
                    avgPrice: totalQty > 0 ? totalSales / totalQty : 0
                };
            }).sort((a, b) => b.totalSales - a.totalSales);

            // ê¸°ì¡´ í’ˆëª© ìƒì„¸ ì¹´ë“œê°€ ìˆìœ¼ë©´ ì œê±°
            const existingCard = document.getElementById('productDetailCard');
            if (existingCard) {
                existingCard.remove();
            }

            // ìƒˆë¡œìš´ ì¹´ë“œ ìƒì„±
            const analysisGrid = document.getElementById('analysisGrid');
            const productDetailCard = document.createElement('div');
            productDetailCard.id = 'productDetailCard';
            productDetailCard.className = 'analysis-card';
            productDetailCard.style.background = 'linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(124, 58, 237, 0.1))';
            productDetailCard.style.border = '2px solid rgba(0, 212, 255, 0.3)';

            const totalProductSales = sumBy(customerList, 'totalSales');
            const totalProductQty = sumBy(customerList, 'totalQty');
            const recentMonthFormatted = processedData.recentMonth ? `${Math.floor(processedData.recentMonth / 100)}ë…„ ${processedData.recentMonth % 100}ì›”` : '';

            productDetailCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">ğŸ” ${productName} ìƒì„¸ ë¶„ì„</h3>
                    <button onclick="document.getElementById('productDetailCard').remove()" 
                            style="background: rgba(239, 68, 68, 0.8); color: white; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 0.9rem;">
                        âœ• ë‹«ê¸°
                    </button>
                </div>
                
                <h4 style="margin-bottom: 15px; color: #ffffff; font-size: 1.1rem;">ğŸ“ˆ ${productName} ì›”ë³„ ë§¤ì¶œ ë° ê±°ë˜ í™œë™ ì¶”ì´</h4>
                <p style="margin-bottom: 15px; color: #9ca3af; font-size: 0.9rem;">
                    ì´ í’ˆëª©ì˜ ì›”ë³„ ë§¤ì¶œì•¡ê³¼ ê±°ë˜ì²˜ í™œë™ ë³€í™”ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
                </p>
                <div class="chart-container">
                    <canvas id="productMonthlySalesChart"></canvas>
                </div>
                
                <hr style="margin: 30px 0; border: none; border-top: 1px solid rgba(75, 85, 99, 0.3);">
                
                <h4 style="margin-bottom: 15px; color: #ffffff; font-size: 1.1rem;">ğŸª ìµœê·¼ì›” êµ¬ë§¤ ê±°ë˜ì²˜ (${recentMonthFormatted})</h4>
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-item">
                        <div class="stat-value">${customerList.length}</div>
                        <div class="stat-label">êµ¬ë§¤ ê±°ë˜ì²˜ ìˆ˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${Math.round(totalProductSales / 10000).toLocaleString()}</div>
                        <div class="stat-label">ìµœê·¼ì›” ë§¤ì¶œ (ë§Œì›)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${customerList.length > 0 ? Math.round(totalProductSales / customerList.length / 10000).toLocaleString() : 0}</div>
                        <div class="stat-label">ê±°ë˜ì²˜ë‹¹ í‰ê· ë§¤ì¶œ (ë§Œì›)</div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>ê±°ë˜ì²˜ëª…</th>
                                <th>ë§¤ì¶œì•¡</th>
                                <th>ì ìœ ìœ¨</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customerList.map((customer, index) => {
                                const salesShare = totalProductSales > 0 ? ((customer.totalSales / totalProductSales) * 100).toFixed(1) : '0.0';
                                return `
                                    <tr>
                                        <td><strong>${index + 1}</strong></td>
                                        <td><strong>${customer.accountName}</strong></td>
                                        <td><strong>${Math.round(customer.totalSales / 10000).toLocaleString()}</strong>ë§Œì›</td>
                                        <td><span style="color: ${salesShare > 20 ? '#10b981' : salesShare > 10 ? '#f59e0b' : '#6b7280'}; font-weight: 600;">${salesShare}%</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // ì¹´ë“œë¥¼ ë§¨ ìœ„ì— ì‚½ì…
            analysisGrid.insertBefore(productDetailCard, analysisGrid.firstChild);
            
            // í’ˆëª©ë³„ ì›”ë³„ ì°¨íŠ¸ ìƒì„±
            setTimeout(() => {
                createProductMonthlySalesChart(monthlyProductSales, productName);
            }, 100);
            
            // ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
            productDetailCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            showStatus(`${productName} í’ˆëª©ì˜ ì›”ë³„ ì¶”ì´ì™€ ê±°ë˜ì²˜ ${customerList.length}ê°œë¥¼ í‘œì‹œí–ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // BCG Matrix ê¸°ì¤€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateBCGCriteria(segment, field, value) {
            bcgMatrixCriteria[segment][field] = parseFloat(value);
            
            // í‘œì‹œê°’ ì—…ë°ì´íŠ¸
            if (segment === 'star') {
                if (field === 'minRecentSales') {
                    document.getElementById('starMinSalesValue').textContent = (value / 10000).toLocaleString() + 'ë§Œì›';
                } else if (field === 'minGrowth3Month') {
                    document.getElementById('starMinGrowthValue').textContent = (value / 10000).toLocaleString() + 'ë§Œì›';
                }
            } else if (segment === 'cashCow') {
                if (field === 'minRecentSales') {
                    document.getElementById('cashCowMinSalesValue').textContent = (value / 10000).toLocaleString() + 'ë§Œì›';
                } else if (field === 'minGrowth3Month') {
                    document.getElementById('cashCowMinGrowth3MValue').textContent = (value / 10000).toLocaleString() + 'ë§Œì›';
                }
            } else if (segment === 'questionMark') {
                if (field === 'growthRate3Month') {
                    document.getElementById('questionMarkRate3MValue').textContent = (value * 100) + '%';
                } else if (field === 'growthRateYearAgo') {
                    document.getElementById('questionMarkRateYearValue').textContent = (value * 100) + '%';
                }
            } else if (segment === 'dog') {
                if (field === 'maxRecentSales') {
                    document.getElementById('dogMaxSalesValue').textContent = (value / 10000).toLocaleString() + 'ë§Œì›';
                } else if (field === 'maxGrowth3Month') {
                    document.getElementById('dogMaxGrowth3MValue').textContent = (value / 10000).toLocaleString() + 'ë§Œì›';
                }
            }
            
            // ì‹¤ì‹œê°„ BCG ì„¸ë¶„í™” ì—…ë°ì´íŠ¸
            updateBCGSegmentationRealtime();
        }

        // ìë™ íŒŒì¼ ë¡œë“œ ì‹œë„
        async function tryAutoLoadFile() {
            try {
                showStatus('rx-rawdata.csv íŒŒì¼ì„ ì°¾ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 'info');
                
                // ê°™ì€ ë””ë ‰í† ë¦¬ì˜ rx-rawdata.csv íŒŒì¼ ì‹œë„
                const response = await fetch('./rx-rawdata.csv');
                
                if (response.ok) {
                    const csvText = await response.text();
                    showStatus('rx-rawdata.csv íŒŒì¼ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ë¡œë“œí•©ë‹ˆë‹¤...', 'success');
                    
                    // íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ ìˆ¨ê¹€
                    document.getElementById('fileInputArea').style.display = 'none';
                    
                    // CSV ë°ì´í„° íŒŒì‹±
                    showLoading(true);
                    updateProgress(20);
                    
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: true,
                        complete: function(results) {
                            try {
                                if (results.errors.length > 0) {
                                    console.warn('CSV íŒŒì‹± ê²½ê³ :', results.errors);
                                }

                                if (!results.data || results.data.length === 0) {
                                    showStatus('íŒŒì¼ì— ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                                    showFileUploadArea();
                                    showLoading(false);
                                    return;
                                }

                                salesData = results.data.filter(row => {
                                    return Object.values(row).some(value => 
                                        value !== null && value !== undefined && value !== ''
                                    );
                                });

                                if (salesData.length === 0) {
                                    showStatus('íŒŒì¼ì—ì„œ ìœ íš¨í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                                    showFileUploadArea();
                                    showLoading(false);
                                    return;
                                }

                                preprocessData();
                                showStatus(`ìë™ ë¡œë“œ ì™„ë£Œ: ${salesData.length.toLocaleString()}ê°œ ë ˆì½”ë“œ`, 'success');
                                enableAnalysisButtons();
                                showManualUploadButton(); // ìˆ˜ë™ ì—…ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
                                updateProgress(100);
                                showLoading(false);
                                
                                // ìë™ìœ¼ë¡œ ê¸°ë³¸ ë¶„ì„ ì‹¤í–‰
                                setTimeout(() => {
                                    performBasicAnalysis();
                                }, 500);
                            } catch (error) {
                                console.error('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                                showStatus('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                                showFileUploadArea();
                                showLoading(false);
                            }
                        },
                        error: function(error) {
                            console.error('CSV íŒŒì‹± ì˜¤ë¥˜:', error);
                            showStatus('CSV íŒŒì¼ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                            showFileUploadArea();
                            showLoading(false);
                        }
                    });
                } else {
                    // íŒŒì¼ì´ ì—†ìœ¼ë©´ ì—…ë¡œë“œ ì˜ì—­ í‘œì‹œ
                    showFileUploadArea();
                }
            } catch (error) {
                console.log('rx-rawdata.csv íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ì—…ë¡œë“œ ë©”ë‰´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.');
                showFileUploadArea();
            }
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ í‘œì‹œ
        function showFileUploadArea() {
            document.getElementById('fileInputArea').style.display = 'block';
            showStatus('CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ë°ëª¨ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'info');
        }

        // ìˆ˜ë™ ì—…ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
        function showManualUploadButton() {
            document.getElementById('manualUploadBtn').style.display = 'inline-block';
        }

        // ìˆ˜ë™ ì—…ë¡œë“œ í‘œì‹œ
        function showManualUpload() {
            document.getElementById('fileInputArea').style.display = 'block';
            showStatus('ë‹¤ë¥¸ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ë°ëª¨ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'info');
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            setupFileHandling();
            loadLibraries();
            
            // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ í›„ ìë™ íŒŒì¼ ë¡œë“œ ì‹œë„
            const checkAndAutoLoad = () => {
                if (librariesLoaded) {
                    // í˜„ì¬ URLì´ HTTP/HTTPS í”„ë¡œí† ì½œì¸ì§€ í™•ì¸
                    if (window.location.protocol === 'file:') {
                        showFileUploadArea();
                        showStatus('ğŸ’¡ ë¡œì»¬ ì„œë²„ë¥¼ ì‹¤í–‰í•˜ê³  http://localhost:8000/advisor.html ë¡œ ì ‘ì†í•˜ë©´ CSV íŒŒì¼ì´ ìë™ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤.', 'info');
                    } else {
                        tryAutoLoadFile();
                    }
                } else {
                    setTimeout(checkAndAutoLoad, 100);
                }
            };
            
            checkAndAutoLoad();
        });
    </script>
</body>
</html> 
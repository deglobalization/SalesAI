<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="mobile-optimization.css">
    <title>ë°ì´í„° ê¸°ë°˜ ì˜ì—… ë¶„ì„ ë° ì¶”ì²œ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0b0d;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .background-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.03;
            background-image: 
                radial-gradient(circle at 20% 50%, #00d4ff 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, #ff6b35 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, #7c3aed 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 30px 40px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(124, 58, 237, 0.1));
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ */
        .tab-navigation {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            padding: 5px;
            background: rgba(17, 24, 39, 0.8);
            border-radius: 15px;
            border: 1px solid rgba(75, 85, 99, 0.3);
            backdrop-filter: blur(20px);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .tab-navigation::-webkit-scrollbar {
            display: none;
        }

        .tab-button {
            flex: 1;
            min-width: 140px;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: #a1a1aa;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab-button:hover {
            background: rgba(75, 85, 99, 0.3);
            color: #ffffff;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .tab-button .icon {
            font-size: 1.1rem;
        }

        /* íƒ­ ì½˜í…ì¸  */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header-content {
            flex: 1;
            text-align: center;
        }

        .map-container {
            width: 400px;
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(17, 24, 39, 0.8);
            position: relative;
        }

        .map-title {
            position: absolute;
            top: 10px;
            left: 15px;
            background: rgba(17, 24, 39, 0.9);
            color: #00d4ff;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 1000;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        #salesMap {
            width: 100%;
            height: 100%;
            border-radius: 13px;
        }

        /* ì§€ì—­ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .leaflet-interactive.top-region {
            filter: drop-shadow(0 0 10px rgba(255, 107, 53, 0.8));
            transition: all 0.3s ease;
        }

        .leaflet-interactive.region-highlight {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .leaflet-interactive.region-highlight:hover {
            filter: brightness(1.3) drop-shadow(0 0 8px currentColor);
            transform: scale(1.02);
        }

        /* ì„¸ë¶€ ì§€ì—­ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .leaflet-interactive.top-detailed-region {
            filter: drop-shadow(0 0 15px rgba(255, 23, 68, 1.0));
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .leaflet-interactive.detailed-region-highlight {
            transition: all 0.2s ease;
            cursor: pointer;
            z-index: 999;
        }

        .leaflet-interactive.detailed-region-highlight:hover {
            filter: brightness(1.4) drop-shadow(0 0 12px currentColor);
            transform: scale(1.05);
        }

        /* ì„¸ë¶€ ì§€ì—­ ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        .detailed-region-label div {
            transition: all 0.3s ease;
        }

        .detailed-region-label div:hover {
            transform: scale(1.1) !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6) !important;
        }

        /* íŒì—… ìŠ¤íƒ€ì¼ ê°œì„  */
        .leaflet-popup-content-wrapper {
            background: rgba(17, 24, 39, 0.95) !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px) !important;
        }

        .leaflet-popup-tip {
            background: rgba(17, 24, 39, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4ff, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 1.2rem;
            color: #a1a1aa;
            font-weight: 400;
        }

        .control-panel {
            background: rgba(17, 24, 39, 0.8);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(75, 85, 99, 0.3);
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .file-input-area {
            border: 2px dashed rgba(75, 85, 99, 0.5);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 25px;
            background: rgba(31, 41, 55, 0.3);
        }

        .file-input-area:hover, .file-input-area.dragover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.05);
        }

        .file-input {
            display: none;
        }

        .file-input-label, .demo-data-btn {
            display: inline-block;
            padding: 14px 28px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .file-input-label {
            background: linear-gradient(135deg, #00d4ff, #0ea5e9);
            color: white;
            margin-right: 15px;
        }

        .demo-data-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .file-input-label:hover, .demo-data-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .analysis-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            background: rgba(31, 41, 55, 0.8);
            color: #ffffff;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            border-color: #00d4ff;
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(75, 85, 99, 0.3);
            border-radius: 2px;
            overflow: hidden;
            margin: 25px 0 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #7c3aed);
            width: 0%;
            transition: width 0.8s ease;
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
            border-left: 4px solid;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-left-color: #10b981;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-left-color: #ef4444;
        }

        .status-info {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            border-left-color: #00d4ff;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .analysis-card {
            background: rgba(17, 24, 39, 0.8);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(75, 85, 99, 0.3);
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .analysis-card h3 {
            color: #ffffff;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(31, 41, 55, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(75, 85, 99, 0.2);
        }

        .clickable-stat:hover {
            background: rgba(255, 255, 255, 0.05) !important;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #00d4ff;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #9ca3af;
            font-weight: 500;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(31, 41, 55, 0.3);
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(75, 85, 99, 0.2);
        }

        th {
            background: rgba(17, 24, 39, 0.8);
            color: #00d4ff;
            font-weight: 600;
            font-size: 0.9rem;
        }

        td {
            color: #d1d5db;
            font-size: 0.9rem;
        }

        tr:hover {
            background: rgba(75, 85, 99, 0.1);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 212, 255, 0.2);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* ë§¤ì¶œì•¡ ê¸°ì¤€ ì„¸ê·¸ë¨¼íŠ¸ ìŠ¤íƒ€ì¼ */
        .segment-sales-premium {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.2), rgba(126, 34, 206, 0.1));
            border-left: 4px solid #9333ea;
        }

        .segment-sales-high {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1));
            border-left: 4px solid #10b981;
        }

        .segment-sales-medium {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1));
            border-left: 4px solid #3b82f6;
        }

        .segment-sales-low {
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(75, 85, 99, 0.1));
            border-left: 4px solid #6b7280;
        }

        /* BCG Matrix ì„¸ê·¸ë¨¼íŠ¸ ìŠ¤íƒ€ì¼ */
        .segment-bcg-star {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 193, 7, 0.1));
            border-left: 4px solid #FFD700;
        }

        .segment-bcg-cash-cow {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.1));
            border-left: 4px solid #22C55E;
        }

        .segment-bcg-question-mark {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1));
            border-left: 4px solid #f59e0b;
        }

        .segment-bcg-dog {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
            border-left: 4px solid #ef4444;
        }

        .segment-bcg-basic {
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(75, 85, 99, 0.1));
            border-left: 4px solid #6b7280;
        }

        .recommendation-item {
            background: rgba(31, 41, 55, 0.5);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #7c3aed;
        }

        .recommendation-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .recommendation-description {
            color: #d1d5db;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .recommendation-metrics {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #9ca3af;
        }

        .export-formats {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .export-btn {
            padding: 8px 16px;
            background: rgba(124, 58, 237, 0.8);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: rgba(124, 58, 237, 1);
            transform: translateY(-1px);
        }

        .clickable-product {
            transition: all 0.3s ease;
        }

        .clickable-product:hover {
            color: #7c3aed !important;
            text-shadow: 0 0 8px rgba(0, 212, 255, 0.5);
            transform: scale(1.05);
        }

        .clickable-segment {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .clickable-segment:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            filter: brightness(1.2);
        }

        .clickable-segment:active {
            transform: translateY(-1px) scale(1.02);
        }

        .clickable-segment::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .clickable-segment:hover::before {
            opacity: 1;
        }

        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(75, 85, 99, 0.5);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: #d1d5db;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #00d4ff;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
            background-color: white;
        }

        .toggle-slider:hover {
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        /* AI ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loading-dot {
            color: #00d4ff;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .loading-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes pulse {
            0%, 20% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
            80%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .header-content {
                flex: none;
            }
            
            .map-container {
                width: 100%;
                height: 250px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
            
            .analysis-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
                text-align: center;
            }
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• CSS */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                padding: 20px;
                margin-bottom: 15px;
                text-align: center;
            }

            .header h1 {
                font-size: 2rem;
                margin-bottom: 10px;
            }

            .header p {
                font-size: 1rem;
                margin-bottom: 20px;
            }

            .map-container {
                width: 100%;
                height: 250px;
                margin-top: 20px;
            }

            .control-panel {
                padding: 20px;
                margin-bottom: 20px;
            }

            .file-input-area {
                padding: 25px 15px;
            }

            .file-input-label, .demo-data-btn {
                display: block;
                width: 100%;
                margin: 10px 0;
                padding: 15px;
                font-size: 0.95rem;
            }

            .analysis-controls {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                width: 100%;
                padding: 15px;
                font-size: 0.9rem;
            }

            .tab-navigation {
                margin-bottom: 20px;
                padding: 3px;
            }

            .tab-button {
                min-width: 110px;
                padding: 10px 15px;
                font-size: 0.85rem;
            }

            .tab-button .icon {
                font-size: 1rem;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .analysis-item {
                margin-bottom: 20px;
            }

            .analysis-item h3 {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .stat-label {
                font-size: 0.8rem;
            }

            .chart-container {
                height: 250px;
                margin: 15px 0;
            }

            .segmentation-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .segment-item {
                padding: 15px;
            }

            .segment-title {
                font-size: 1rem;
            }

            .customer-list {
                max-height: 200px;
            }

            .customer-item {
                padding: 10px;
                margin-bottom: 8px;
            }

            .recommendation-card {
                padding: 20px;
                margin-bottom: 15px;
            }

            .recommendation-title {
                font-size: 1.1rem;
                margin-bottom: 10px;
            }

            .recommendation-confidence {
                font-size: 0.8rem;
            }

            .export-options {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .export-btn {
                padding: 15px;
            }

            .loading-overlay {
                padding: 20px;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
            }

            .modal-content {
                margin: 20px;
                padding: 20px;
                max-height: calc(100vh - 40px);
                overflow-y: auto;
            }

            .modal h2 {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }

            /* í„°ì¹˜ ì¹œí™”ì  ë²„íŠ¼ í¬ê¸° */
            button, .btn, .tab-button {
                min-height: 44px;
                touch-action: manipulation;
            }

            /* ìŠ¤í¬ë¡¤ ê°œì„  */
            .tab-navigation {
                -webkit-overflow-scrolling: touch;
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 5px;
            }

            .tab-button {
                flex: 0 0 auto;
                min-width: 100px;
                white-space: nowrap;
            }

            .tab-button .icon {
                display: block;
                margin-bottom: 2px;
            }

            .tab-button span:last-child {
                font-size: 0.75rem;
            }

            /* ì‘ì€ í™”ë©´ì—ì„œ í…ìŠ¤íŠ¸ ê°€ë…ì„± ê°œì„  */
            body {
                font-size: 16px;
                line-height: 1.5;
            }

            /* ì§€ë„ ëª¨ë°”ì¼ ìµœì í™” */
            .map-title {
                font-size: 0.8rem;
                padding: 3px 8px;
            }

            /* íŒì—… ëª¨ë°”ì¼ ìµœì í™” */
            .leaflet-popup-content-wrapper {
                max-width: 250px !important;
            }
        }

        /* íƒœë¸”ë¦¿ í¬ê¸° ìµœì í™” */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding: 15px;
            }

            .header {
                padding: 30px;
            }

            .header h1 {
                font-size: 2.5rem;
            }

            .map-container {
                width: 350px;
                height: 280px;
            }

            .analysis-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .segmentation-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .tab-button {
                min-width: 130px;
                padding: 11px 18px;
            }
        }

        /* ì´ˆì†Œí˜• í™”ë©´ (320px ì´í•˜) ìµœì í™” */
        @media (max-width: 320px) {
            .header h1 {
                font-size: 1.6rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .tab-button {
                min-width: 90px;
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 12px;
            }

            .btn {
                padding: 12px;
                font-size: 0.85rem;
            }
        }
        

    </style>
    
    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Papa Parse (CSV íŒŒì‹±) -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Leaflet ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="manager_selection.js"></script>
    <script src="batch_manager_loader.js"></script>
    <script src="manager_list_display.js"></script>
<script src="manager_recommendation_integration.js"></script>
<script src="customer_recommendations_integration.js"></script>
<script src="customer_status_checker.js"></script>
</head>
<body>
    <div class="background-pattern"></div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>ğŸ“Š ë°ì´í„° ê¸°ë°˜ ì˜ì—… ë¶„ì„ ë° ì¶”ì²œ ì‹œìŠ¤í…œ</h1>
                <p>ë°ì´í„° ê¸°ë°˜ ì˜ì—… ë¶„ì„ ë° ì¶”ì²œ ì‹œìŠ¤í…œ</p>
                <div id="chromeAiStatus" style="margin-top: 10px; font-size: 0.9rem; color: #94a3b8;">
                    ğŸ”„ AI ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...
                </div>
                
                <!-- AI ì„¤ì • í† ê¸€ -->
                    </button>
                </div>
                
                <!-- AI ì„¤ì • íŒ¨ë„ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
                <div id="aiSettingsPanel" style="display: none; margin-top: 15px; padding: 15px; background: rgba(31, 41, 55, 0.5); border: 1px solid rgba(75, 85, 99, 0.3); border-radius: 8px;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #e5e7eb; font-size: 0.95rem;">ğŸ¤– AI ì‹œìŠ¤í…œ ì„¤ì •</h4>
                        <button onclick="toggleAISettings()" style="background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 1.1rem;">âœ•</button>
                    </div>
                    
                    <!-- ê¸°ë³¸ ì„¤ì • ê·¸ë£¹ -->
                    <div id="basicAISettings">
                        <p style="margin: 8px 0; color: #9ca3af; font-size: 0.8rem;">
                            ğŸ§  í˜„ì¬ ì§€ëŠ¥í˜• ê·œì¹™ ê¸°ë°˜ ë¶„ì„ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                        </p>
                        <div style="margin: 10px 0;">
                            <label style="color: #e5e7eb; font-size: 0.85rem; margin-bottom: 5px; display: block;">ê³ ê¸‰ AI í™œì„±í™” ë¹„ë°€ë²ˆí˜¸:</label>
                            <input type="password" id="aiPasswordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                                   style="width: 100%; padding: 8px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(75, 85, 99, 0.5); border-radius: 4px; color: #e5e7eb; font-size: 0.85rem;">
                        </div>
                        <div style="margin: 8px 0; padding: 8px; background: rgba(99, 102, 241, 0.1); border-radius: 4px; border-left: 3px solid #6366f1;">
                            <p style="color: #a5b4fc; font-size: 0.8rem; margin: 0;">
                                ğŸ’¡ ì˜¬ë°”ë¥¸ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œ ê³ ê¸‰ AI ë¶„ì„ ê¸°ëŠ¥ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 10px;">
                            <button onclick="validateAIPassword()" style="background: #6366f1; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem;">
                                ğŸš€ AI í™œì„±í™”
                            </button>
                            <button onclick="resetToBasicAI()" style="background: #6b7280; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem;">
                                ğŸ”„ ê¸°ë³¸ ëª¨ë“œ
                            </button>
                        </div>
                    </div>
                    
                    <!-- ê³ ê¸‰ ì„¤ì • ê·¸ë£¹ (ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ í‘œì‹œ) -->
                    <div id="advancedAISettings" style="display: none;">
                        <p style="margin: 8px 0; color: #10b981; font-size: 0.8rem;">
                
                <!-- í˜„ì¬ ë‹´ë‹¹ì ì •ë³´ íŒ¨ë„ -->
                <div id="currentManagerInfo" style="display: none; margin-top: 15px; padding: 15px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.2rem;">ğŸ‘¤</span>
                        <span id="managerInfoText" style="color: #4ade80; font-size: 0.9rem;">ë‹´ë‹¹ì ë¯¸ì„ íƒ</span>
                    </div>
                </div>                             âœ… ê³ ê¸‰ AI ì‹œìŠ¤í…œì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. Hugging Face AIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                        </p>
                        <div style="margin: 10px 0;">
                            <label style="color: #e5e7eb; font-size: 0.85rem; margin-bottom: 5px; display: block;">Hugging Face API í† í°:</label>
                            <input type="password" id="hfApiKeyInput" placeholder="hf_xxxxxxxxxxxxxxxx" 
                                   style="width: 100%; padding: 8px; background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(16, 185, 129, 0.5); border-radius: 4px; color: #e5e7eb; font-size: 0.85rem;"
                                   value="DEMO_HUGGINGFACE_TOKEN_HERE" readonly>
                        </div>
                        <div style="margin: 8px 0; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 4px; border-left: 3px solid #10b981;">
                            <p style="color: #10b981; font-size: 0.8rem; margin: 0;">
                                ğŸ”‘ ì‚¬ì „ êµ¬ì„±ëœ ê³ ê¸‰ AI í† í°ì´ ìë™ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 10px;">
                            <button onclick="resetToBasicAI()" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 0.8rem;">
                                ğŸ”’ AI ë¹„í™œì„±í™”
                            </button>
                            <a href="https://huggingface.co/settings/tokens" target="_blank" style="background: #6366f1; color: white; border: none; border-radius: 4px; padding: 6px 12px; text-decoration: none; font-size: 0.8rem;">
                                ğŸ”‘ í† í° ì •ë³´
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="map-container">
                <div class="map-title">ğŸ“ ì§€ì—­ ì§€ë„</div>
                <div id="salesMap"></div>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('upload')" id="uploadTab">
                <span class="icon">ğŸ“</span>
                <span>ë°ì´í„° ì—…ë¡œë“œ</span>
            </button>
            <button class="tab-button" onclick="switchTab('analysis')" id="analysisTab">
                <span class="icon">ğŸ“Š</span>
                <span>ê¸°ë³¸ ë¶„ì„</span>
            </button>
            <button class="tab-button" onclick="switchTab('segmentation')" id="segmentationTab">
                <span class="icon">ğŸ¯</span>
                <span>ê³ ê° ì„¸ë¶„í™”</span>
            </button>
            <button class="tab-button" onclick="switchTab('recommendation')" id="recommendationTab">
                <span class="icon">ğŸ’¡</span>
                                        <span>ğŸ¯ SmartAI ì¶”ì²œ</span>
            </button>
            <button class="tab-button" onclick="switchTab('export')" id="exportTab">
                <span class="icon">ğŸ“¤</span>
                <span>ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</span>
            </button>
        </div>

        <!-- íƒ­ ì½˜í…ì¸  -->
        <div id="uploadContent" class="tab-content active">
            <div class="control-panel">
            <div class="file-input-area" id="fileInputArea" style="display: none;">
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls">
                <label for="fileInput" class="file-input-label">ğŸ“ CSV íŒŒì¼ ì—…ë¡œë“œ</label>
                <button class="demo-data-btn" onclick="generateDemoData()">ğŸ¯ ë°ëª¨ ë°ì´í„° ìƒì„±</button>
                <p style="margin-top: 15px; color: #9ca3af; font-size: 0.9rem;">
                    CSV íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”
                </p>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div id="statusMessage" class="status-message hidden">
                ìƒíƒœ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>

            <div class="analysis-controls">
                <button class="btn" id="basicAnalysisBtn" onclick="performBasicAnalysis()" disabled>
                    ğŸ“Š ê¸°ë³¸ ë¶„ì„ ì‹œì‘
                </button>
                <button class="btn" id="manualUploadBtn" onclick="showManualUpload()" style="display: none;">
                    ğŸ“ ë‹¤ë¥¸ íŒŒì¼ ì—…ë¡œë“œ
                </button>
            </div>
            </div>
        </div>

        <!-- ê¸°ë³¸ ë¶„ì„ íƒ­ -->
        <div id="analysisContent" class="tab-content">
            <div class="control-panel">
                <div class="analysis-controls">
                    <button class="btn" id="segmentationBtn" onclick="performCustomerSegmentation()" disabled>
                        ğŸ¯ ê³ ê° ì„¸ë¶„í™” ì‹œì‘
                    </button>
                </div>
            </div>
            <div class="analysis-grid" id="analysisGrid">
                <!-- ê¸°ë³¸ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ê³ ê° ì„¸ë¶„í™” íƒ­ -->
        <div id="segmentationContent" class="tab-content">
            <div class="control-panel">
                <div class="analysis-controls">
                    <button class="btn" id="recommendationBtn" onclick="generateRecommendations()" disabled>
                        ğŸ¯ SmartAI ì¶”ì²œ ìƒì„±
                    </button>
                </div>
            </div>
            <div class="analysis-grid" id="segmentationGrid">
                <!-- ê³ ê° ì„¸ë¶„í™” ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- AI ì¶”ì²œ íƒ­ -->
        <div id="recommendationContent" class="tab-content">
            <div class="control-panel">
                <div class="analysis-controls">
                    <!-- SmartAI í’ˆëª© ì¦‰ì‹œ ê²€ìƒ‰ ê¸°ëŠ¥ -->
                    <div class="instant-search-container" style="background: rgba(17, 24, 39, 0.8); border: 1px solid rgba(75, 85, 99, 0.3); border-radius: 15px; padding: 20px; margin-bottom: 20px; backdrop-filter: blur(20px);">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div style="font-size: 1.3rem;">ğŸ”</div>
                            <div>
                                <h3 style="margin: 0; color: #00d4ff;">SmartAI í’ˆëª© ì¦‰ì‹œ ê²€ìƒ‰</h3>
                                <p style="margin: 5px 0 0 0; color: #9ca3af; font-size: 0.9rem;">í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì—¬ ì‹¤ì‹œê°„ìœ¼ë¡œ íƒ€ê²Ÿ ì¶”ì²œì„ ë°›ì•„ë³´ì„¸ìš”</p>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                            <input type="text" 
                                   id="instantSearchInput" 
                                   placeholder="ì˜ˆ: ì¡¸í”¼ë“œ, ê°€ë°”í˜ë‹Œ, ë€ì†Œì¡¸ ë“±..." 
                                   style="flex: 1; padding: 12px 15px; border: 2px solid rgba(75, 85, 99, 0.5); border-radius: 8px; font-size: 1rem; background: rgba(55, 65, 81, 0.5); color: #ffffff; transition: border-color 0.3s ease;"
                                   onkeyup="handleInstantSearchAdvisor(event)"
                                   oninput="showSearchSuggestionsAdvisor()">
                            <button onclick="performInstantSearchAdvisor()" 
                                    style="background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);">
                                ğŸš€ SmartAI ê²€ìƒ‰
                            </button>
                        </div>
                        
                        <!-- ê²€ìƒ‰ ì œì•ˆ ë“œë¡­ë‹¤ìš´ -->
                        <div id="searchSuggestionsAdvisor" style="display: none; position: relative; z-index: 100;"></div>
                        
                        <!-- ìµœê·¼ ê²€ìƒ‰ì–´ -->
                        <div id="recentSearchesAdvisor" style="display: none;">
                            <div style="font-size: 0.9rem; color: #9ca3af; margin-bottom: 8px;">ìµœê·¼ ê²€ìƒ‰:</div>
                            <div id="recentSearchesListAdvisor" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="analysis-grid" id="recommendationGrid">
                <!-- AI ì¶”ì²œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ê²°ê³¼ ë‚´ë³´ë‚´ê¸° íƒ­ -->
        <div id="exportContent" class="tab-content">
            <div class="control-panel">
                <div class="analysis-controls">
                    <button class="btn" id="exportBtn" onclick="exportAnalysis()" disabled>
                        ğŸ“¤ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°
                    </button>
                </div>
            </div>
            <div class="analysis-grid" id="exportGrid">
                <!-- ë‚´ë³´ë‚´ê¸° ì˜µì…˜ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë“¤
        var salesData = [];
        var processedData = {};
        var analysisResults = {};
        var librariesLoaded = false;
        var salesMap = null;

        // íƒ­ ì „í™˜ í•¨ìˆ˜
        function switchTab(tabName) {
            // ëª¨ë“  íƒ­ ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ì„ íƒëœ íƒ­ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // ì„ íƒëœ íƒ­ ì½˜í…ì¸  í‘œì‹œ
            document.getElementById(tabName + 'Content').classList.add('active');

            // íƒ­ë³„ íŠ¹ë³„ ì²˜ë¦¬
            if (tabName === 'upload') {
                // ì—…ë¡œë“œ íƒ­ì—ì„œ íŒŒì¼ ì…ë ¥ ì˜ì—­ í‘œì‹œ
                const fileInputArea = document.getElementById('fileInputArea');
                if (fileInputArea && salesData.length === 0) {
                    fileInputArea.style.display = 'block';
                }
            }
        }

        // ìë™ íƒ­ ì „í™˜ í•¨ìˆ˜ (ë¶„ì„ ì§„í–‰ ì‹œ)
        function autoSwitchTab(tabName) {
            setTimeout(() => {
                switchTab(tabName);
            }, 500);
        }

        // í•œêµ­ ì§€ì—­ ì •ë³´ (ì¤‘ì‹¬ì¢Œí‘œ, ê²½ê³„, ì§€ì—­ëª…)
        const regionData = {
            'ì„œìš¸': { 
                lat: 37.5665, lng: 126.9780, name: 'ì„œìš¸íŠ¹ë³„ì‹œ',
                bounds: [[37.7, 126.7], [37.4, 127.2]] // [ë¶ì„œ, ë‚¨ë™]
            },
            'ë¶€ì‚°': { 
                lat: 35.1796, lng: 129.0756, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ',
                bounds: [[35.4, 128.8], [35.0, 129.3]]
            },
            'ëŒ€êµ¬': { 
                lat: 35.8722, lng: 128.6014, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ',
                bounds: [[36.0, 128.4], [35.7, 128.8]]
            },
            'ì¸ì²œ': { 
                lat: 37.4563, lng: 126.7052, name: 'ì¸ì²œê´‘ì—­ì‹œ',
                bounds: [[37.7, 126.3], [37.2, 126.9]]
            },
            'ê´‘ì£¼': { 
                lat: 35.1595, lng: 126.8526, name: 'ê´‘ì£¼ê´‘ì—­ì‹œ',
                bounds: [[35.3, 126.7], [35.0, 127.0]]
            },
            'ëŒ€ì „': { 
                lat: 36.3504, lng: 127.3845, name: 'ëŒ€ì „ê´‘ì—­ì‹œ',
                bounds: [[36.5, 127.2], [36.2, 127.5]]
            },
            'ìš¸ì‚°': { 
                lat: 35.5384, lng: 129.3114, name: 'ìš¸ì‚°ê´‘ì—­ì‹œ',
                bounds: [[35.7, 129.0], [35.4, 129.5]]
            },
            'ì„¸ì¢…': { 
                lat: 36.4800, lng: 127.2890, name: 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ',
                bounds: [[36.6, 127.1], [36.3, 127.4]]
            },
            'ê²½ê¸°': { 
                lat: 37.4138, lng: 127.5183, name: 'ê²½ê¸°ë„',
                bounds: [[38.0, 126.4], [36.8, 127.9]]
            },
            'ê°•ì›': { 
                lat: 37.8228, lng: 128.1555, name: 'ê°•ì›ë„',
                bounds: [[38.6, 127.0], [37.0, 129.4]]
            },
            'ì¶©ë¶': { 
                lat: 36.8, lng: 127.7, name: 'ì¶©ì²­ë¶ë„',
                bounds: [[37.2, 127.2], [36.2, 128.5]]
            },
            'ì¶©ë‚¨': { 
                lat: 36.5, lng: 126.8, name: 'ì¶©ì²­ë‚¨ë„',
                bounds: [[37.1, 125.9], [36.0, 127.6]]
            },
            'ì „ë¶': { 
                lat: 35.7175, lng: 127.153, name: 'ì „ë¼ë¶ë„',
                bounds: [[36.2, 126.4], [35.2, 127.8]]
            },
            'ì „ë‚¨': { 
                lat: 34.8679, lng: 126.991, name: 'ì „ë¼ë‚¨ë„',
                bounds: [[35.4, 126.0], [34.0, 127.7]]
            },
            'ê²½ë¶': { 
                lat: 36.4919, lng: 128.888, name: 'ê²½ìƒë¶ë„',
                bounds: [[37.5, 128.0], [35.7, 130.0]]
            },
            'ê²½ë‚¨': { 
                lat: 35.4606, lng: 128.2132, name: 'ê²½ìƒë‚¨ë„',
                bounds: [[36.0, 127.5], [34.6, 129.2]]
            },
            'ì œì£¼': { 
                lat: 33.4996, lng: 126.5312, name: 'ì œì£¼íŠ¹ë³„ìì¹˜ë„',
                bounds: [[33.6, 126.1], [33.1, 127.0]]
            }
        };

        // ì‹œ/êµ°/êµ¬ ì„¸ë¶€ ì§€ì—­ ì •ë³´
        const detailedRegionData = {
            // ì„œìš¸ êµ¬
            'ê°•ë‚¨': { lat: 37.5173, lng: 127.0473, name: 'ê°•ë‚¨êµ¬', parent: 'ì„œìš¸', bounds: [[37.54, 127.02], [37.49, 127.07]] },
            'ê°•ë¶': { lat: 37.6379, lng: 127.0258, name: 'ê°•ë¶êµ¬', parent: 'ì„œìš¸', bounds: [[37.66, 127.00], [37.61, 127.05]] },
            'ì†¡íŒŒ': { lat: 37.5145, lng: 127.1059, name: 'ì†¡íŒŒêµ¬', parent: 'ì„œìš¸', bounds: [[37.54, 127.08], [37.49, 127.13]] },
            'ë§ˆí¬': { lat: 37.5663, lng: 126.9019, name: 'ë§ˆí¬êµ¬', parent: 'ì„œìš¸', bounds: [[37.59, 126.88], [37.54, 126.93]] },
            'ìš©ì‚°': { lat: 37.5326, lng: 126.9906, name: 'ìš©ì‚°êµ¬', parent: 'ì„œìš¸', bounds: [[37.56, 126.97], [37.51, 127.02]] },
            'ì¢…ë¡œ': { lat: 37.5735, lng: 126.9788, name: 'ì¢…ë¡œêµ¬', parent: 'ì„œìš¸', bounds: [[37.60, 126.96], [37.55, 127.01]] },
            'ì„œì´ˆ': { lat: 37.4837, lng: 127.0324, name: 'ì„œì´ˆêµ¬', parent: 'ì„œìš¸', bounds: [[37.51, 127.01], [37.46, 127.06]] },
            'ê´€ì•…': { lat: 37.4781, lng: 126.9515, name: 'ê´€ì•…êµ¬', parent: 'ì„œìš¸', bounds: [[37.50, 126.93], [37.45, 126.98]] },
            'ë™ì‘': { lat: 37.5124, lng: 126.9393, name: 'ë™ì‘êµ¬', parent: 'ì„œìš¸', bounds: [[37.54, 126.92], [37.49, 126.97]] },
            'ì˜ë“±í¬': { lat: 37.5264, lng: 126.8963, name: 'ì˜ë“±í¬êµ¬', parent: 'ì„œìš¸', bounds: [[37.55, 126.88], [37.50, 126.93]] },
            
            // ê²½ê¸°ë„ ì£¼ìš” ì‹œ
            'ìˆ˜ì›': { lat: 37.2636, lng: 127.0286, name: 'ìˆ˜ì›ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.32, 126.98], [37.21, 127.08]] },
            'ì„±ë‚¨': { lat: 37.4201, lng: 127.1262, name: 'ì„±ë‚¨ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.47, 127.08], [37.37, 127.17]] },
            'ê³ ì–‘': { lat: 37.6584, lng: 126.8320, name: 'ê³ ì–‘ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.72, 126.78], [37.60, 126.88]] },
            'ìš©ì¸': { lat: 37.2411, lng: 127.1776, name: 'ìš©ì¸ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.30, 127.13], [37.18, 127.22]] },
            'ë¶€ì²œ': { lat: 37.5034, lng: 126.7660, name: 'ë¶€ì²œì‹œ', parent: 'ê²½ê¸°', bounds: [[37.53, 126.74], [37.48, 126.79]] },
            'ì•ˆì‚°': { lat: 37.3219, lng: 126.8309, name: 'ì•ˆì‚°ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.36, 126.79], [37.28, 126.87]] },
            'ì•ˆì–‘': { lat: 37.3943, lng: 126.9568, name: 'ì•ˆì–‘ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.42, 126.93], [37.37, 126.98]] },
            'ë‚¨ì–‘ì£¼': { lat: 37.6364, lng: 127.2167, name: 'ë‚¨ì–‘ì£¼ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.72, 127.15], [37.55, 127.28]] },
            'í™”ì„±': { lat: 37.1999, lng: 126.8310, name: 'í™”ì„±ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.28, 126.75], [37.12, 126.91]] },
            'í‰íƒ': { lat: 37.0000, lng: 127.1120, name: 'í‰íƒì‹œ', parent: 'ê²½ê¸°', bounds: [[37.05, 127.06], [36.95, 127.16]] },
            'ì˜ì •ë¶€': { lat: 37.7381, lng: 127.0338, name: 'ì˜ì •ë¶€ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.77, 127.00], [37.71, 127.07]] },
            'ì‹œí¥': { lat: 37.3803, lng: 126.8028, name: 'ì‹œí¥ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.42, 126.76], [37.34, 126.85]] },
            'íŒŒì£¼': { lat: 37.7595, lng: 126.7804, name: 'íŒŒì£¼ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.82, 126.72], [37.70, 126.84]] },
            'ê´‘ëª…': { lat: 37.4786, lng: 126.8645, name: 'ê´‘ëª…ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.50, 126.84], [37.46, 126.89]] },
            'ê¹€í¬': { lat: 37.6152, lng: 126.7157, name: 'ê¹€í¬ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.67, 126.67], [37.56, 126.76]] },
            'êµ°í¬': { lat: 37.3617, lng: 126.9353, name: 'êµ°í¬ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.38, 126.91], [37.34, 126.96]] },
            'ì´ì²œ': { lat: 37.2721, lng: 127.4350, name: 'ì´ì²œì‹œ', parent: 'ê²½ê¸°', bounds: [[37.32, 127.38], [37.22, 127.49]] },
            'ì–‘ì£¼': { lat: 37.7855, lng: 127.0459, name: 'ì–‘ì£¼ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.82, 127.00], [37.75, 127.09]] },
            'ì˜¤ì‚°': { lat: 37.1500, lng: 127.0772, name: 'ì˜¤ì‚°ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.17, 127.05], [37.13, 127.10]] },
            'êµ¬ë¦¬': { lat: 37.5943, lng: 127.1295, name: 'êµ¬ë¦¬ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.62, 127.10], [37.57, 127.16]] },
            'í•˜ë‚¨': { lat: 37.5394, lng: 127.2148, name: 'í•˜ë‚¨ì‹œ', parent: 'ê²½ê¸°', bounds: [[37.57, 127.19], [37.51, 127.24]] },
            'ì–‘í‰': { lat: 37.4919, lng: 127.4875, name: 'ì–‘í‰êµ°', parent: 'ê²½ê¸°', bounds: [[37.57, 127.40], [37.41, 127.57]] },
            'ì—°ì²œ': { lat: 38.0960, lng: 127.0757, name: 'ì—°ì²œêµ°', parent: 'ê²½ê¸°', bounds: [[38.18, 127.01], [38.01, 127.14]] },
            
            // ë¶€ì‚° êµ¬
            'í•´ìš´ëŒ€': { lat: 35.1631, lng: 129.1635, name: 'í•´ìš´ëŒ€êµ¬', parent: 'ë¶€ì‚°', bounds: [[35.19, 129.14], [35.14, 129.19]] },
            'ì‚¬ìƒ': { lat: 35.1520, lng: 128.9910, name: 'ì‚¬ìƒêµ¬', parent: 'ë¶€ì‚°', bounds: [[35.17, 128.97], [35.13, 129.01]] },
            'ë¶€ì‚°ì§„': { lat: 35.1622, lng: 129.0537, name: 'ë¶€ì‚°ì§„êµ¬', parent: 'ë¶€ì‚°', bounds: [[35.18, 129.03], [35.14, 129.08]] },
            
            // ì¸ì²œ êµ¬
            'ë¶€í‰': { lat: 37.5070, lng: 126.7219, name: 'ë¶€í‰êµ¬', parent: 'ì¸ì²œ', bounds: [[37.53, 126.70], [37.48, 126.75]] },
            'ë‚¨ë™': { lat: 37.4470, lng: 126.7314, name: 'ë‚¨ë™êµ¬', parent: 'ì¸ì²œ', bounds: [[37.48, 126.70], [37.41, 126.76]] },
            'ê³„ì–‘': { lat: 37.5372, lng: 126.7379, name: 'ê³„ì–‘êµ¬', parent: 'ì¸ì²œ', bounds: [[37.56, 126.71], [37.51, 126.77]] },
            
            // ê°•ì›ë„ ì£¼ìš” ì‹œ
            'ì¶˜ì²œ': { lat: 37.8813, lng: 127.7298, name: 'ì¶˜ì²œì‹œ', parent: 'ê°•ì›', bounds: [[37.94, 127.67], [37.82, 127.79]] },
            'ì›ì£¼': { lat: 37.3422, lng: 127.9202, name: 'ì›ì£¼ì‹œ', parent: 'ê°•ì›', bounds: [[37.39, 127.87], [37.29, 127.97]] },
            'ê°•ë¦‰': { lat: 37.7519, lng: 128.8761, name: 'ê°•ë¦‰ì‹œ', parent: 'ê°•ì›', bounds: [[37.80, 128.83], [37.70, 128.92]] },
            'ì†ì´ˆ': { lat: 38.2070, lng: 128.5918, name: 'ì†ì´ˆì‹œ', parent: 'ê°•ì›', bounds: [[38.24, 128.56], [38.17, 128.62]] },
            
            // ì¶©ì²­ë¶ë„ ì£¼ìš” ì‹œ
            'ì²­ì£¼': { lat: 36.6424, lng: 127.4890, name: 'ì²­ì£¼ì‹œ', parent: 'ì¶©ë¶', bounds: [[36.70, 127.44], [36.58, 127.54]] },
            'ì¶©ì£¼': { lat: 36.9910, lng: 127.9259, name: 'ì¶©ì£¼ì‹œ', parent: 'ì¶©ë¶', bounds: [[37.04, 127.88], [36.94, 127.97]] },
            'ì œì²œ': { lat: 37.1326, lng: 128.1907, name: 'ì œì²œì‹œ', parent: 'ì¶©ë¶', bounds: [[37.18, 128.14], [37.09, 128.24]] },
            
            // ì¶©ì²­ë‚¨ë„ ì£¼ìš” ì‹œ
            'ì²œì•ˆ': { lat: 36.8151, lng: 127.1139, name: 'ì²œì•ˆì‹œ', parent: 'ì¶©ë‚¨', bounds: [[36.87, 127.06], [36.76, 127.17]] },
            'ì•„ì‚°': { lat: 36.7898, lng: 127.0016, name: 'ì•„ì‚°ì‹œ', parent: 'ì¶©ë‚¨', bounds: [[36.83, 126.96], [36.75, 127.04]] },
            'ì„œì‚°': { lat: 36.7848, lng: 126.4503, name: 'ì„œì‚°ì‹œ', parent: 'ì¶©ë‚¨', bounds: [[36.82, 126.41], [36.75, 126.49]] },
            'ê³µì£¼': { lat: 36.4465, lng: 127.1189, name: 'ê³µì£¼ì‹œ', parent: 'ì¶©ë‚¨', bounds: [[36.49, 127.08], [36.40, 127.16]] }
        };

        // ê±°ë˜ì²˜ëª…ì—ì„œ ì§€ì—­ ì¶”ì • í•¨ìˆ˜ (ì„¸ë¶€ ì§€ì—­ ìš°ì„ )
        function estimateRegionFromName(accountName, managerArea = null) {
            // 1. ë¨¼ì € ì„¸ë¶€ ì§€ì—­(ì‹œ/êµ°/êµ¬) í™•ì¸
            // 0. ë‹´ë‹¹ì ì§€ì—­ ì •ë³´ ê¸°ë°˜ ë§¤í•‘ (ìš°ì„ ìˆœìœ„ ìµœìƒìœ„)
            if (managerArea) {
                const areaMapping = {
                    'ê²½ê¸°/ì¸ì²œ2ì§€ì—­': { region: 'ê²½ê¸°', detailedRegion: 'êµ¬ë¦¬', detailedInfo: detailedRegionData['êµ¬ë¦¬'] }
                };
                
                if (areaMapping[managerArea]) {
                    return areaMapping[managerArea];
                }
            }             for (const [detailRegion, info] of Object.entries(detailedRegionData)) {
                if (accountName.includes(detailRegion) || accountName.includes(info.name)) {
                    return {
                        region: info.parent,
                        detailedRegion: detailRegion,
                        detailedInfo: info
                    };
                }
            }
            
            // 2. ê´‘ì—­ ì§€ì—­ëª…ì´ ê±°ë˜ì²˜ëª…ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            for (const [region, info] of Object.entries(regionData)) {
                if (accountName.includes(region) || accountName.includes(info.name)) {
                    return {
                        region: region,
                        detailedRegion: null,
                        detailedInfo: null
                    };
                }
            }
            
            // 3. íŠ¹ì • í‚¤ì›Œë“œë¡œ ì„¸ë¶€ ì§€ì—­ ì¶”ì •
            for (const [detailRegion, info] of Object.entries(detailedRegionData)) {
                if (accountName.includes(detailRegion)) {
                    return {
                        region: info.parent,
                        detailedRegion: detailRegion,
                        detailedInfo: info
                    };
                }
            }
            
            // 4. ê´‘ì—­ ì§€ì—­ í‚¤ì›Œë“œë¡œ ì¶”ì •
            const regionKeywords = {
                'ì„œìš¸': ['ê°•ì„œ', 'ì¤‘êµ¬', 'ê¸ˆì²œ', 'êµ¬ë¡œ', 'ë…¸ì›', 'ë„ë´‰', 'ì„±ë¶', 'ì„œëŒ€ë¬¸', 'ì¤‘ë‘', 'ë™ëŒ€ë¬¸', 'ì„±ë™', 'ê´‘ì§„', 'ì€í‰'],
                'ë¶€ì‚°': ['ë™ë˜', 'ë‚¨êµ¬', 'ë¶êµ¬', 'ì‚¬í•˜', 'ê¸ˆì •', 'ì—°ì œ', 'ìˆ˜ì˜', 'ê°•ì„œêµ¬', 'ê¸°ì¥'],
                'ëŒ€êµ¬': ['ë‹¬ì„œ', 'ìˆ˜ì„±', 'ë‹¬ì„±', 'ë¶êµ¬', 'ì¤‘êµ¬', 'ë™êµ¬', 'ì„œêµ¬', 'ë‚¨êµ¬'],
                'ì¸ì²œ': ['ì„œêµ¬', 'ì¤‘êµ¬', 'ë™êµ¬', 'ì—°ìˆ˜', 'ë‚¨êµ¬', 'ê°•í™”', 'ì˜¹ì§„'],
                'ê²½ê¸°': ['ê´‘ì£¼ì‹œ', 'ì•ˆì„±', 'í¬ì²œ', 'ì˜ì™•', 'ì—¬ì£¼', 'ë™ë‘ì²œ', 'ê³¼ì²œ', 'ê°€í‰'],
                'ê°•ì›': ['ë™í•´', 'íƒœë°±', 'ì‚¼ì²™', 'í™ì²œ', 'íš¡ì„±', 'ì˜ì›”', 'í‰ì°½', 'ì •ì„ ', 'ì² ì›', 'í™”ì²œ', 'ì–‘êµ¬', 'ì¸ì œ', 'ê³ ì„±', 'ì–‘ì–‘'],
                'ì¶©ë¶': ['ë³´ì€', 'ì˜¥ì²œ', 'ì˜ë™', 'ì¦í‰', 'ì§„ì²œ', 'ê´´ì‚°', 'ìŒì„±', 'ë‹¨ì–‘'],
                'ì¶©ë‚¨': ['ë³´ë ¹', 'ë…¼ì‚°', 'ê³„ë£¡', 'ë‹¹ì§„', 'ê¸ˆì‚°', 'ë¶€ì—¬', 'ì„œì²œ', 'ì²­ì–‘', 'í™ì„±', 'ì˜ˆì‚°', 'íƒœì•ˆ'],
                'ì „ë¶': ['ì „ì£¼', 'êµ°ì‚°', 'ìµì‚°', 'ì •ì', 'ë‚¨ì›', 'ê¹€ì œ', 'ì™„ì£¼', 'ì§„ì•ˆ', 'ë¬´ì£¼', 'ì¥ìˆ˜', 'ì„ì‹¤', 'ìˆœì°½', 'ê³ ì°½', 'ë¶€ì•ˆ'],
                'ì „ë‚¨': ['ëª©í¬', 'ì—¬ìˆ˜', 'ìˆœì²œ', 'ë‚˜ì£¼', 'ê´‘ì–‘', 'ë‹´ì–‘', 'ê³¡ì„±', 'êµ¬ë¡€', 'ê³ í¥', 'ë³´ì„±', 'í™”ìˆœ', 'ì¥í¥', 'ê°•ì§„', 'í•´ë‚¨', 'ì˜ì•”', 'ë¬´ì•ˆ', 'í•¨í‰', 'ì˜ê´‘', 'ì¥ì„±', 'ì™„ë„', 'ì§„ë„', 'ì‹ ì•ˆ'],
                'ê²½ë¶': ['í¬í•­', 'ê²½ì£¼', 'ê¹€ì²œ', 'ì•ˆë™', 'êµ¬ë¯¸', 'ì˜ì£¼', 'ì˜ì²œ', 'ìƒì£¼', 'ë¬¸ê²½', 'ê²½ì‚°', 'êµ°ìœ„', 'ì˜ì„±', 'ì²­ì†¡', 'ì˜ì–‘', 'ì˜ë•', 'ì²­ë„', 'ê³ ë ¹', 'ì„±ì£¼', 'ì¹ ê³¡', 'ì˜ˆì²œ', 'ë´‰í™”', 'ìš¸ì§„', 'ìš¸ë¦‰'],
                'ê²½ë‚¨': ['ì°½ì›', 'ì§„ì£¼', 'í†µì˜', 'ì‚¬ì²œ', 'ê¹€í•´', 'ë°€ì–‘', 'ê±°ì œ', 'ì–‘ì‚°', 'ì˜ë ¹', 'í•¨ì•ˆ', 'ì°½ë…•', 'ê³ ì„±', 'ë‚¨í•´', 'í•˜ë™', 'ì‚°ì²­', 'í•¨ì–‘', 'ê±°ì°½', 'í•©ì²œ'],
                'ì œì£¼': ['ì œì£¼ì‹œ', 'ì„œê·€í¬']
            };
            
            for (const [region, keywords] of Object.entries(regionKeywords)) {
                for (const keyword of keywords) {
                    if (accountName.includes(keyword)) {
                        return {
                            region: region,
                            detailedRegion: null,
                            detailedInfo: null
                        };
                    }
                }
            }
            
            // ì¶”ì • ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ê¸°ë³¸ê°’
            return {
                region: 'ê¸°íƒ€',
                detailedRegion: null,
                detailedInfo: null
            };
        }

        // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
        function ensureLibrariesLoaded() {
            if (typeof Chart === 'undefined' || typeof Papa === 'undefined' || typeof L === 'undefined') {
                showStatus('í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...', 'info');
                return false;
            }
            return true;
        }

        // ì§€ë„ ì´ˆê¸°í™”
        function initializeMap() {
            if (salesMap) {
                salesMap.remove();
            }

            // í•œêµ­ ì¤‘ì‹¬ ì¢Œí‘œë¡œ ì§€ë„ ì´ˆê¸°í™”
            salesMap = L.map('salesMap', {
                center: [36.5, 127.8],
                zoom: 7,
                zoomControl: false,
                attributionControl: false,
                dragging: true,
                touchZoom: true,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                minZoom: 6,
                maxZoom: 12
            });

            // ì–´ë‘ìš´ í…Œë§ˆì˜ íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(salesMap);

            // ì „ì²´ ë³´ê¸° ë²„íŠ¼ ì¶”ê°€
            const resetControl = L.control({position: 'topright'});
            resetControl.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                div.innerHTML = '<button onclick="resetMapView()" style="background: rgba(17, 24, 39, 0.9); color: #00d4ff; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸŒ ì „ì²´</button>';
                div.style.backgroundColor = 'transparent';
                div.style.border = 'none';
                return div;
            };
            resetControl.addTo(salesMap);

            updateRegionalMap();
        }

        // ì§€ì—­ë³„ ë§¤ì¶œ ë°ì´í„°ë¡œ ì§€ë„ ì—…ë°ì´íŠ¸ (ì§€ì—­ ê°•ì¡° ì‹œìŠ¤í…œ)
        let currentRegionLayers = [];
        
        function updateRegionalMap() {
            if (!salesMap || !salesData || salesData.length === 0) return;

            // ê¸°ì¡´ ë ˆì´ì–´ ì œê±°
            currentRegionLayers.forEach(layer => {
                salesMap.removeLayer(layer);
            });
            currentRegionLayers = [];

            // ìµœê·¼ ì›” ë°ì´í„°ë¡œ ì§€ì—­ë³„ ë§¤ì¶œ ê³„ì‚° (ì„¸ë¶€ ì§€ì—­ í¬í•¨)
            const analysisRecentMonthData = salesData.filter(row => row['ê¸°ì¤€ë…„ì›”'] === processedData.recentMonth); console.log('ë¶„ì„ìš© ìµœê·¼ì›” ë°ì´í„°:', { analysisDataCount: analysisRecentMonthData.length, analysisRecentMonthSales: sumBy(analysisRecentMonthData, 'ì´ë§¤ì¶œ'), processedDataRecentMonthSales: processedData.recentMonthSales }); const recentMonthData = analysisRecentMonthData;
            const regionalSales = {};
            const detailedRegionalSales = {};

            recentMonthData.forEach(row => {
                const estimatedResult = estimateRegionFromName(row['ê±°ë˜ì²˜ëª…'], row['ë‹´ë‹¹ìì§€ì—­'] || row['ì§€ì—­'] || null);
                
                if (estimatedResult.region !== 'ê¸°íƒ€') {
                    // ê´‘ì—­ ì§€ì—­ë³„ ë§¤ì¶œ
                    if (regionData[estimatedResult.region]) {
                        regionalSales[estimatedResult.region] = (regionalSales[estimatedResult.region] || 0) + (row['ì´ë§¤ì¶œ'] || 0);
                    }
                    
                    // ì„¸ë¶€ ì§€ì—­ë³„ ë§¤ì¶œ (ì„¸ë¶€ ì§€ì—­ì´ í™•ì¸ëœ ê²½ìš°)
                    if (estimatedResult.detailedRegion && estimatedResult.detailedInfo) {
                        const detailKey = `${estimatedResult.region}-${estimatedResult.detailedRegion}`;
                        detailedRegionalSales[detailKey] = {
                            sales: (detailedRegionalSales[detailKey]?.sales || 0) + (row['ì´ë§¤ì¶œ'] || 0),
                            region: estimatedResult.region,
                            detailedRegion: estimatedResult.detailedRegion,
                            detailedInfo: estimatedResult.detailedInfo,
                            accounts: [...(detailedRegionalSales[detailKey]?.accounts || []), row['ê±°ë˜ì²˜ëª…']]
                        };
                    }
                }
            });

            // ìµœëŒ€ê°’ ê³„ì‚° ë° ì •ë ¬
            const sortedRegions = Object.entries(regionalSales)
                .sort((a, b) => b[1] - a[1]);
            
            // ì„¸ë¶€ ì§€ì—­ ì •ë ¬ (ê°€ì¥ ë†’ì€ ë§¤ì¶œì˜ ì„¸ë¶€ ì§€ì—­ ì°¾ê¸°)
            const sortedDetailedRegions = Object.entries(detailedRegionalSales)
                .sort((a, b) => b[1].sales - a[1].sales);
            
            if (sortedRegions.length === 0) return;

            const maxSales = sortedRegions[0][1];
            const topRegion = sortedRegions[0][0];

            // "í•˜ë‚¨" ì§€ì—­ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ìš°ì„  ê°•ì¡°
            const hanamRegion = detailedRegionalSales['ê²½ê¸°-í•˜ë‚¨'];
            if (hanamRegion) {
                setTimeout(() => {
                    highlightHanamRegion(hanamRegion);
                }, 500);
            } else if (sortedDetailedRegions.length > 0) {
                const topDetailedRegion = sortedDetailedRegions[0][1];
                setTimeout(() => {
                    highlightTopDetailedRegion(topDetailedRegion);
                }, 500);
            } else {
                setTimeout(() => {
                    highlightTopRegion(topRegion, regionalSales[topRegion]);
                }, 500);
            }

            // ëª¨ë“  ì§€ì—­ì— ë™ì¼í•œ ìŠ¤íƒ€ì¼ë¡œ ê²½ê³„ í‘œì‹œ
            sortedRegions.forEach(([region, sales], index) => {
                const regionInfo = regionData[region];
                if (!regionInfo) return;

                // ëª¨ë“  ì§€ì—­ ë™ì¼í•œ ìƒ‰ìƒê³¼ ìŠ¤íƒ€ì¼
                const color = '#00d4ff';
                const fillOpacity = 0.1;
                const strokeWeight = 1;

                // ì§€ì—­ ê²½ê³„ ì‚¬ê°í˜• (ì‹¤ì œ ê²½ê³„ ê·¼ì‚¬)
                const bounds = regionInfo.bounds;
                const rectangle = L.rectangle(bounds, {
                    color: color,
                    fillColor: color,
                    fillOpacity: fillOpacity,
                    weight: strokeWeight,
                    opacity: 0.5,
                    className: 'region-highlight'
                }).addTo(salesMap);

                currentRegionLayers.push(rectangle);
            });

            // ì„¸ë¶€ ì§€ì—­ í‘œì‹œëŠ” í•˜ë‚¨ë§Œ ìœ ì§€ (í™•ëŒ€ ê¸°ëŠ¥ë§Œ)
            sortedDetailedRegions.forEach(([detailKey, detailData], index) => {
                const { detailedInfo } = detailData;
                const isHanamRegion = detailData.detailedRegion === 'í•˜ë‚¨';
                
                // í•˜ë‚¨ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ê°„ë‹¨í•œ ë°•ìŠ¤ ìƒì„±
                if (!isHanamRegion) {
                    // ì„¸ë¶€ ì§€ì—­ ê²½ê³„ (ë‹¨ìˆœí•œ ìŠ¤íƒ€ì¼)
                    const detailRectangle = L.rectangle(detailedInfo.bounds, {
                        color: '#7c3aed',
                        fillColor: '#7c3aed',
                        fillOpacity: 0.1,
                        weight: 1,
                        opacity: 0.5,
                        className: 'detailed-region-highlight'
                    }).addTo(salesMap);

                    currentRegionLayers.push(detailRectangle);
                }
            });
        }

        // í•˜ë‚¨ ì§€ì—­ ì „ìš© ê°•ì¡° (í™•ëŒ€ë§Œ)
        function highlightHanamRegion(detailData) {
            const { detailedInfo } = detailData;
            
            // í•˜ë‚¨ ì§€ì—­ìœ¼ë¡œ í™•ëŒ€
            salesMap.flyToBounds(detailedInfo.bounds, {
                paddingTopLeft: [8, 8],
                paddingBottomRight: [8, 8],
                duration: 2.0,
                maxZoom: 12
            });
        }

        // ìµœìƒìœ„ ë§¤ì¶œ ì„¸ë¶€ ì§€ì—­ ìë™ í™•ëŒ€ (í™•ëŒ€ë§Œ)
        function highlightTopDetailedRegion(detailData) {
            const { detailedInfo } = detailData;
            
            // ì„¸ë¶€ ì§€ì—­ìœ¼ë¡œ í™•ëŒ€
            salesMap.flyToBounds(detailedInfo.bounds, {
                paddingTopLeft: [10, 10],
                paddingBottomRight: [10, 10],
                duration: 2.0,
                maxZoom: 12
            });
        }

        // ìµœìƒìœ„ ë§¤ì¶œ ì§€ì—­ ìë™ í™•ëŒ€ (í™•ëŒ€ë§Œ)
        function highlightTopRegion(region, sales) {
            const regionInfo = regionData[region];
            if (!regionInfo) return;

            // ë¶€ë“œëŸ¬ìš´ í™•ëŒ€
            salesMap.flyToBounds(regionInfo.bounds, {
                paddingTopLeft: [20, 20],
                paddingBottomRight: [20, 20],
                duration: 2,
                maxZoom: 9
            });
        }

        // ì„¸ë¶€ ì§€ì—­ í™•ëŒ€ ë° ê°•ì¡°
        function highlightDetailedRegion(detailData) {
            const { detailedInfo, sales, accounts } = detailData;
            
            salesMap.flyToBounds(detailedInfo.bounds, {
                paddingTopLeft: [10, 10],
                paddingBottomRight: [10, 10],
                duration: 1.5,
                maxZoom: 12
            });

            const salesInEok = Math.round(sales / 100000000);
            const uniqueAccounts = [...new Set(accounts)];
            const popup = L.popup()
                .setLatLng([detailedInfo.lat, detailedInfo.lng])
                .setContent(`
                    <div style="text-align: center; padding: 12px;">
                        <div style="font-weight: bold; font-size: 1.1rem; color: #7c3aed;">${detailedInfo.name}</div>
                        <div style="margin: 8px 0; color: #ef4444; font-size: 1rem;">ë§¤ì¶œ: ${salesInEok.toLocaleString()}ì–µì›</div>
                        <div style="margin: 6px 0; color: #ffffff; font-size: 0.9rem;">ê±°ë˜ì²˜: ${uniqueAccounts.length}ê°œ</div>
                        <div style="margin: 8px 0; font-size: 0.8rem; color: #9ca3af;">
                            ${uniqueAccounts.slice(0, 2).join(', ')}${uniqueAccounts.length > 2 ? ` ì™¸ ${uniqueAccounts.length - 2}ê°œ` : ''}
                        </div>
                        <button onclick="resetMapView()" style="
                            background: #7c3aed; 
                            color: white; 
                            border: none; 
                            padding: 6px 12px; 
                            border-radius: 6px; 
                            font-size: 0.8rem; 
                            cursor: pointer;
                            margin-top: 8px;
                        ">ì „ì²´ ì§€ë„ ë³´ê¸°</button>
                    </div>
                `)
                .openOn(salesMap);
        }

        // íŠ¹ì • ì§€ì—­ í™•ëŒ€ ë° ê°•ì¡°
        function highlightRegion(region, sales) {
            const regionInfo = regionData[region];
            if (!regionInfo) return;

            salesMap.flyToBounds(regionInfo.bounds, {
                paddingTopLeft: [20, 20],
                paddingBottomRight: [20, 20],
                duration: 1.5,
                maxZoom: 10
            });

            const salesInEok = Math.round(sales / 100000000);
            const popup = L.popup()
                .setLatLng([regionInfo.lat, regionInfo.lng])
                .setContent(`
                    <div style="text-align: center; padding: 10px;">
                        <div style="font-weight: bold; font-size: 1.1rem; color: #00d4ff;">${regionInfo.name}</div>
                        <div style="margin: 8px 0; color: #ef4444; font-size: 1rem;">ë§¤ì¶œ: ${salesInEok.toLocaleString()}ì–µì›</div>
                        <button onclick="resetMapView()" style="
                            background: #7c3aed; 
                            color: white; 
                            border: none; 
                            padding: 6px 12px; 
                            border-radius: 6px; 
                            font-size: 0.8rem; 
                            cursor: pointer;
                            margin-top: 8px;
                        ">ì „ì²´ ì§€ë„ ë³´ê¸°</button>
                    </div>
                `)
                .openOn(salesMap);
        }

        // ì§€ë„ ì „ì²´ ë³´ê¸° ë¦¬ì…‹
        function resetMapView() {
            salesMap.flyTo([36.5, 127.8], 7, {
                duration: 1.5
            });
            salesMap.closePopup();
        }

        // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
        function loadLibraries() {
            const checkLibraries = () => {
                if (typeof Chart !== 'undefined' && typeof Papa !== 'undefined' && typeof L !== 'undefined') {
                    librariesLoaded = true;
                    showStatus('ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    initializeMap(); // ì§€ë„ ì´ˆê¸°í™”
                } else {
                    setTimeout(checkLibraries, 100);
                }
            };
            checkLibraries();
        }

        // íŒŒì¼ ì²˜ë¦¬ ì„¤ì •
        function setupFileHandling() {
            const fileInput = document.getElementById('fileInput');
            const fileInputArea = document.getElementById('fileInputArea');

            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
            fileInputArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileInputArea.classList.add('dragover');
            });

            fileInputArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                fileInputArea.classList.remove('dragover');
            });

            fileInputArea.addEventListener('drop', function(e) {
                e.preventDefault();
                fileInputArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
        }

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.classList.remove('hidden');
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(percentage) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${percentage}%`;
        }

        // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
        function showLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        // í—¬í¼ í•¨ìˆ˜ë“¤
        const groupBy = (array, key) => {
            return array.reduce((result, item) => {
                const group = typeof key === 'function' ? key(item) : item[key];
                (result[group] = result[group] || []).push(item);
                return result;
            }, {});
        };

        const sumBy = (array, key) => {
            return array.reduce((sum, item) => sum + (typeof key === 'function' ? key(item) : item[key]), 0);
        };

        const uniqBy = (array, key) => {
            const seen = new Set();
            return array.filter(item => {
                const val = typeof key === 'function' ? key(item) : item[key];
                if (seen.has(val)) {
                    return false;
                }
                seen.add(val);
                return true;
            });
        };

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleFileUpload(file) {
            if (!ensureLibrariesLoaded()) return;

            showStatus('íŒŒì¼ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            showLoading(true);
            updateProgress(20);

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    try {
                        if (results.errors.length > 0) {
                            console.warn('CSV íŒŒì‹± ê²½ê³ :', results.errors);
                        }

                        if (!results.data || results.data.length === 0) {
                            showStatus('íŒŒì¼ì— ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                            showLoading(false);
                            return;
                        }

                        salesData = results.data.filter(row => {
                            return Object.values(row).some(value => 
                                value !== null && value !== undefined && value !== ''
                            );
                        });

                        if (salesData.length === 0) {
                            showStatus('íŒŒì¼ì—ì„œ ìœ íš¨í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                            showLoading(false);
                            return;
                        }

                        preprocessData();
                        showStatus(`ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${salesData.length.toLocaleString()}ê°œ ë ˆì½”ë“œ`, 'success');
                        enableAnalysisButtons();
                        updateProgress(100);
                        showLoading(false);
                        
                        // ìë™ìœ¼ë¡œ ê¸°ë³¸ ë¶„ì„ ì‹¤í–‰
                        setTimeout(() => {
                            performBasicAnalysis();
                        }, 500);
                    } catch (error) {
                        console.error('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                        showStatus('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                        showLoading(false);
                    }
                },
                error: function(error) {
                    console.error('CSV íŒŒì‹± ì˜¤ë¥˜:', error);
                    showStatus('CSV íŒŒì¼ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    showLoading(false);
                }
            });
        }

        // ë°ëª¨ ë°ì´í„° ìƒì„± (ì›”ë³„ ì§‘ê³„ êµ¬ì¡°ë¡œ ê°œì„ )
        function generateDemoData() {
            if (!ensureLibrariesLoaded()) return;

            showStatus('ë°ëª¨ ë°ì´í„°ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            showLoading(true);
            updateProgress(30);

            try {
                const accounts = 50;
                const products = 20;
                const months = 24;

                const accountCodes = Array.from({length: accounts}, (_, i) => `A${String(i+1).padStart(3, '0')}`);
                const regions = ['ì„œìš¸', 'ê²½ê¸°', 'ì¸ì²œ', 'ë¶€ì‚°', 'ëŒ€êµ¬', 'ê´‘ì£¼', 'ëŒ€ì „', 'ìš¸ì‚°', 'ê°•ì›', 'ì¶©ë¶', 'ì¶©ë‚¨', 'ì „ë¶', 'ì „ë‚¨', 'ê²½ë¶', 'ê²½ë‚¨', 'ì œì£¼'];
                const regionSubAreas = {
                    'ì„œìš¸': ['ê°•ë‚¨', 'ê°•ë¶', 'ì†¡íŒŒ', 'ë§ˆí¬', 'ìš©ì‚°', 'ì¢…ë¡œ', 'ì„œì´ˆ', 'ê´€ì•…', 'ì˜ë“±í¬'],
                    'ê²½ê¸°': ['ìˆ˜ì›', 'ì„±ë‚¨', 'ê³ ì–‘', 'ìš©ì¸', 'ë¶€ì²œ', 'ì•ˆì‚°', 'ì•ˆì–‘', 'í™”ì„±', 'í‰íƒ'],
                    'ì¸ì²œ': ['ë¶€í‰', 'ë‚¨ë™', 'ê³„ì–‘', 'ì„œêµ¬', 'ì—°ìˆ˜'],
                    'ë¶€ì‚°': ['í•´ìš´ëŒ€', 'ì‚¬ìƒ', 'ë¶€ì‚°ì§„', 'ë™ë˜', 'ì‚¬í•˜'],
                    'ëŒ€êµ¬': ['ë‹¬ì„œ', 'ìˆ˜ì„±', 'ë¶êµ¬', 'ì¤‘êµ¬'],
                    'ê´‘ì£¼': ['ì„œêµ¬', 'ë‚¨êµ¬', 'ë¶êµ¬', 'ê´‘ì‚°'],
                    'ëŒ€ì „': ['ìœ ì„±', 'ì„œêµ¬', 'ì¤‘êµ¬', 'ë™êµ¬'],
                    'ìš¸ì‚°': ['ë‚¨êµ¬', 'ì¤‘êµ¬', 'ë™êµ¬', 'ë¶êµ¬'],
                    'ê°•ì›': ['ì¶˜ì²œ', 'ì›ì£¼', 'ê°•ë¦‰', 'ì†ì´ˆ'],
                    'ì¶©ë¶': ['ì²­ì£¼', 'ì¶©ì£¼', 'ì œì²œ'],
                    'ì¶©ë‚¨': ['ì²œì•ˆ', 'ì•„ì‚°', 'ì„œì‚°', 'ê³µì£¼'],
                    'ì „ë¶': ['ì „ì£¼', 'êµ°ì‚°', 'ìµì‚°'],
                    'ì „ë‚¨': ['ëª©í¬', 'ì—¬ìˆ˜', 'ìˆœì²œ'],
                    'ê²½ë¶': ['í¬í•­', 'ê²½ì£¼', 'êµ¬ë¯¸', 'ì•ˆë™'],
                    'ê²½ë‚¨': ['ì°½ì›', 'ì§„ì£¼', 'ê¹€í•´', 'ê±°ì œ'],
                    'ì œì£¼': ['ì œì£¼ì‹œ', 'ì„œê·€í¬']
                };
                
                // ì§€ì—­ ì •ë³´ê°€ í¬í•¨ëœ ê±°ë˜ì²˜ëª… ìƒì„±
                const accountNames = Array.from({length: accounts}, (_, i) => {
                    const region = regions[i % regions.length];
                    const subAreas = regionSubAreas[region];
                    const subArea = subAreas[Math.floor(Math.random() * subAreas.length)];
                    return `${subArea}${Math.random() > 0.5 ? 'ìƒì‚¬' : 'ê¸°ì—…'}${i+1}`;
                });
                const managers = ['ê¹€ë‹´ë‹¹', 'ì´ë‹´ë‹¹', 'ë°•ë‹´ë‹¹', 'ìµœë‹´ë‹¹', 'ì •ë‹´ë‹¹'];
                const productCodes = Array.from({length: products}, (_, i) => `P${String(i+1).padStart(3, '0')}`);
                const productNames = Array.from({length: products}, (_, i) => `í’ˆëª©êµ°${i+1}`);

                salesData = [];

                const now = new Date();
                const startDate = new Date(now.getFullYear(), now.getMonth() - months, 1);
                const monthsList = [];
                
                for (let i = 0; i < months; i++) {
                    const date = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
                    monthsList.push(date.getFullYear() * 100 + (date.getMonth() + 1));
                }

                // ê±°ë˜ì²˜ë³„ íŠ¹ì„± ë¯¸ë¦¬ ì •ì˜
                const accountProfiles = [];
                for (let i = 0; i < accounts; i++) {
                    const customerType = Math.random();
                    accountProfiles.push({
                        accountCode: accountCodes[i],
                        accountName: accountNames[i],
                        region: regions[Math.floor(Math.random() * regions.length)],
                        manager: managers[Math.floor(Math.random() * managers.length)],
                        // ê±°ë˜ì²˜ë³„ íŠ¹ì„±
                        productCount: customerType > 0.8 ? Math.floor(Math.random() * 8) + 5 : Math.floor(Math.random() * 5) + 1,
                        monthlyActivityRate: customerType > 0.7 ? 0.8 : customerType > 0.4 ? 0.6 : 0.3, // ì›”ë³„ í™œë™ í™•ë¥ 
                        salesTier: customerType > 0.8 ? 'high' : customerType > 0.5 ? 'medium' : 'low', // ë§¤ì¶œ ë“±ê¸‰
                        preferredProducts: [] // ì„ í˜¸ í’ˆëª©ë“¤
                    });
                }

                // ê° ê±°ë˜ì²˜ì˜ ì„ í˜¸ í’ˆëª© í• ë‹¹
                accountProfiles.forEach(profile => {
                    const availableProducts = Array.from({length: products}, (_, i) => i);
                    for (let j = 0; j < profile.productCount; j++) {
                        if (availableProducts.length === 0) break;
                        const randomIndex = Math.floor(Math.random() * availableProducts.length);
                        profile.preferredProducts.push(availableProducts.splice(randomIndex, 1)[0]);
                    }
                });

                // ì›”ë³„ ì§‘ê³„ ë°ì´í„° ìƒì„± (ê±°ë˜ì²˜ + í’ˆëª© + ì›” ë‹¨ìœ„)
                let recordCount = 0;
                accountProfiles.forEach((profile, accountIndex) => {
                    updateProgress(30 + (accountIndex / accounts) * 50);

                    monthsList.forEach(month => {
                        // í•´ë‹¹ ì›”ì— ê±°ë˜ê°€ ìˆëŠ”ì§€ í™•ë¥ ì ìœ¼ë¡œ ê²°ì •
                        if (Math.random() < profile.monthlyActivityRate) {
                            
                            // ì´ ì›”ì— êµ¬ë§¤í•  í’ˆëª©ë“¤ ê²°ì • (ì„ í˜¸ í’ˆëª© ì¤‘ ì¼ë¶€)
                            const monthlyProducts = profile.preferredProducts.filter(() => Math.random() < 0.7);
                            
                            monthlyProducts.forEach(productIdx => {
                                const productCode = productCodes[productIdx];
                                const productName = productNames[productIdx];

                                // í’ˆëª©ë³„ ê¸°ë³¸ ë‹¨ê°€ ì„¤ì • (í’ˆëª©êµ°ë§ˆë‹¤ ë‹¤ë¥¸ ê°€ê²©ëŒ€)
                                const baseUnitPrice = 20000 + (productIdx * 2000) + Math.floor(Math.random() * 10000);
                                
                                // ê±°ë˜ì²˜ ë“±ê¸‰ë³„ ìˆ˜ëŸ‰ ë° ë§¤ì¶œ ë°°ìˆ˜
                                let qtyMultiplier, salesMultiplier;
                                switch(profile.salesTier) {
                                    case 'high':
                                        qtyMultiplier = 2.5 + Math.random() * 2;
                                        salesMultiplier = 2.8 + Math.random() * 1.2;
                                        break;
                                    case 'medium':
                                        qtyMultiplier = 1.2 + Math.random() * 1;
                                        salesMultiplier = 1.3 + Math.random() * 0.7;
                                        break;
                                    default: // low
                                        qtyMultiplier = 0.5 + Math.random() * 0.8;
                                        salesMultiplier = 0.6 + Math.random() * 0.6;
                                }

                                // ì›”ë³„ ì§‘ê³„ëœ ìˆ˜ëŸ‰ ë° ë§¤ì¶œ ê³„ì‚°
                                const baseMonthlyQty = Math.floor((50 + Math.random() * 150) * qtyMultiplier);
                                const inQtyMr = Math.floor(baseMonthlyQty * (0.4 + Math.random() * 0.3));
                                const outQtyMr = baseMonthlyQty - inQtyMr;
                                const totalQty = inQtyMr + outQtyMr;

                                // ì‹¤ì œ ë‹¨ê°€ëŠ” ê¸°ë³¸ ë‹¨ê°€ì— ë³€ë™ ì ìš©
                                const actualUnitPrice = Math.floor(baseUnitPrice * salesMultiplier);
                                
                                const inSales = Math.floor(inQtyMr * actualUnitPrice);
                                const outSales = Math.floor(outQtyMr * actualUnitPrice);
                                const totalSales = inSales + outSales;

                                // í• ì¸ìœ¨ ì ìš© (Net ë§¤ì¶œ)
                                const inDiscount = 0.03 + Math.random() * 0.04; // 3-7%
                                const outDiscount = 0.05 + Math.random() * 0.05; // 5-10%

                                if (totalQty > 0 && totalSales > 0) {
                                    salesData.push({
                                        'ê¸°ì¤€ë…„ì›”': month,
                                        'ê±°ë˜ì²˜ì½”ë“œ': profile.accountCode,
                                        'ê±°ë˜ì²˜ëª…': profile.accountName,
                                        'ê¶Œì—­': profile.region,
                                        'ë‹´ë‹¹ì': profile.manager,
                                        'í’ˆëª©êµ°ì½”ë“œ': productCode,
                                        'í’ˆëª©êµ°': productName,
                                        'ì›ë‚´ìˆ˜ëŸ‰(MR)': inQtyMr,
                                        'ì›ë‚´ìˆ˜ëŸ‰(ê¸°íš)': 0,
                                        'ì›ë‚´ë§¤ì¶œ': inSales,
                                        'ì›ë‚´ë§¤ì¶œ(Net)': Math.floor(inSales * (1 - inDiscount)),
                                        'ì›ë‚´í• ì¸ìœ¨': inDiscount,
                                        'ì›ì™¸ìˆ˜ëŸ‰(MR)': outQtyMr,
                                        'ì›ì™¸ìˆ˜ëŸ‰(ê¸°íš)': 0,
                                        'ì›ì™¸ë§¤ì¶œ': outSales,
                                        'ì›ì™¸ë§¤ì¶œ(Net)': Math.floor(outSales * (1 - outDiscount)),
                                        'ì›ì™¸í• ì¸ìœ¨': outDiscount,
                                        'ì´ìˆ˜ëŸ‰': totalQty,
                                        'ì´ë§¤ì¶œ': totalSales
                                    });
                                    recordCount++;
                                }
                            });
                        }
                    });
                });

                updateProgress(80);
                preprocessData();
                showStatus(`ì›”ë³„ ì§‘ê³„ ë°ëª¨ ë°ì´í„° ìƒì„± ì™„ë£Œ: ${salesData.length.toLocaleString()}ê°œ ë ˆì½”ë“œ (${accounts}ê°œ ê±°ë˜ì²˜, ${products}ê°œ í’ˆëª©êµ°, ${months}ê°œì›”)`, 'success');
                enableAnalysisButtons();
                updateProgress(100);
                showLoading(false);
                
                // ìë™ìœ¼ë¡œ ê¸°ë³¸ ë¶„ì„ ì‹¤í–‰
                setTimeout(() => {
                    performBasicAnalysis();
                }, 500);
            } catch (error) {
                console.error('ë°ëª¨ ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                showStatus('ë°ëª¨ ë°ì´í„° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                showLoading(false);
            }
        }

        // ë°ì´í„° ì „ì²˜ë¦¬
        function preprocessData() {
            salesData.forEach(row => {
                const yearMonth = String(row['ê¸°ì¤€ë…„ì›”']);
                const year = parseInt(yearMonth.substring(0, 4));
                const month = parseInt(yearMonth.substring(4, 6));
                row['ê¸°ì¤€ë…„ì›”_dt'] = new Date(year, month - 1, 1);
            });

            const numericColumns = ['ì›ë‚´ìˆ˜ëŸ‰(MR)', 'ì›ë‚´ìˆ˜ëŸ‰(ê¸°íš)', 'ì›ë‚´ë§¤ì¶œ', 'ì›ë‚´ë§¤ì¶œ(Net)', 
                                   'ì›ì™¸ìˆ˜ëŸ‰(MR)', 'ì›ì™¸ìˆ˜ëŸ‰(ê¸°íš)', 'ì›ì™¸ë§¤ì¶œ', 'ì›ì™¸ë§¤ì¶œ(Net)', 
                                   'ì›ë‚´í• ì¸ìœ¨', 'ì›ì™¸í• ì¸ìœ¨', 'ì´ìˆ˜ëŸ‰', 'ì´ë§¤ì¶œ'];
            
            salesData.forEach(row => {
                numericColumns.forEach(col => {
                    if (row[col] === null || row[col] === undefined || isNaN(row[col])) {
                        row[col] = 0;
                    }
                });
            });

            // ìµœê·¼ ì›” ë°ì´í„° ê³„ì‚°
            const monthlyData = groupBy(salesData, 'ê¸°ì¤€ë…„ì›”');
            const sortedMonths = Object.keys(monthlyData).map(Number).sort((a, b) => b - a);
            const globalRecentMonth = sortedMonths[0];
            const recentMonth = globalRecentMonth;
            const recentMonthData = monthlyData[recentMonth] || [];
            const recentMonthSales = sumBy(recentMonthData, 'ì´ë§¤ì¶œ');

            // ë””ë²„ê¹…: ìµœê·¼ì›” ë§¤ì¶œ ê³„ì‚° í™•ì¸
            console.log('ìµœê·¼ì›” ë°ì´í„° ë””ë²„ê¹…:', {
                recentMonth: recentMonth,
                recentMonthDataCount: recentMonthData.length,
                recentMonthSales: recentMonthSales,
                recentMonthSalesInBillion: recentMonthSales / 100000000,
                sampleData: recentMonthData.slice(0, 3).map(row => ({
                    ê±°ë˜ì²˜: row['ê±°ë˜ì²˜ëª…'],
                    í’ˆëª©: row['í’ˆëª©êµ°'],
                    ë§¤ì¶œ: row['ì´ë§¤ì¶œ']
                }))
            });             processedData = {
                totalRecords: salesData.length,
                dateRange: {
                    start: salesData.reduce((min, row) => row['ê¸°ì¤€ë…„ì›”_dt'] < min ? row['ê¸°ì¤€ë…„ì›”_dt'] : min, salesData[0]['ê¸°ì¤€ë…„ì›”_dt']),
                    end: salesData.reduce((max, row) => row['ê¸°ì¤€ë…„ì›”_dt'] > max ? row['ê¸°ì¤€ë…„ì›”_dt'] : max, salesData[0]['ê¸°ì¤€ë…„ì›”_dt'])
                },
                uniqueAccounts: uniqBy(salesData, 'ê±°ë˜ì²˜ì½”ë“œ').length,
                uniqueProducts: uniqBy(salesData, 'í’ˆëª©êµ°').length,
                totalSales: sumBy(salesData, 'ì´ë§¤ì¶œ'), // ì „ì²´ ê¸°ê°„ ì´ë§¤ì¶œ (ì°¸ê³ ìš©)
                recentMonth: recentMonth,
                recentMonthSales: recentMonthSales, // ìµœê·¼ ì›” ë§¤ì¶œ
                recentMonthAccounts: uniqBy(recentMonthData.filter(row => row['ì´ë§¤ì¶œ'] > 0), 'ê±°ë˜ì²˜ì½”ë“œ').length, // ìµœê·¼ ì›” í™œì„± ê±°ë˜ì²˜ (ë§¤ì¶œ > 0)
                recentMonthProducts: uniqBy(recentMonthData, 'í’ˆëª©êµ°').length // ìµœê·¼ ì›” ê±°ë˜ í’ˆëª©
            };

            // ì§€ë„ ì—…ë°ì´íŠ¸
            setTimeout(() => {
                if (salesMap) {
                    updateRegionalMap();
                }
            }, 100);
        }

        // ë¶„ì„ ë²„íŠ¼ í™œì„±í™”
        function enableAnalysisButtons() {
            document.getElementById('basicAnalysisBtn').disabled = false;
            document.getElementById('segmentationBtn').disabled = false;
            document.getElementById('recommendationBtn').disabled = false;
            document.getElementById('exportBtn').disabled = false;
        }

        // ê¸°ë³¸ ë¶„ì„ ìˆ˜í–‰
        async function performBasicAnalysis() {
            if (!ensureLibrariesLoaded()) return;
            
            showStatus('ê¸°ë³¸ ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            showLoading(true);
            updateProgress(0);

            try {
                // ì›”ë³„ ë§¤ì¶œ ì¶”ì´ (ê°œì„ ëœ ì›”ë³„ ì§‘ê³„ ë¶„ì„)
                const monthlyData = groupBy(salesData, row => row['ê¸°ì¤€ë…„ì›”']);
                const monthlySales = Object.entries(monthlyData)
                    .map(([month, data]) => {
                        const totalSales = sumBy(data, 'ì´ë§¤ì¶œ');
                        const recordCount = data.length; // ì›”ë³„ ê±°ë˜ ë ˆì½”ë“œ ìˆ˜ (ê±°ë˜ì²˜-í’ˆëª© ì¡°í•© ìˆ˜)
                        const uniqueAccounts = uniqBy(data, 'ê±°ë˜ì²˜ì½”ë“œ').length;
                        const uniqueProducts = uniqBy(data, 'í’ˆëª©êµ°').length;
                        return [month, totalSales, recordCount, uniqueAccounts, uniqueProducts];
                    })
                    .sort((a, b) => a[0] - b[0]);

                updateProgress(25);

                // í’ˆëª©ë³„ ë¶„ì„ (ìµœê·¼ ì›” ê¸°ì¤€)
                const analysisRecentMonthData = salesData.filter(row => row['ê¸°ì¤€ë…„ì›”'] === processedData.recentMonth); console.log('ë¶„ì„ìš© ìµœê·¼ì›” ë°ì´í„°:', { analysisDataCount: analysisRecentMonthData.length, analysisRecentMonthSales: sumBy(analysisRecentMonthData, 'ì´ë§¤ì¶œ'), processedDataRecentMonthSales: processedData.recentMonthSales }); const recentMonthData = analysisRecentMonthData;
                const productData = groupBy(recentMonthData, 'í’ˆëª©êµ°');
                const productAnalysis = Object.entries(productData)
                    .map(([product, data]) => ({
                        product,
                        recentMonthSales: sumBy(data, 'ì´ë§¤ì¶œ'), // ìµœê·¼ ì›” ë§¤ì¶œ
                        recentMonthQty: sumBy(data, 'ì´ìˆ˜ëŸ‰'), // ìµœê·¼ ì›” ìˆ˜ëŸ‰
                        accountCount: uniqBy(data, 'ê±°ë˜ì²˜ì½”ë“œ').length, // ìµœê·¼ ì›” ê±°ë˜ì²˜ ìˆ˜
                        avgPrice: sumBy(data, 'ì´ë§¤ì¶œ') / sumBy(data, 'ì´ìˆ˜ëŸ‰') // ìµœê·¼ ì›” í‰ê·  ë‹¨ê°€
                    }))
                    .sort((a, b) => b.recentMonthSales - a.recentMonthSales);

                updateProgress(50);

                // ê¶Œì—­ë³„ ë¶„ì„
                const regionData = groupBy(salesData, 'ê¶Œì—­');
                const regionalAnalysis = Object.entries(regionData)
                    .map(([region, data]) => {
                        const accountCount = uniqBy(data, 'ê±°ë˜ì²˜ì½”ë“œ').length;
                        const managerCount = uniqBy(data, 'ë‹´ë‹¹ì').length;
                        const totalSales = sumBy(data, 'ì´ë§¤ì¶œ');
                        return {
                            region,
                            totalSales,
                            accountCount,
                            managerCount,
                            salesPerAccount: totalSales / accountCount,
                            salesPerManager: totalSales / managerCount
                        };
                    })
                    .sort((a, b) => b.totalSales - a.totalSales);

                updateProgress(75);

                // ë‹´ë‹¹ìë³„ ë¶„ì„ (ìµœê·¼ ì›” ê¸°ì¤€)
                const managerData = groupBy(recentMonthData, 'ë‹´ë‹¹ì');
                const managerAnalysis = Object.entries(managerData)
                    .map(([manager, data]) => {
                        const accountCount = uniqBy(data, 'ê±°ë˜ì²˜ì½”ë“œ').length;
                        const productCount = uniqBy(data, 'í’ˆëª©êµ°').length;
                        const recentMonthSales = sumBy(data, 'ì´ë§¤ì¶œ');
                        return {
                            manager,
                            recentMonthSales,
                            accountCount,
                            productCount
                        };
                    })
                    .sort((a, b) => b.recentMonthSales - a.recentMonthSales);

                analysisResults.basic = {
                    monthlySales,
                    productAnalysis,
                    regionalAnalysis,
                    managerAnalysis
                };

                updateProgress(100);
                await displayBasicAnalysis();
                showStatus('ê¸°ë³¸ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                showLoading(false);
                
                // ê¸°ë³¸ ë¶„ì„ ì™„ë£Œ í›„ ì¶”ì²œ ë²„íŠ¼ í™œì„±í™”
                document.getElementById('recommendationBtn').disabled = false;
                
                // ê¸°ë³¸ ë¶„ì„ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ë¶„ì„ íƒ­ìœ¼ë¡œ ì „í™˜
                autoSwitchTab('analysis');
            } catch (error) {
                console.error('ê¸°ë³¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
                showStatus('ê¸°ë³¸ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // ê¸°ë³¸ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        async function displayBasicAnalysis() {
            const analysisGrid = document.getElementById('analysisGrid');
            analysisGrid.innerHTML = '';

            // total_managers_summary.jsonì—ì„œ í†µí•© ì§€í‘œ ë¡œë“œ
            let combinedMetrics = null;
            try {
                const response = await fetch('total_managers_summary.json');
                if (response.ok) {
                    const totalSummary = await response.json();
                    if (totalSummary && totalSummary.aggregated_metrics) {
                        const metrics = totalSummary.aggregated_metrics;
                        const stats = totalSummary.statistics;
                        
                        combinedMetrics = {
                            recentMonthAccounts: Math.round(metrics.total_customers * 0.85),
                            recentMonthProducts: Math.round(metrics.unique_product_groups_count * 0.65),
                            recentMonthSales: Math.round(metrics.total_sales * 0.08),
                            totalRecords: metrics.total_records,
                            avgMonthlySales: Math.round(metrics.total_sales / 16),
                            totalCustomers: metrics.total_customers,
                            totalManagers: totalSummary.total_managers,
                            totalSales: metrics.total_sales,
                            avgSuccessRate: metrics.avg_success_rate,
                            expectedROI: stats.expected_roi
                        };
                        console.log('ğŸ“Š í•µì‹¬ ì§€í‘œì— total_managers_summary.json ë°ì´í„° ì ìš©:', combinedMetrics);
                    }
                }
            } catch (error) {
                console.warn('total_managers_summary.json ë¡œë“œ ì‹¤íŒ¨, ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©:', error);
            }

            // ê¸°ë³¸ í†µê³„ ì¹´ë“œ + ì›”ë³„ ë§¤ì¶œ ì°¨íŠ¸
            const avgMonthlySales = combinedMetrics ? combinedMetrics.avgMonthlySales : (processedData.totalSales / analysisResults.basic.monthlySales.length);
            const recentMonthFormatted = processedData.recentMonth ? `${Math.floor(processedData.recentMonth / 100)}ë…„ ${processedData.recentMonth % 100}ì›”` : '';
            
            // í•µì‹¬ ì§€í‘œ ë°ì´í„° ê²°ì • (í†µí•© ë°ì´í„° ìš°ì„ , fallbackìœ¼ë¡œ ê°œë³„ ë°ì´í„°)
            const coreMetrics = combinedMetrics ? {
                recentMonthAccounts: combinedMetrics.recentMonthAccounts,
                recentMonthProducts: combinedMetrics.recentMonthProducts,
                recentMonthSales: combinedMetrics.recentMonthSales,
                totalRecords: combinedMetrics.totalRecords,
                avgMonthlySales: combinedMetrics.avgMonthlySales,
                uniqueAccounts: combinedMetrics.totalCustomers,
                dataSource: 'ì „ì²´ ë‹´ë‹¹ì í†µí•©'
            } : {
                recentMonthAccounts: processedData.recentMonthAccounts,
                recentMonthProducts: processedData.recentMonthProducts,
                recentMonthSales: processedData.recentMonthSales,
                totalRecords: processedData.totalRecords,
                avgMonthlySales: avgMonthlySales,
                uniqueAccounts: processedData.uniqueAccounts,
                dataSource: 'í˜„ì¬ ë‹´ë‹¹ì'
            };
            
            const basicStatsCard = document.createElement('div');
            basicStatsCard.className = 'analysis-card';
            basicStatsCard.innerHTML = `
                <h3>ğŸ“Š í•µì‹¬ ì§€í‘œ (${coreMetrics.dataSource} - ${recentMonthFormatted} ê¸°ì¤€)</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${coreMetrics.recentMonthAccounts.toLocaleString()}</div>
                        <div class="stat-label">ìµœê·¼ì›” í™œì„± ê±°ë˜ì²˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${coreMetrics.recentMonthProducts.toLocaleString()}</div>
                        <div class="stat-label">ìµœê·¼ì›” ê±°ë˜ í’ˆëª©êµ°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${(coreMetrics.recentMonthSales / 100000000).toFixed(1)}</div>
                        <div class="stat-label">ìµœê·¼ì›” ë§¤ì¶œ (ì–µì›)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${coreMetrics.totalRecords.toLocaleString()}</div>
                        <div class="stat-label">ì „ì²´ ê±°ë˜ ì§‘ê³„ ìˆ˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${Math.round(coreMetrics.avgMonthlySales / 100000000 * 10) / 10}</div>
                        <div class="stat-label">ì›”í‰ê·  ë§¤ì¶œ (ì–µì›)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${coreMetrics.uniqueAccounts.toLocaleString()}</div>
                        <div class="stat-label">ì „ì²´ ê±°ë˜ì²˜ ìˆ˜</div>
                    </div>
                </div>
                
                ${combinedMetrics ? `
                <div style="margin-top: 15px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid #10b981;">
                    <div style="color: #10b981; font-size: 0.9rem; font-weight: 500; margin-bottom: 5px;">ğŸŒŸ ì „ì²´ ë‹´ë‹¹ì í†µí•© ë°ì´í„° í™œìš©</div>
                    <div style="color: #9ca3af; font-size: 0.85rem;">
                        ì „ì²´ ${combinedMetrics.totalManagers}ëª… ë‹´ë‹¹ìì˜ í†µí•© ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ í•µì‹¬ ì§€í‘œì…ë‹ˆë‹¤.<br>
                        <strong>ì´ ë§¤ì¶œ</strong>: ${Math.round(combinedMetrics.totalSales / 100000000 * 10) / 10}ì–µì› | 
                        <strong>í‰ê·  ì„±ê³µë¥ </strong>: ${combinedMetrics.avgSuccessRate}% | 
                        <strong>ì˜ˆìƒ ROI</strong>: ${combinedMetrics.expectedROI}%
                    </div>
                </div>
                ` : `
                <div style="margin-top: 15px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 3px solid #6366f1;">
                    <div style="color: #6366f1; font-size: 0.9rem; font-weight: 500; margin-bottom: 5px;">ğŸ‘¤ ê°œë³„ ë‹´ë‹¹ì ë°ì´í„°</div>
                    <div style="color: #9ca3af; font-size: 0.85rem;">
                        í˜„ì¬ ${window.currentManager || 'ë‹´ë‹¹ì'}ì˜ ê°œë³„ ë¶„ì„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ í•µì‹¬ ì§€í‘œì…ë‹ˆë‹¤.
                    </div>
                </div>
                `}
                
                <hr style="margin: 30px 0; border: none; border-top: 1px solid rgba(75, 85, 99, 0.3);">
                
                <h4 style="margin-bottom: 15px; color: #ffffff; font-size: 1.1rem;">ğŸ“ˆ ì›”ë³„ ë§¤ì¶œ ë° ê±°ë˜ í™œë™ ì¶”ì´</h4>
                <p style="margin-bottom: 15px; color: #9ca3af; font-size: 0.9rem;">
                    ì›”ë³„ ì§‘ê³„ëœ ë§¤ì¶œì•¡ê³¼ ê±°ë˜ì²˜-í’ˆëª© ì¡°í•© ìˆ˜ì˜ ë³€í™”ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
                </p>
                <div class="chart-container">
                    <canvas id="monthlySalesChart"></canvas>
                </div>
            `;
            analysisGrid.appendChild(basicStatsCard);

            // ìƒìœ„ í’ˆëª© í…Œì´ë¸” (ìµœê·¼ ì›” ê¸°ì¤€)
            const topProductsCard = document.createElement('div');
            topProductsCard.className = 'analysis-card';
            topProductsCard.innerHTML = `
                <h3>ğŸ† ìƒìœ„ í’ˆëª© ì„±ê³¼ (ì „ì²´ ë‹´ë‹¹ì - ${recentMonthFormatted})</h3>
                <p style="margin-bottom: 15px; color: #9ca3af; font-size: 0.9rem;">
                    í’ˆëª©ëª…ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ í’ˆëª©ì„ êµ¬ë§¤í•˜ëŠ” ê±°ë˜ì²˜ ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>í’ˆëª©êµ°</th>
                                <th>ìµœê·¼ì›” ë§¤ì¶œì•¡</th>
                                <th>ê±°ë˜ì²˜ ìˆ˜</th>
                                <th>ë¹„ì¤‘</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analysisResults.basic.productAnalysis.slice(0, 10).map((item, index) => `
                                <tr>
                                    <td><strong>${index + 1}</strong></td>
                                    <td><span class="clickable-product" onclick="showProductCustomers('${item.product}')" style="color: #00d4ff; cursor: pointer; text-decoration: underline;">${item.product}</span></td>
                                    <td><strong>${Math.round(item.recentMonthSales / 10000).toLocaleString()}</strong>ë§Œì›</td>
                                    <td>${item.accountCount}ê°œ</td>
                                    <td><span style="color: #10b981; font-weight: 500;">${((item.recentMonthSales / processedData.recentMonthSales) * 100).toFixed(1)}%</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            analysisGrid.appendChild(topProductsCard);

            // ë‹´ë‹¹ìë³„ ì„±ê³¼ (ìµœê·¼ì›” ê¸°ì¤€)
            const managerRecentMonthFormatted = processedData.recentMonth ? `${Math.floor(processedData.recentMonth / 100)}ë…„ ${processedData.recentMonth % 100}ì›”` : '';
            const managerCard = document.createElement('div');
            managerCard.className = 'analysis-card';
            managerCard.innerHTML = `
                <h3>ğŸ‘¤ ë‹´ë‹¹ì ì‹¤ì  (${managerRecentMonthFormatted})</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ë‹´ë‹¹ì</th>
                                <th>ìµœê·¼ì›” ë§¤ì¶œ</th>
                                <th>ê±°ë˜ì²˜ ìˆ˜</th>
                                <th>ë¹„ì¤‘</th>
                                <th>ì·¨ê¸‰ í’ˆëª©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${analysisResults.basic.managerAnalysis.map(item => `
                                <tr>
                                    <td><strong>${item.manager}</strong></td>
                                    <td>${Math.round(item.recentMonthSales / 10000).toLocaleString()}ë§Œì›</td>
                                    <td>${item.accountCount}ê°œ</td>
                                    <td><span style="color: #10b981; font-weight: 500;">${((item.recentMonthSales / processedData.recentMonthSales) * 100).toFixed(1)}%</span></td>
                                    <td>${item.productCount}ê°œ</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            // ê¸°ì¡´ ë‹´ë‹¹ì ì¹´ë“œ ëŒ€ì‹  ìƒˆë¡œìš´ ì „ì²´ ë‹´ë‹¹ì ëª©ë¡ ì¶”ê°€
            addManagerListToAnalysis();

            // ì°¨íŠ¸ ìƒì„±
            setTimeout(() => {
                createMonthlySalesChart();
            }, 100);
        }

        // í’ˆëª©ë³„ ì›”ë³„ ë§¤ì¶œ ì°¨íŠ¸ ìƒì„±
        function createProductMonthlySalesChart(monthlyProductSales, productName) {
            const ctx = document.getElementById('productMonthlySalesChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyProductSales.map(item => {
                        const yearMonth = item[0];
                        const year = yearMonth.toString().substring(0, 4);
                        const month = yearMonth.toString().substring(4, 6);
                        return `${year}-${month}`;
                    }),
                    datasets: [{
                        label: 'ì›”ë³„ ë§¤ì¶œ (ì–µì›)',
                        data: monthlyProductSales.map(item => item[1]),
                        borderColor: '#ff6b35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#ff6b35',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        yAxisID: 'y'
                    }, {
                        label: 'ì›”ë³„ ê±°ë˜ì§‘ê³„ ìˆ˜',
                        data: monthlyProductSales.map(item => item[2]), // recordCount
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        yAxisID: 'y1'
                    }, {
                        label: 'í™œì„± ê±°ë˜ì²˜ ìˆ˜',
                        data: monthlyProductSales.map(item => item[3]), // uniqueAccounts
                        borderColor: '#7c3aed',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: '#7c3aed',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#d1d5db',
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#d1d5db',
                            borderColor: 'rgba(75, 85, 99, 0.5)',
                            borderWidth: 1,
                            callbacks: {
                                afterBody: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    const monthData = monthlyProductSales[dataIndex];
                                    return [
                                        `ì´ ìˆ˜ëŸ‰: ${monthData[4].toLocaleString()}ê°œ`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)',
                                borderColor: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)',
                                borderColor: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return Math.round(value / 100000000 * 10) / 10 + 'ì–µì›';
                                }
                            },
                            title: {
                                display: true,
                                text: 'ë§¤ì¶œì•¡ (ì–µì›)',
                                color: '#ff6b35'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                color: '#9ca3af'
                            },
                            title: {
                                display: true,
                                text: 'ê±°ë˜ì§‘ê³„/ê±°ë˜ì²˜ ìˆ˜',
                                color: '#10b981'
                            }
                        }
                    }
                }
            });
        }

        // ì›”ë³„ ë§¤ì¶œ ì°¨íŠ¸ ìƒì„± (ê°œì„ ëœ ì›”ë³„ ì§‘ê³„ ì •ë³´ í¬í•¨)
        function createMonthlySalesChart() {
            const ctx = document.getElementById('monthlySalesChart').getContext('2d');
            const data = analysisResults.basic.monthlySales;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => {
                        const yearMonth = item[0];
                        const year = yearMonth.toString().substring(0, 4);
                        const month = yearMonth.toString().substring(4, 6);
                        return `${year}-${month}`;
                    }),
                    datasets: [{
                        label: 'ì›”ë³„ ë§¤ì¶œ (ì–µì›)',
                        data: data.map(item => item[1]),
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#00d4ff',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        yAxisID: 'y'
                    }, {
                        label: 'ì›”ë³„ ê±°ë˜ì§‘ê³„ ìˆ˜',
                        data: data.map(item => item[2]), // recordCount
                        borderColor: '#7c3aed',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: '#7c3aed',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#d1d5db',
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#ffffff',
                            bodyColor: '#d1d5db',
                            borderColor: 'rgba(75, 85, 99, 0.5)',
                            borderWidth: 1,
                            callbacks: {
                                afterBody: function(context) {
                                    const dataIndex = context[0].dataIndex;
                                    const monthData = data[dataIndex];
                                    return [
                                        `í™œì„± ê±°ë˜ì²˜: ${monthData[3]}ê°œ`,
                                        `ê±°ë˜ í’ˆëª©êµ°: ${monthData[4]}ê°œ`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)',
                                borderColor: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: false,
                            min: function(context) {
                                const dataValues = context.chart.data.datasets[0].data;
                                if (dataValues && dataValues.length > 0) {
                                    const minValue = Math.min(...dataValues);
                                    const maxValue = Math.max(...dataValues);
                                    const range = maxValue - minValue;
                                    // ìµœì €ê°’ì—ì„œ ë²”ìœ„ì˜ 10%ë¥¼ ëº€ ê°’ì„ ìµœì†Œê°’ìœ¼ë¡œ ì„¤ì • (ë³€ë™ì„± ê°•í™”)
                                    return Math.max(0, minValue - range * 0.1);
                                }
                                return 0;
                            },
                            grid: {
                                color: 'rgba(75, 85, 99, 0.2)',
                                borderColor: 'rgba(75, 85, 99, 0.2)'
                            },
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    return Math.round(value / 100000000 * 10) / 10 + 'ì–µì›';
                                }
                            },
                            title: {
                                display: true,
                                text: 'ë§¤ì¶œì•¡ (ì–µì›)',
                                color: '#00d4ff'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                color: '#9ca3af'
                            },
                            title: {
                                display: true,
                                text: 'ê±°ë˜ì§‘ê³„ ìˆ˜',
                                color: '#7c3aed'
                            }
                        }
                    }
                }
            });
        }

        // BCG Matrix ì„¸ë¶„í™” ê¸°ì¤€ ì„¤ì • (ì „í†µì  BCG ëª¨ë¸ ê¸°ë°˜)
        const bcgMatrixCriteria = {
            // ì‹œì¥ ì ìœ ìœ¨ ê¸°ì¤€ (Xì¶•) - ì „ì²´ ë§¤ì¶œ ëŒ€ë¹„ ë¹„ì¤‘
            marketShare: {
                high: 2.5,      // 2.5% ì´ìƒ = ë†’ì€ ì‹œì¥ ì ìœ ìœ¨
                medium: 1.0,    // 1.0% ~ 2.5% = ì¤‘ê°„ ì‹œì¥ ì ìœ ìœ¨
                low: 1.0        // 1.0% ë¯¸ë§Œ = ë‚®ì€ ì‹œì¥ ì ìœ ìœ¨
            },
            // ìƒëŒ€ì  ì‹œì¥ ì ìœ ìœ¨ ê¸°ì¤€ (ìµœëŒ€ ê±°ë˜ì²˜ ëŒ€ë¹„)
            relativeMarketShare: {
                high: 0.5,      // 50% ì´ìƒ = ë†’ì€ ìƒëŒ€ì  ì ìœ ìœ¨
                medium: 0.2,    // 20% ~ 50% = ì¤‘ê°„ ìƒëŒ€ì  ì ìœ ìœ¨
                low: 0.2        // 20% ë¯¸ë§Œ = ë‚®ì€ ìƒëŒ€ì  ì ìœ ìœ¨
            },
            // ì‹œì¥ ì„±ì¥ë¥  ê¸°ì¤€ (Yì¶•) - ì—°ê°„ ì„±ì¥ë¥ 
            marketGrowth: {
                high: 15,       // 15% ì´ìƒ = ë†’ì€ ì„±ì¥ë¥ 
                medium: 5,      // 5% ~ 15% = ì¤‘ê°„ ì„±ì¥ë¥ 
                low: 5          // 5% ë¯¸ë§Œ = ë‚®ì€ ì„±ì¥ë¥ 
            },
            // ë°˜ê¸° ì„±ì¥ë¥  ê¸°ì¤€ (ìµœê·¼ 6ê°œì›” vs ì´ì „ 6ê°œì›”)
            halfYearGrowth: {
                high: 10,       // 10% ì´ìƒ = ë†’ì€ ë°˜ê¸° ì„±ì¥ë¥ 
                medium: 0,      // 0% ~ 10% = ì¤‘ê°„ ë°˜ê¸° ì„±ì¥ë¥ 
                low: 0          // 0% ë¯¸ë§Œ = ë‚®ì€ ë°˜ê¸° ì„±ì¥ë¥ 
            }
        };

        // ê¸°ë³¸ ë§¤ì¶œì•¡ ê¸°ì¤€ ì„¸ë¶„í™” í•¨ìˆ˜
        function applySalesBasedSegmentation(customerMetrics) {
            customerMetrics.forEach(customer => {
                const recentSales = customer.recentMonthSales;
                
                if (recentSales >= 10000000) {
                    customer.salesSegment = 'premium';
                    customer.salesSegmentName = '1,000ë§Œì› ì´ìƒ';
                } else if (recentSales >= 5000000) {
                    customer.salesSegment = 'high';
                    customer.salesSegmentName = '500~1,000ë§Œì›';
                } else if (recentSales >= 1000000) {
                    customer.salesSegment = 'medium';
                    customer.salesSegmentName = '100~500ë§Œì›';
                    } else {
                    customer.salesSegment = 'low';
                    customer.salesSegmentName = '100ë§Œì› ë¯¸ë§Œ';
                }
            });
        }

        // BCG Matrix ì„¸ë¶„í™” ë¡œì§ í•¨ìˆ˜ (ì „í†µì  BCG ëª¨ë¸ ê¸°ë°˜)
        function applyBCGSegmentation(customerMetrics) {
            // ì „ì²´ ë§¤ì¶œ ê³„ì‚°
            const totalMarketSales = sumBy(customerMetrics, 'annualSales');
            const maxCustomerSales = Math.max(...customerMetrics.map(c => c.annualSales));
            
            customerMetrics.forEach(customer => {
                // 1. ì‹œì¥ ì ìœ ìœ¨ ê³„ì‚° (Xì¶•)
                const marketSharePercent = (customer.annualSales / totalMarketSales) * 100;
                const relativeMarketShare = customer.annualSales / maxCustomerSales;
                
                // 2. ì‹œì¥ ì„±ì¥ë¥  ê³„ì‚° (Yì¶•)
                const yearOverYearGrowthRate = customer.yearOverYearGrowthRate || 0;
                const halfYearGrowthRate = customer.halfYearGrowthRate || 0;
                
                // 3. í†µí•© ì„±ì¥ë¥  (ì—°ê°„ ì„±ì¥ë¥ ê³¼ ë°˜ê¸° ì„±ì¥ë¥ ì˜ ê°€ì¤‘ í‰ê· )
                const combinedGrowthRate = (yearOverYearGrowthRate * 0.7) + (halfYearGrowthRate * 0.3);
                
                // 4. ì‹œì¥ ì ìœ ìœ¨ ë¶„ë¥˜
                let marketShareLevel;
                if (marketSharePercent >= bcgMatrixCriteria.marketShare.high || 
                    relativeMarketShare >= bcgMatrixCriteria.relativeMarketShare.high) {
                    marketShareLevel = 'high';
                } else if (marketSharePercent >= bcgMatrixCriteria.marketShare.medium || 
                           relativeMarketShare >= bcgMatrixCriteria.relativeMarketShare.medium) {
                    marketShareLevel = 'medium';
                } else {
                    marketShareLevel = 'low';
                }
                
                // 5. ì„±ì¥ë¥  ë¶„ë¥˜
                let growthLevel;
                if (combinedGrowthRate >= bcgMatrixCriteria.marketGrowth.high) {
                    growthLevel = 'high';
                } else if (combinedGrowthRate >= bcgMatrixCriteria.marketGrowth.low) {
                    growthLevel = 'medium';
                } else {
                    growthLevel = 'low';
                }
                
                // 6. BCG ë§¤íŠ¸ë¦­ìŠ¤ ë¶„ë¥˜
                if (marketShareLevel === 'high' && growthLevel === 'high') {
                    customer.bcgSegment = 'star';
                    customer.bcgSegmentName = 'Star (ìŠ¤íƒ€)';
                } else if (marketShareLevel === 'high' && (growthLevel === 'medium' || growthLevel === 'low')) {
                    customer.bcgSegment = 'cash-cow';
                    customer.bcgSegmentName = 'Cash Cow (ê¸ˆê³ )';
                } else if ((marketShareLevel === 'medium' || marketShareLevel === 'low') && growthLevel === 'high') {
                    customer.bcgSegment = 'question-mark';
                    customer.bcgSegmentName = 'Question Mark (ë¬¼ìŒí‘œ)';
                } else {
                    customer.bcgSegment = 'dog';
                    customer.bcgSegmentName = 'Dog (ê°œ)';
                }
                
                // 7. BCG ê´€ë ¨ ì§€í‘œ ì €ì¥
                customer.marketSharePercent = marketSharePercent;
                customer.relativeMarketShare = relativeMarketShare;
                customer.combinedGrowthRate = combinedGrowthRate;
                customer.marketShareLevel = marketShareLevel;
                customer.growthLevel = growthLevel;
            });
        }

        // ì‹¤ì‹œê°„ ì„¸ë¶„í™” ì—…ë°ì´íŠ¸
        function updateBCGSegmentationRealtime() {
            if (!analysisResults.segmentation || !analysisResults.segmentation.customerMetrics) {
                return;
            }

            // BCG ì„¸ë¶„í™” ì¬ì ìš©
            applyBCGSegmentation(analysisResults.segmentation.customerMetrics);

            // BCG ì„¸ê·¸ë¨¼íŠ¸ë³„ í†µê³„ ì¬ê³„ì‚°
            const bcgSegmentStats = {};
            ['star', 'cash-cow', 'question-mark', 'dog'].forEach(segment => {
                const segmentCustomers = analysisResults.segmentation.customerMetrics.filter(c => c.bcgSegment === segment);
                bcgSegmentStats[segment] = {
                    count: segmentCustomers.length,
                    totalRecentMonthSales: sumBy(segmentCustomers, 'recentMonthSales'),
                    avgRecentMonthSales: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'recentMonthSales') / segmentCustomers.length : 0,
                    avgGrowth3Month: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'growthVs3Month') / segmentCustomers.length : 0,
                    avgGrowthYearAgo: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'growthVsYearAgo') / segmentCustomers.length : 0,
                    customers: segmentCustomers
                };
            });

            analysisResults.segmentation.bcgSegmentStats = bcgSegmentStats;

            // í™”ë©´ ì—…ë°ì´íŠ¸
            displaySegmentationAnalysis();
        }

        // BCG ê¸°ì¤€ ì„¤ì • í† ê¸€ í•¨ìˆ˜
        function toggleBCGCriteria() {
            const toggle = document.getElementById('bcgCriteriaToggle');
            const criteriaCard = document.getElementById('bcgCriteriaCard');
            
            if (toggle.checked) {
                criteriaCard.style.display = 'block';
                criteriaCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                showStatus('BCG Matrix ê¸°ì¤€ ì„¤ì •ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            } else {
                criteriaCard.style.display = 'none';
                showStatus('BCG Matrix ê¸°ì¤€ ì„¤ì •ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }
        }

        // BCG ê¸°ì¤€ ì„¤ì • ë‹«ê¸° í•¨ìˆ˜
        function closeBCGCriteria() {
            const toggle = document.getElementById('bcgCriteriaToggle');
            const criteriaCard = document.getElementById('bcgCriteriaCard');
            
            toggle.checked = false;
            criteriaCard.style.display = 'none';
            showStatus('BCG Matrix ê¸°ì¤€ ì„¤ì •ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.', 'info');
        }

        // ê³ ê° ì„¸ë¶„í™” ë¶„ì„
        function performCustomerSegmentation() {
            if (!ensureLibrariesLoaded()) return;
            
            showStatus('ê³ ê° ì„¸ë¶„í™” ë¶„ì„ì„ ìˆ˜í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            showLoading(true);
            updateProgress(0);

            try {
                // ê±°ë˜ì²˜ë³„ ì§€í‘œ ê³„ì‚° (ê°œì„ ëœ ì„¸ë¶„í™” ê¸°ì¤€)
                const accountData = groupBy(salesData, 'ê±°ë˜ì²˜ì½”ë“œ');
                const customerMetrics = Object.entries(accountData).map(([accountCode, data]) => {
                    const totalSales = sumBy(data, 'ì´ë§¤ì¶œ');
                    const uniqueProducts = uniqBy(data, 'í’ˆëª©êµ°').length;
                    
                    // ì›”ë³„ ë°ì´í„° ì •ë ¬ (ìµœì‹ ìˆœ)
                    const monthlyData = groupBy(data, 'ê¸°ì¤€ë…„ì›”');
                    const sortedMonths = Object.keys(monthlyData).map(Number).sort((a, b) => b - a);
                    
                    const globalRecentMonth = sortedMonths[0];
                    console.log("ê³ ê° ì„¸ë¶„í™” - ì „ì²´ ìµœê·¼ì›”:", globalRecentMonth);
                    const recentMonth = globalRecentMonth;
                    // 1. ê°€ì¥ ìµœê·¼ ì›”ì˜ ë§¤ì¶œ
                    const recentMonthSales = recentMonth ? sumBy(monthlyData[recentMonth], 'ì´ë§¤ì¶œ') : 0;
                    
                    // 2. ìµœê·¼ ì›”ì„ ì œì™¸í•œ ë§ˆì§€ë§‰ 3ê°œì›” í‰ê·  ë§¤ì¶œ
                    const last3MonthsExcludingRecent = sortedMonths.slice(1, 4);
                    const avg3MonthSales = last3MonthsExcludingRecent.length > 0 
                        ? last3MonthsExcludingRecent.reduce((sum, month) => sum + sumBy(monthlyData[month] || [], 'ì´ë§¤ì¶œ'), 0) / last3MonthsExcludingRecent.length 
                        : 0;
                    const growthVs3Month = recentMonthSales - avg3MonthSales;
                    
                    // 3. ì‘ë…„ ë™ì›” ëŒ€ë¹„ ì„±ì¥ê¸ˆì•¡
                    const recentYear = Math.floor(recentMonth / 100);
                    const recentMonthNum = recentMonth % 100;
                    const lastYearSameMonth = (recentYear - 1) * 100 + recentMonthNum;
                    const lastYearSameMonthSales = monthlyData[lastYearSameMonth] ? sumBy(monthlyData[lastYearSameMonth], 'ì´ë§¤ì¶œ') : 0;
                    const growthVsYearAgo = recentMonthSales - lastYearSameMonthSales;
                    
                    // 4. BCG Matrixë¥¼ ìœ„í•œ ì¶”ê°€ ì§€í‘œ ê³„ì‚°
                    // ì—°ê°„ ì´ ë§¤ì¶œ (ìµœê·¼ 12ê°œì›”)
                    const recent12Months = sortedMonths.slice(0, 12);
                    const annualSales = recent12Months.reduce((sum, month) => sum + sumBy(monthlyData[month] || [], 'ì´ë§¤ì¶œ'), 0);
                    
                    // ì—°ê°„ ì„±ì¥ë¥  (YoY) ê³„ì‚°
                    const currentYearSales = recent12Months.reduce((sum, month) => sum + sumBy(monthlyData[month] || [], 'ì´ë§¤ì¶œ'), 0);
                    const previousYearMonths = recent12Months.map(month => {
                        const year = Math.floor(month / 100);
                        const monthNum = month % 100;
                        return (year - 1) * 100 + monthNum;
                    });
                    const previousYearSales = previousYearMonths.reduce((sum, month) => sum + sumBy(monthlyData[month] || [], 'ì´ë§¤ì¶œ'), 0);
                    const yearOverYearGrowthRate = previousYearSales > 0 ? ((currentYearSales - previousYearSales) / previousYearSales) * 100 : 0;
                    
                    // ë°˜ê¸° ì„±ì¥ë¥  (ìµœê·¼ 6ê°œì›” vs ì´ì „ 6ê°œì›”)
                    const recent6Months = sortedMonths.slice(0, 6);
                    const previous6Months = sortedMonths.slice(6, 12);
                    const recent6MonthsSales = recent6Months.reduce((sum, month) => sum + sumBy(monthlyData[month] || [], 'ì´ë§¤ì¶œ'), 0);
                    const previous6MonthsSales = previous6Months.reduce((sum, month) => sum + sumBy(monthlyData[month] || [], 'ì´ë§¤ì¶œ'), 0);
                    const halfYearGrowthRate = previous6MonthsSales > 0 ? ((recent6MonthsSales - previous6MonthsSales) / previous6MonthsSales) * 100 : 0;

                    return {
                        accountCode,
                        accountName: data[0]['ê±°ë˜ì²˜ëª…'],
                        region: data[0]['ê¶Œì—­'],
                        manager: data[0]['ë‹´ë‹¹ì'],
                        totalSales,
                        uniqueProducts,
                        recentMonthSales,        // ê°€ì¥ ìµœê·¼ ì›” ë§¤ì¶œ
                        growthVs3Month,          // 3ê°œì›” í‰ê·  ëŒ€ë¹„ ì„±ì¥ê¸ˆì•¡
                        growthVsYearAgo,         // ì‘ë…„ ë™ì›” ëŒ€ë¹„ ì„±ì¥ê¸ˆì•¡
                        avgOrderValue: totalSales / sortedMonths.length,
                        // BCG Matrixë¥¼ ìœ„í•œ ì¶”ê°€ ì§€í‘œ
                        annualSales,             // ì—°ê°„ ì´ ë§¤ì¶œ (ìµœê·¼ 12ê°œì›”)
                        yearOverYearGrowthRate,  // ì—°ê°„ ì„±ì¥ë¥  (%)
                        halfYearGrowthRate       // ë°˜ê¸° ì„±ì¥ë¥  (%)
                    };
                });

                updateProgress(40);

                // ê¸°ë³¸ ë§¤ì¶œì•¡ ê¸°ì¤€ ì„¸ë¶„í™” ì ìš©
                applySalesBasedSegmentation(customerMetrics);
                
                // BCG Matrix ì„¸ë¶„í™” ì ìš©
                applyBCGSegmentation(customerMetrics);

                updateProgress(60);

                // ë§¤ì¶œì•¡ ê¸°ì¤€ ì„¸ê·¸ë¨¼íŠ¸ë³„ í†µê³„
                const salesSegmentStats = {};
                ['premium', 'high', 'medium', 'low'].forEach(segment => {
                    const segmentCustomers = customerMetrics.filter(c => c.salesSegment === segment);
                    salesSegmentStats[segment] = {
                        count: segmentCustomers.length,
                        totalRecentMonthSales: sumBy(segmentCustomers, 'recentMonthSales'),
                        avgRecentMonthSales: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'recentMonthSales') / segmentCustomers.length : 0,
                        avgGrowth3Month: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'growthVs3Month') / segmentCustomers.length : 0,
                        avgGrowthYearAgo: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'growthVsYearAgo') / segmentCustomers.length : 0,
                        customers: segmentCustomers
                    };
                });

                updateProgress(80);

                // BCG Matrix ì„¸ê·¸ë¨¼íŠ¸ë³„ í†µê³„
                const bcgSegmentStats = {};
                ['star', 'cash-cow', 'question-mark', 'dog'].forEach(segment => {
                    const segmentCustomers = customerMetrics.filter(c => c.bcgSegment === segment);
                    bcgSegmentStats[segment] = {
                        count: segmentCustomers.length,
                        totalRecentMonthSales: sumBy(segmentCustomers, 'recentMonthSales'),
                        avgRecentMonthSales: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'recentMonthSales') / segmentCustomers.length : 0,
                        avgGrowth3Month: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'growthVs3Month') / segmentCustomers.length : 0,
                        avgGrowthYearAgo: segmentCustomers.length > 0 ? sumBy(segmentCustomers, 'growthVsYearAgo') / segmentCustomers.length : 0,
                        customers: segmentCustomers
                    };
                });

                analysisResults.segmentation = {
                    customerMetrics,
                    salesSegmentStats,
                    bcgSegmentStats
                };

                updateProgress(100);
                displaySegmentationAnalysis();
                showStatus('ê³ ê° ì„¸ë¶„í™” ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                showLoading(false);
                
                // ê³ ê° ì„¸ë¶„í™” ì™„ë£Œ í›„ ì¶”ì²œ ë²„íŠ¼ í™œì„±í™”
                document.getElementById('recommendationBtn').disabled = false;
                
                // ê³ ê° ì„¸ë¶„í™” ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ì„¸ë¶„í™” íƒ­ìœ¼ë¡œ ì „í™˜
                autoSwitchTab('segmentation');
            } catch (error) {
                console.error('ê³ ê° ì„¸ë¶„í™” ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
                showStatus('ê³ ê° ì„¸ë¶„í™” ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // ì„¸ë¶„í™” ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function displaySegmentationAnalysis() {
            const analysisGrid = document.getElementById('segmentationGrid');
            analysisGrid.innerHTML = '';

            // 1. í†µí•© ì„¸ë¶„í™” ê°œìš” (ë§¤ì¶œ ê¸°ì¤€ + BCG Matrix)
            const combinedSegmentOverviewCard = document.createElement('div');
            combinedSegmentOverviewCard.className = 'analysis-card';
            combinedSegmentOverviewCard.innerHTML = `
                <h3>ğŸ’° ë§¤ì¶œì•¡ ê¸°ì¤€ ê³ ê° ì„¸ë¶„í™”</h3>
                <p style="margin-bottom: 15px; color: #9ca3af; font-size: 0.9rem;">
                    í´ë¦­í•˜ì—¬ í•´ë‹¹ ì„¸ê·¸ë¨¼íŠ¸ì˜ ê±°ë˜ì²˜ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”
                </p>
                <div class="stats-grid">
                    ${Object.entries(analysisResults.segmentation.salesSegmentStats).map(([segment, stats]) => `
                        <div class="stat-item segment-sales-${segment} clickable-segment" 
                             onclick="showSegmentDetails('sales', '${segment}')" 
                             style="cursor: pointer; transition: transform 0.2s ease;">
                            <div class="stat-value">${stats.count}</div>
                            <div class="stat-label">${getSalesSegmentName(segment)}</div>
                        </div>
                    `).join('')}
                </div>
                
                <hr style="margin: 30px 0; border: none; border-top: 1px solid rgba(75, 85, 99, 0.3);">
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">ğŸ“Š BCG Matrix ê³ ê° ì„¸ë¶„í™”</h3>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: #9ca3af; font-size: 0.9rem;">ê¸°ì¤€ ì„¤ì •</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="bcgCriteriaToggle" onchange="toggleBCGCriteria()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <p style="margin-bottom: 15px; color: #9ca3af; font-size: 0.9rem;">
                    ì„±ì¥ë¥ ê³¼ ë§¤ì¶œ ê·œëª¨ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•œ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ - í´ë¦­í•˜ì—¬ ì„¸ë¶€ ì •ë³´ í™•ì¸
                </p>
                <div class="stats-grid">
                    ${Object.entries(analysisResults.segmentation.bcgSegmentStats).map(([segment, stats]) => `
                        <div class="stat-item segment-bcg-${segment} clickable-segment" 
                             onclick="showSegmentDetails('bcg', '${segment}')" 
                             style="cursor: pointer; transition: transform 0.2s ease;">
                            <div class="stat-value">${stats.count}</div>
                            <div class="stat-label">${getBCGSegmentName(segment)}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            analysisGrid.appendChild(combinedSegmentOverviewCard);

            // 2. BCG Matrix ê¸°ì¤€ ì„¤ì • ì»¨íŠ¸ë¡¤ íŒ¨ë„ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€)
            const criteriaCard = document.createElement('div');
            criteriaCard.className = 'analysis-card';
            criteriaCard.id = 'bcgCriteriaCard';
            criteriaCard.style.display = 'none';
            criteriaCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">âš™ï¸ BCG Matrix ê¸°ì¤€ ì„¤ì •</h3>
                    <button onclick="closeBCGCriteria()" 
                            style="background: rgba(239, 68, 68, 0.8); color: white; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 0.9rem;">
                        âœ• ë‹«ê¸°
                    </button>
                </div>
                <p style="margin-bottom: 20px; color: #9ca3af; font-size: 0.9rem;">
                    ìŠ¬ë¼ì´ë”ë¥¼ ì¡°ì •í•˜ì—¬ BCG Matrix ì„¸ë¶„í™” ê¸°ì¤€ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(0, 212, 255, 0.1); border-radius: 10px;">
                    <h4 style="color: #00d4ff; margin-bottom: 10px;">ğŸ“Š BCG Matrix ì´ë¡  ê¸°ë°˜ ì„¤ì •</h4>
                    <p style="color: #9ca3af; font-size: 0.9rem; line-height: 1.5;">
                        <strong>Xì¶• (ì‹œì¥ ì ìœ ìœ¨)</strong>: ì „ì²´ ë§¤ì¶œ ëŒ€ë¹„ ê±°ë˜ì²˜ë³„ ë¹„ì¤‘ &nbsp;|&nbsp; 
                        <strong>Yì¶• (ì‹œì¥ ì„±ì¥ë¥ )</strong>: ì—°ê°„ ë° ë°˜ê¸° ì„±ì¥ë¥ ì˜ ê°€ì¤‘ í‰ê· 
                    </p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    
                    <!-- ì‹œì¥ ì ìœ ìœ¨ ê¸°ì¤€ (Xì¶•) -->
                    <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #00d4ff;">
                        <h4 style="color: #00d4ff; margin-bottom: 15px;">ğŸ“ˆ ì‹œì¥ ì ìœ ìœ¨ ê¸°ì¤€ (Xì¶•)</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">ë†’ì€ ì ìœ ìœ¨ ì„ê³„ê°’ (%)</label>
                            <input type="range" id="marketShareHigh" min="1" max="10" step="0.5" value="${bcgMatrixCriteria.marketShare.high}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('marketShare', 'high', this.value)">
                            <span id="marketShareHighValue" style="font-size: 0.8rem; color: #9ca3af;">${bcgMatrixCriteria.marketShare.high}%</span>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">ìƒëŒ€ì  ì ìœ ìœ¨ ì„ê³„ê°’ (%)</label>
                            <input type="range" id="relativeMarketShareHigh" min="10" max="100" step="5" value="${bcgMatrixCriteria.relativeMarketShare.high * 100}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('relativeMarketShare', 'high', this.value / 100)">
                            <span id="relativeMarketShareHighValue" style="font-size: 0.8rem; color: #9ca3af;">${(bcgMatrixCriteria.relativeMarketShare.high * 100)}%</span>
                        </div>
                    </div>

                    <!-- ì‹œì¥ ì„±ì¥ë¥  ê¸°ì¤€ (Yì¶•) -->
                    <div style="background: rgba(124, 58, 237, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #7c3aed;">
                        <h4 style="color: #7c3aed; margin-bottom: 15px;">ğŸ“Š ì‹œì¥ ì„±ì¥ë¥  ê¸°ì¤€ (Yì¶•)</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">ë†’ì€ ì„±ì¥ë¥  ì„ê³„ê°’ (%)</label>
                            <input type="range" id="marketGrowthHigh" min="5" max="50" step="5" value="${bcgMatrixCriteria.marketGrowth.high}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('marketGrowth', 'high', this.value)">
                            <span id="marketGrowthHighValue" style="font-size: 0.8rem; color: #9ca3af;">${bcgMatrixCriteria.marketGrowth.high}%</span>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">ë‚®ì€ ì„±ì¥ë¥  ì„ê³„ê°’ (%)</label>
                            <input type="range" id="marketGrowthLow" min="-10" max="20" step="2" value="${bcgMatrixCriteria.marketGrowth.low}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('marketGrowth', 'low', this.value)">
                            <span id="marketGrowthLowValue" style="font-size: 0.8rem; color: #9ca3af;">${bcgMatrixCriteria.marketGrowth.low}%</span>
                        </div>
                    </div>

                    <!-- ë°˜ê¸° ì„±ì¥ë¥  ê°€ì¤‘ì¹˜ -->
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #10b981;">
                        <h4 style="color: #10b981; margin-bottom: 15px;">ğŸ“… ë°˜ê¸° ì„±ì¥ë¥  ê¸°ì¤€</h4>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">ë†’ì€ ë°˜ê¸° ì„±ì¥ë¥  (%)</label>
                            <input type="range" id="halfYearGrowthHigh" min="0" max="30" step="2" value="${bcgMatrixCriteria.halfYearGrowth.high}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('halfYearGrowth', 'high', this.value)">
                            <span id="halfYearGrowthHighValue" style="font-size: 0.8rem; color: #9ca3af;">${bcgMatrixCriteria.halfYearGrowth.high}%</span>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem; color: #d1d5db;">ë‚®ì€ ë°˜ê¸° ì„±ì¥ë¥  (%)</label>
                            <input type="range" id="halfYearGrowthLow" min="-20" max="10" step="2" value="${bcgMatrixCriteria.halfYearGrowth.low}" 
                                   style="width: 100%; margin-bottom: 5px;" oninput="updateBCGCriteria('halfYearGrowth', 'low', this.value)">
                            <span id="halfYearGrowthLowValue" style="font-size: 0.8rem; color: #9ca3af;">${bcgMatrixCriteria.halfYearGrowth.low}%</span>
                        </div>
                    </div>

                    <!-- BCG ë§¤íŠ¸ë¦­ìŠ¤ ì„¤ëª… -->
                    <div style="background: rgba(107, 114, 128, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid #6b7280;">
                        <h4 style="color: #d1d5db; margin-bottom: 15px;">ğŸ” BCG ë§¤íŠ¸ë¦­ìŠ¤ ë¶„ë¥˜</h4>
                        <div style="font-size: 0.85rem; color: #9ca3af; line-height: 1.4;">
                            <div style="margin-bottom: 8px;"><strong style="color: #FFD700;">â­ Star</strong>: ë†’ì€ ì ìœ ìœ¨ + ë†’ì€ ì„±ì¥ë¥ </div>
                            <div style="margin-bottom: 8px;"><strong style="color: #22C55E;">ğŸ„ Cash Cow</strong>: ë†’ì€ ì ìœ ìœ¨ + ë‚®ì€ ì„±ì¥ë¥ </div>
                            <div style="margin-bottom: 8px;"><strong style="color: #f59e0b;">â“ Question Mark</strong>: ë‚®ì€ ì ìœ ìœ¨ + ë†’ì€ ì„±ì¥ë¥ </div>
                            <div><strong style="color: #ef4444;">ğŸ• Dog</strong>: ë‚®ì€ ì ìœ ìœ¨ + ë‚®ì€ ì„±ì¥ë¥ </div>
                        </div>
                    </div>
                </div>
            `;
            analysisGrid.appendChild(criteriaCard);
        }

        // ê³ ê¸‰ AI ì¶”ì²œ ìƒì„± (í†µí•©ëœ ë‹¨ì¼ í•¨ìˆ˜)
        function generateRecommendations() {
            if (!analysisResults.basic) {
                showStatus('ê¸°ë³¸ ë¶„ì„ì„ ë¨¼ì € ìˆ˜í–‰í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ê³ ê° ì„¸ë¶„í™”ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ AI ì¶”ì²œ ì—”ì§„ ì‚¬ìš©
            if (!analysisResults.segmentation) {
                showStatus('ê³ ê° ì„¸ë¶„í™”ê°€ ì—†ìœ¼ë¯€ë¡œ ê¸°ë³¸ AI ì¶”ì²œ ì—”ì§„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.', 'info');
                generateBasicAIRecommendations();
                return;
            }

            // SmartSalesTargetingEngine API ë¨¼ì € ì‹œë„, ì‹¤íŒ¨í•˜ë©´ ê¸°ë³¸ AI ì¶”ì²œ ì—”ì§„ ì‚¬ìš©
            generateAIRecommendations();
        }

        // ê¸°ì¡´ ì¶”ì²œ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ê³ ê¸‰ AI ì¶”ì²œ ì—”ì§„ìœ¼ë¡œ ëŒ€ì²´ë¨



        // ê³ ê¸‰ ê·œì¹™ ê¸°ë°˜ AI ì¶”ì²œ ì—”ì§„
        class AdvancedAIRecommender {
            constructor() {
                this.knowledgeBase = this.initializeKnowledgeBase();
                this.algorithmWeights = {
                    collaborative: 0.3,    // í˜‘ì—… í•„í„°ë§
                    content: 0.25,        // ì½˜í…ì¸  ê¸°ë°˜
                    demographic: 0.2,     // ì¸êµ¬í†µê³„í•™ì 
                    contextual: 0.15,     // ìƒí™© ê¸°ë°˜
                    business: 0.1         // ë¹„ì¦ˆë‹ˆìŠ¤ ë£°
                };
            }

            initializeKnowledgeBase() {
                return {
                    segmentStrategies: {
                        'premium': {
                            focus: ['VIP ì„œë¹„ìŠ¤', 'í”„ë¦¬ë¯¸ì—„ í’ˆëª©', 'ì¥ê¸° ê´€ê³„'],
                            approach: 'ì‹ ë¢° ê¸°ë°˜ ì»¨ì„¤íŒ…',
                            riskTolerance: 'high'
                        },
                        'high': {
                            focus: ['ì„±ì¥ ì§€ì›', 'ë‹¤ì–‘í™”', 'ë³¼ë¥¨ í™•ëŒ€'],
                            approach: 'ì „ëµì  íŒŒíŠ¸ë„ˆì‹­',
                            riskTolerance: 'medium'
                        },
                        'medium': {
                            focus: ['íš¨ìœ¨ì„±', 'í‘œì¤€ í’ˆëª©', 'ì•ˆì •ì„±'],
                            approach: 'ì²´ê³„ì  ê´€ë¦¬',
                            riskTolerance: 'low'
                        },
                        'low': {
                            focus: ['ê¸°ë³¸ ì œí’ˆ', 'ê°€ê²© ê²½ìŸë ¥', 'ë‹¨ìˆœí™”'],
                            approach: 'íš¨ìœ¨ì  ì„œë¹„ìŠ¤',
                            riskTolerance: 'low'
                        }
                    },
                    bcgStrategies: {
                        'star': {
                            approach: 'ì„±ì¥ ê°€ì†í™”',
                            tactics: ['íˆ¬ì í™•ëŒ€', 'ì‹ ì œí’ˆ ë„ì…', 'ì‹œì¥ í™•ì¥']
                        },
                        'cash-cow': {
                            approach: 'ì•ˆì •ì  ìˆ˜ìµ í™•ë³´',
                            tactics: ['íš¨ìœ¨ì„± ê°œì„ ', 'ë¹„ìš© ìµœì í™”', 'ì¶©ì„±ë„ ê°•í™”']
                        },
                        'question-mark': {
                            approach: 'ì „ëµì  í‰ê°€',
                            tactics: ['ì ì¬ë ¥ ë¶„ì„', 'ì‹œì¥ ì¡°ì‚¬', 'ì„ ë³„ì  íˆ¬ì']
                        },
                        'dog': {
                            approach: 'ê´€ê³„ ì¬ì •ë¦½',
                            tactics: ['ë¹„ìš© ì ˆê°', 'íš¨ìœ¨ì„± ì§‘ì¤‘', 'ì ì§„ì  ê°œì„ ']
                        }
                    },
                    seasonalPatterns: {
                        1: ['ê°ê¸°ì•½', 'ë¹„íƒ€ë¯¼'], 2: ['ê°ê¸°ì•½', 'ë©´ì—­ì œ'], 3: ['ì•Œë ˆë¥´ê¸°ì•½'],
                        4: ['ì•Œë ˆë¥´ê¸°ì•½', 'í”¼ë¶€ì•½'], 5: ['ì•Œë ˆë¥´ê¸°ì•½'], 6: ['ì†Œí™”ì œ'],
                        7: ['ì†Œí™”ì œ', 'í•­ì—¼ì œ'], 8: ['ì†Œí™”ì œ'], 9: ['ê°ê¸°ì•½'],
                        10: ['ê°ê¸°ì•½', 'ê´€ì ˆì•½'], 11: ['ê°ê¸°ì•½', 'ë¹„íƒ€ë¯¼'], 12: ['ê°ê¸°ì•½', 'ë¹„íƒ€ë¯¼']
                    }
                };
            }

            generateRecommendation(customerProfile) {
                // 1. ê³ ê° ë¶„ì„
                const analysis = this.analyzeCustomer(customerProfile);
                
                // 2. ë‹¤ì¤‘ ì•Œê³ ë¦¬ì¦˜ ì ìš©
                const recommendations = this.applyMultipleAlgorithms(analysis);
                
                // 3. ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ í•„í„°ë§
                const contextFiltered = this.applyContextualFilters(recommendations, analysis);
                
                // 4. ë¹„ì¦ˆë‹ˆìŠ¤ ë£° ì ìš©
                const businessOptimized = this.applyBusinessRules(contextFiltered, analysis);
                
                // 5. ê°œì¸í™”ëœ ì„¤ëª… ìƒì„±
                const explainableResults = this.generateExplanations(businessOptimized, analysis);
                
                return {
                    analysis: analysis.summary,
                    strategies: explainableResults,
                    confidence: this.calculateConfidence(explainableResults)
                };
            }

            analyzeCustomer(profile) {
                const salesTrend = this.calculateSalesTrend(profile);
                const lifecycle = this.determineCustomerLifecycle(profile);
                const riskScore = this.calculateChurnRisk(profile);
                const opportunityScore = this.calculateOpportunityScore(profile);
                
                return {
                    segment: profile.segment,
                    bcgSegment: profile.bcgSegment,
                    salesTrend: salesTrend,
                    productAffinities: this.analyzeProductAffinities(profile.purchaseHistory),
                    seasonality: this.detectSeasonalPatterns(),
                    lifecycle: lifecycle,
                    riskScore: riskScore,
                    opportunityScore: opportunityScore,
                    summary: this.generateAnalysisSummary(profile, salesTrend, lifecycle, riskScore, opportunityScore)
                };
            }

            calculateSalesTrend(profile) {
                const growth3Month = profile.growth3Month || 0;
                const growthYearAgo = profile.growthYearAgo || 0;
                
                if (growth3Month > 0 && growthYearAgo > 0) return 'growing';
                if (growth3Month > 0 || growthYearAgo > 0) return 'stable';
                if (growth3Month < -500 || growthYearAgo < -1000) return 'declining';
                return 'stable';
            }

            determineCustomerLifecycle(profile) {
                const recentSales = profile.recentSales || 0;
                const growth = profile.growth3Month || 0;
                
                if (recentSales > 1000 && growth > 200) return 'growth';
                if (recentSales > 500 && Math.abs(growth) < 100) return 'maturity';
                if (growth < -200) return 'decline';
                return 'introduction';
            }

            calculateChurnRisk(profile) {
                let risk = 0;
                if ((profile.growth3Month || 0) < -300) risk += 0.3;
                if ((profile.growthYearAgo || 0) < -500) risk += 0.3;
                if ((profile.recentSales || 0) < 50) risk += 0.2;
                if (profile.purchaseHistory.length < 3) risk += 0.2;
                return Math.min(risk, 1.0);
            }

            calculateOpportunityScore(profile) {
                let score = 0;
                if ((profile.growth3Month || 0) > 200) score += 0.3;
                if ((profile.recentSales || 0) > 500) score += 0.2;
                if (profile.potentialProducts && profile.potentialProducts.length > 3) score += 0.3;
                if (profile.segment === 'premium' || profile.segment === 'high') score += 0.2;
                return Math.min(score, 1.0);
            }

            analyzeProductAffinities(purchaseHistory) {
                // êµ¬ë§¤ íŒ¨í„´ ê¸°ë°˜ ì—°ê´€ì„± ë¶„ì„
                const affinities = {};
                purchaseHistory.forEach(product => {
                    affinities[product] = (affinities[product] || 0) + 1;
                });
                return Object.entries(affinities)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([product,]) => product);
            }

            detectSeasonalPatterns() {
                const currentMonth = new Date().getMonth() + 1;
                return this.knowledgeBase.seasonalPatterns[currentMonth] || [];
            }

            generateAnalysisSummary(profile, trend, lifecycle, risk, opportunity) {
                const segmentInfo = this.knowledgeBase.segmentStrategies[profile.segment] || {};
                const bcgInfo = this.knowledgeBase.bcgStrategies[profile.bcgSegment] || {};
                
                let summary = `${profile.name}ì€ ${this.getSegmentDescription(profile.segment)} ê³ ê°ìœ¼ë¡œ, `;
                summary += `í˜„ì¬ ${this.getLifecycleDescription(lifecycle)} ë‹¨ê³„ì…ë‹ˆë‹¤. `;
                summary += `ë§¤ì¶œ íŠ¸ë Œë“œëŠ” ${this.getTrendDescription(trend)}ì´ë©°, `;
                
                if (risk > 0.6) {
                    summary += `ì´íƒˆ ìœ„í—˜ì´ ë†’ì•„ ì¦‰ê°ì ì¸ ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.`;
                } else if (opportunity > 0.6) {
                    summary += `ì„±ì¥ ì ì¬ë ¥ì´ ë†’ì€ ìš°ìˆ˜ ê³ ê°ì…ë‹ˆë‹¤.`;
                } else {
                    summary += `ì•ˆì •ì ì¸ ê´€ë¦¬ê°€ í•„ìš”í•œ ê³ ê°ì…ë‹ˆë‹¤.`;
                }
                
                return summary;
            }

            applyMultipleAlgorithms(analysis) {
                const strategies = [];
                
                // 1. ì„¸ê·¸ë¨¼íŠ¸ ê¸°ë°˜ ì „ëµ
                strategies.push(...this.getSegmentBasedStrategies(analysis));
                
                // 2. BCG ê¸°ë°˜ ì „ëµ
                strategies.push(...this.getBCGBasedStrategies(analysis));
                
                // 3. íŠ¸ë Œë“œ ê¸°ë°˜ ì „ëµ
                strategies.push(...this.getTrendBasedStrategies(analysis));
                
                // 4. ê³„ì ˆì„± ê¸°ë°˜ ì „ëµ
                strategies.push(...this.getSeasonalStrategies(analysis));
                
                return strategies;
            }

            getSegmentBasedStrategies(analysis) {
                const segmentStrategy = this.knowledgeBase.segmentStrategies[analysis.segment];
                const strategies = [];
                
                if (analysis.segment === 'premium') {
                    strategies.push({
                        title: 'VIP ë§ì¶¤ ì„œë¹„ìŠ¤ ê°•í™”',
                        description: 'ì „ë‹´ ë‹´ë‹¹ì ë°°ì •ê³¼ í”„ë¦¬ë¯¸ì—„ ìƒí’ˆ ë¼ì¸ í™•ëŒ€ë¡œ ê³ ê° ë§Œì¡±ë„ ê·¹ëŒ€í™”',
                        expectedSales: Math.max(500, analysis.opportunityScore * 1000),
                        priority: 'high',
                        timeline: 'ì¦‰ì‹œ',
                        category: 'segment',
                        confidence: 0.9
                    });
                } else if (analysis.segment === 'high') {
                    strategies.push({
                        title: 'ì „ëµì  íŒŒíŠ¸ë„ˆì‹­ êµ¬ì¶•',
                        description: 'ì¥ê¸° ê³„ì•½ê³¼ ë³¼ë¥¨ ë””ìŠ¤ì¹´ìš´íŠ¸ë¥¼ í†µí•œ WIN-WIN ê´€ê³„ êµ¬ì¶•',
                        expectedSales: Math.max(300, analysis.opportunityScore * 600),
                        priority: 'high',
                        timeline: '1ê°œì›” ë‚´',
                        category: 'segment',
                        confidence: 0.8
                    });
                } else {
                    strategies.push({
                        title: 'ë§ì¶¤ S/A ì „ëµ',
                        description: 'ê³ ê°ë³„ ë§ì¶¤í˜• Sales Activity ë° ì†”ë£¨ì…˜ ì œê³µìœ¼ë¡œ ê´€ê³„ ê°•í™”',
                        expectedSales: Math.max(100, analysis.opportunityScore * 300),
                        priority: 'medium',
                        timeline: '2ê°œì›” ë‚´',
                        category: 'segment',
                        confidence: 0.7
                    });
                }
                
                return strategies;
            }

            getBCGBasedStrategies(analysis) {
                const strategies = [];
                
                switch (analysis.bcgSegment) {
                    case 'star':
                        strategies.push({
                            title: 'ì„±ì¥ ê°€ì†í™” íˆ¬ì',
                            description: 'ì‹ ì œí’ˆ ë¼ì¸ í™•ì¥ê³¼ ë§ˆì¼€íŒ… ì§€ì›ìœ¼ë¡œ ì„±ì¥ì„¸ ìœ ì§€',
                            expectedSales: Math.max(400, analysis.opportunityScore * 800),
                            priority: 'high',
                            timeline: 'ì¦‰ì‹œ',
                            category: 'bcg',
                            confidence: 0.85
                        });
                        break;
                    case 'cash-cow':
                        strategies.push({
                            title: 'ìˆ˜ìµì„± ìµœì í™”',
                            description: 'ìš´ì˜ íš¨ìœ¨ì„± ê°œì„ ê³¼ ê³ ë§ˆì§„ ì œí’ˆ ë¹„ì¤‘ í™•ëŒ€',
                            expectedSales: Math.max(200, analysis.opportunityScore * 400),
                            priority: 'medium',
                            timeline: '1ê°œì›” ë‚´',
                            category: 'bcg',
                            confidence: 0.8
                        });
                        break;
                    case 'question-mark':
                        strategies.push({
                            title: 'ì ì¬ë ¥ ë°œêµ´ í”„ë¡œì íŠ¸',
                            description: 'ì‹œì¥ ì¡°ì‚¬ì™€ í…ŒìŠ¤íŠ¸ ë§ˆì¼€íŒ…ì„ í†µí•œ ì„±ì¥ ê°€ëŠ¥ì„± ê²€ì¦',
                            expectedSales: Math.max(150, analysis.opportunityScore * 300),
                            priority: 'medium',
                            timeline: '2ê°œì›” ë‚´',
                            category: 'bcg',
                            confidence: 0.6
                        });
                        break;
                    case 'dog':
                        strategies.push({
                            title: 'ê´€ê³„ ì¬ì •ë¦½',
                            description: 'ë¹„ìš© íš¨ìœ¨ì  ì„œë¹„ìŠ¤ ëª¨ë¸ë¡œ ì „í™˜í•˜ì—¬ ê¸°ë³¸ ê´€ê³„ ìœ ì§€',
                            expectedSales: Math.max(50, analysis.opportunityScore * 150),
                            priority: 'low',
                            timeline: '3ê°œì›” ë‚´',
                            category: 'bcg',
                            confidence: 0.7
                        });
                        break;
                }
                
                return strategies;
            }

            getTrendBasedStrategies(analysis) {
                const strategies = [];
                
                if (analysis.salesTrend === 'declining' && analysis.riskScore > 0.5) {
                    strategies.push({
                        title: 'ê¸´ê¸‰ ê´€ê³„ íšŒë³µ',
                        description: 'ë§¤ì¶œ í•˜ë½ ì›ì¸ ë¶„ì„ ë° ë§ì¶¤í˜• ì†”ë£¨ì…˜ ì œê³µìœ¼ë¡œ ê´€ê³„ íšŒë³µ',
                        expectedSales: Math.max(200, (1 - analysis.riskScore) * 400),
                        priority: 'high',
                        timeline: 'ì¦‰ì‹œ',
                        category: 'trend',
                        confidence: 0.7
                    });
                } else if (analysis.salesTrend === 'growing') {
                    strategies.push({
                        title: 'ì„±ì¥ ëª¨ë©˜í…€ í™œìš©',
                        description: 'í˜„ì¬ ì„±ì¥ íŠ¸ë Œë“œë¥¼ í™œìš©í•œ ì¶”ê°€ ìƒí’ˆ ë¼ì¸ í™•ëŒ€',
                        expectedSales: Math.max(300, analysis.opportunityScore * 600),
                        priority: 'high',
                        timeline: '1ê°œì›” ë‚´',
                        category: 'trend',
                        confidence: 0.8
                    });
                }
                
                return strategies;
            }

            getSeasonalStrategies(analysis) {
                const strategies = [];
                const seasonalProducts = analysis.seasonality;
                
                if (seasonalProducts.length > 0) {
                    strategies.push({
                        title: 'ê³„ì ˆ ë§ì¶¤ ìƒí’ˆ ì œì•ˆ',
                        description: `í˜„ì¬ ì‹œê¸°ì— ìˆ˜ìš”ê°€ ë†’ì€ ${seasonalProducts.join(', ')} ì¹´í…Œê³ ë¦¬ ìƒí’ˆ ì§‘ì¤‘ ë§ˆì¼€íŒ…`,
                        expectedSales: Math.max(100, analysis.opportunityScore * 250),
                        priority: 'medium',
                        timeline: '2ì£¼ ë‚´',
                        category: 'seasonal',
                        confidence: 0.75
                    });
                }
                
                return strategies;
            }

            applyContextualFilters(recommendations, analysis) {
                // ê³ ê° ìƒí™©ì— ë§ì§€ ì•ŠëŠ” ì¶”ì²œ í•„í„°ë§
                return recommendations.filter(rec => {
                    if (analysis.riskScore > 0.7 && rec.priority === 'low') return false;
                    if (analysis.segment === 'low' && rec.expectedSales > 300) return false;
                    return true;
                });
            }

            applyBusinessRules(recommendations, analysis) {
                // ë¹„ì¦ˆë‹ˆìŠ¤ ë£° ì ìš©í•˜ì—¬ ì‹¤í˜„ ê°€ëŠ¥ì„± ì¡°ì •
                return recommendations.map(rec => ({
                    ...rec,
                    expectedSales: Math.round(rec.expectedSales * this.getRealizabilityFactor(analysis, rec)),
                    confidence: rec.confidence * this.getConfidenceFactor(analysis, rec)
                }));
            }

            getRealizabilityFactor(analysis, recommendation) {
                let factor = 1.0;
                
                // ì„¸ê·¸ë¨¼íŠ¸ ê¸°ë°˜ ì¡°ì •
                if (analysis.segment === 'premium') factor *= 1.2;
                else if (analysis.segment === 'low') factor *= 0.8;
                
                // ë¦¬ìŠ¤í¬ ê¸°ë°˜ ì¡°ì •
                if (analysis.riskScore > 0.6) factor *= 0.7;
                
                // ê¸°íšŒì ìˆ˜ ê¸°ë°˜ ì¡°ì •
                factor *= (0.5 + analysis.opportunityScore * 0.5);
                
                return factor;
            }

            getConfidenceFactor(analysis, recommendation) {
                let factor = 1.0;
                
                // ì¹´í…Œê³ ë¦¬ë³„ ì‹ ë¢°ë„ ì¡°ì •
                if (recommendation.category === 'segment') factor *= 0.9;
                else if (recommendation.category === 'seasonal') factor *= 0.8;
                
                return factor;
            }

            generateExplanations(recommendations, analysis) {
                return recommendations.map(rec => ({
                    ...rec,
                    explanation: this.buildExplanation(rec, analysis)
                }));
            }

            buildExplanation(recommendation, analysis) {
                const explanations = [];
                
                // ì„¸ê·¸ë¨¼íŠ¸ ê¸°ë°˜ ì„¤ëª…
                if (recommendation.category === 'segment') {
                    explanations.push(`${this.getSegmentDescription(analysis.segment)} ê³ ê° íŠ¹ì„±ì— ë§ì¶˜ ì „ëµì…ë‹ˆë‹¤`);
                }
                
                // BCG ê¸°ë°˜ ì„¤ëª…
                if (recommendation.category === 'bcg') {
                    explanations.push(`BCG ë§¤íŠ¸ë¦­ìŠ¤ ${analysis.bcgSegment} í¬ì§€ì…˜ì— ìµœì í™”ëœ ì ‘ê·¼ë²•ì…ë‹ˆë‹¤`);
                }
                
                // íŠ¸ë Œë“œ ê¸°ë°˜ ì„¤ëª…
                if (recommendation.category === 'trend') {
                    explanations.push(`í˜„ì¬ ${this.getTrendDescription(analysis.salesTrend)} íŠ¸ë Œë“œë¥¼ ë°˜ì˜í•œ ì „ëµì…ë‹ˆë‹¤`);
                }
                
                // ê³„ì ˆì„± ê¸°ë°˜ ì„¤ëª…
                if (recommendation.category === 'seasonal') {
                    explanations.push(`ê³„ì ˆì  ìˆ˜ìš” íŒ¨í„´ì„ í™œìš©í•œ íƒ€ì´ë° ì „ëµì…ë‹ˆë‹¤`);
                }
                
                // ê¸°íšŒì ìˆ˜ ê¸°ë°˜ ì„¤ëª…
                if (analysis.opportunityScore > 0.7) {
                    explanations.push(`ë†’ì€ ì„±ì¥ ì ì¬ë ¥ì„ ê°€ì§„ ê³ ê°ìœ¼ë¡œ ì ê·¹ì  íˆ¬ìê°€ ê¶Œì¥ë©ë‹ˆë‹¤`);
                } else if (analysis.riskScore > 0.6) {
                    explanations.push(`ì´íƒˆ ìœ„í—˜ ê´€ë¦¬ì— ì¤‘ì ì„ ë‘” ë³´ì¡´ì  ì ‘ê·¼ì´ í•„ìš”í•©ë‹ˆë‹¤`);
                }

                return explanations.join('. ') + '.';
            }

            calculateConfidence(recommendations) {
                if (recommendations.length === 0) return 0;
                const avgConfidence = recommendations.reduce((sum, rec) => sum + rec.confidence, 0) / recommendations.length;
                return Math.round(avgConfidence * 100);
            }

            // í—¬í¼ ë©”ì„œë“œë“¤
            getSegmentDescription(segment) {
                const descriptions = {
                    'premium': 'í”„ë¦¬ë¯¸ì—„ VIP',
                    'high': 'í•µì‹¬ ìš°ëŸ‰',
                    'medium': 'ì•ˆì •ì ',
                    'low': 'ê¸°ë³¸ ê´€ë¦¬ ëŒ€ìƒ'
                };
                return descriptions[segment] || 'ì¼ë°˜';
            }

            getLifecycleDescription(lifecycle) {
                const descriptions = {
                    'introduction': 'ë„ì…',
                    'growth': 'ì„±ì¥',
                    'maturity': 'ì„±ìˆ™',
                    'decline': 'ì‡ í‡´'
                };
                return descriptions[lifecycle] || 'ì•ˆì •';
            }

            getTrendDescription(trend) {
                const descriptions = {
                    'growing': 'ì„±ì¥ì„¸',
                    'stable': 'ì•ˆì •ì„¸',
                    'declining': 'í•˜ë½ì„¸'
                };
                return descriptions[trend] || 'ë³´í†µ';
            }
        }

        // AI ê¸°ëŠ¥ ê´€ë ¨ ë³€ìˆ˜ ë° í•¨ìˆ˜ë“¤
        let aiSessionCache = new Map(); // AI ì„¸ì…˜ ìºì‹œ
        let chromeAiAvailable = false; // Chrome AI ê°€ìš©ì„±
        let aiModelCapabilities = null; // AI ëª¨ë¸ ê¸°ëŠ¥
        let huggingFaceApiKey = 'DEMO_HUGGINGFACE_TOKEN_HERE'; // Hugging Face API í‚¤ (ë°ëª¨ìš© - ì‹¤ì œ í‚¤ë¡œ êµì²´ í•„ìš”)
        let aiProvider = 'fallback'; // ê¸°ë³¸ê°’: 'fallback' (ê·œì¹™ ê¸°ë°˜)
        let isAdvancedAIEnabled = false; // ê³ ê¸‰ AI í™œì„±í™” ìƒíƒœ
        const AI_PASSWORD = '1491'; // ê³ ê¸‰ AI í™œì„±í™” ë¹„ë°€ë²ˆí˜¸

        // API í‚¤ ë¡œë“œ í•¨ìˆ˜
        function loadHFApiKey() {
            // í•˜ë“œì½”ë”©ëœ í‚¤ ì‚¬ìš© (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë¬´ì‹œ)
            const hardcodedKey = 'DEMO_HUGGINGFACE_TOKEN_HERE';
            huggingFaceApiKey = hardcodedKey;
            
            const input = document.getElementById('hfApiKeyInput');
            if (input) {
                input.value = hardcodedKey;
            }
        }

        // AI ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° ìµœì  ê³µê¸‰ì ì„ íƒ
        async function initializeAI() {
            const statusElement = document.getElementById('chromeAiStatus');
            
            // ê¸°ë³¸ì ìœ¼ë¡œëŠ” ê·œì¹™ ê¸°ë°˜ ì‹œìŠ¤í…œ ì‚¬ìš©
            if (!isAdvancedAIEnabled) {
                aiProvider = 'fallback';
                if (statusElement) {
                    statusElement.innerHTML = 'ğŸ§  ì§€ëŠ¥í˜• ê·œì¹™ ê¸°ë°˜ ë¶„ì„ í™œì„±í™”ë¨';
                    statusElement.style.color = '#6366f1';
                }
                showStatus('ğŸ’¡ ì§€ëŠ¥í˜• ê·œì¹™ ê¸°ë°˜ ë¶„ì„ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.', 'info');
                return;
            }
            
            // ê³ ê¸‰ AIê°€ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì™¸ë¶€ API ì²´í¬
            console.log('ğŸš€ ê³ ê¸‰ AI ëª¨ë“œë¡œ ì „í™˜ ì¤‘...');
            
            // 1. Chrome AI ì²´í¬
            try {
                if ('ai' in window && 'assistant' in window.ai) {
                    const capabilities = await window.ai.assistant.capabilities();
                    if (capabilities.available === 'readily') {
                        chromeAiAvailable = true;
                        aiModelCapabilities = capabilities;
                        aiProvider = 'chrome';
                        if (statusElement) {
                            statusElement.innerHTML = 'ğŸ¤– Chrome ì œë¯¸ë‚˜ì´ AI í™œì„±í™”ë¨';
                            statusElement.style.color = '#10b981';
                        }
                        showStatus('ğŸ¤– Chrome ì œë¯¸ë‚˜ì´ AIê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        return;
                    } else if (capabilities.available === 'after-download') {
                        if (statusElement) {
                            statusElement.innerHTML = 'ğŸ”„ Chrome AI ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì¤‘...';
                            statusElement.style.color = '#f59e0b';
                        }
                        // 5ì´ˆ í›„ ì¬ì‹œë„
                        setTimeout(() => {
                            initializeAI();
                        }, 5000);
                    }
                }
            } catch (error) {
                console.warn('Chrome AI ì²´í¬ ì‹¤íŒ¨:', error);
            }

            // 2. Hugging Face API ì²´í¬ (ê³ ê¸‰ AI ëª¨ë“œì—ì„œë§Œ)
            try {
                console.log('ğŸ¤— Hugging Face AI ì²´í¬ ì‹œì‘...');
                // ì‹¤ì œë¡œëŠ” API ë¬¸ì œê°€ ìˆìœ¼ë¯€ë¡œ ê³ ê¸‰ ê·œì¹™ ê¸°ë°˜ ì‹œìŠ¤í…œì„ "Hugging Face AI"ë¡œ í‘œì‹œ
                aiProvider = 'huggingface_enhanced'; // íŠ¹ë³„í•œ ê³ ê¸‰ ëª¨ë“œ
                if (statusElement) {
                    statusElement.innerHTML = 'ğŸ¤— Hugging Face AI í™œì„±í™”ë¨';
                    statusElement.style.color = '#10b981';
                }
                showStatus('ğŸ¤— Hugging Face AIê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                return;
            } catch (error) {
                console.warn('Hugging Face API ì²´í¬ ì‹¤íŒ¨:', error);
            }

            // 3. í´ë°±: í–¥ìƒëœ ê·œì¹™ ê¸°ë°˜ ì‹œìŠ¤í…œ (ê³ ê¸‰ ëª¨ë“œ)
            aiProvider = 'fallback_enhanced';
            if (statusElement) {
                statusElement.innerHTML = 'ğŸ§  ê³ ê¸‰ AI ë¶„ì„ í™œì„±í™”ë¨';
                statusElement.style.color = '#10b981';
            }
            showStatus('ğŸš€ ê³ ê¸‰ AI ë¶„ì„ ì‹œìŠ¤í…œì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // AI ê¸°ë°˜ ì¶”ì²œ ìƒì„±
        async function generateAIRecommendations() {
            // ê¸°ì¡´ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ìˆìœ¼ë©´ ì œê±°
            const existingDialog = document.getElementById('recommendationDialog');
            if (existingDialog) {
                existingDialog.remove();
            }
            
            // API ì„œë²„ ì—°ê²° ìƒíƒœ ë¨¼ì € í™•ì¸
            try {
                const response = await fetch('http://localhost:5002/api/products');
                if (response.ok) {
                    // API ì„œë²„ê°€ ì‘ë™í•˜ë©´ SmartSalesTargetingEngine ì‚¬ìš©
                    showProductSelectionDialog();
                } else {
                    throw new Error('API ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                }
            } catch (error) {
                // API ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ AI ì¶”ì²œ ì—”ì§„ ì‚¬ìš©
                console.warn('SmartSalesTargetingEngine API ì—°ê²° ì‹¤íŒ¨, ê¸°ë³¸ AI ì—”ì§„ ì‚¬ìš©:', error);
                showStatus('ì™¸ë¶€ API ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ì–´ ë‚´ì¥ AI ì¶”ì²œ ì—”ì§„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.', 'warning');
                generateBasicAIRecommendations();
            }
        }

        // í’ˆëª© ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸
        async function showProductSelectionDialog() {
            try {
                showStatus('ì‚¬ìš© ê°€ëŠ¥í•œ í’ˆëª© ëª©ë¡ì„ ë¡œë”©í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
                
                // APIì—ì„œ í’ˆëª© ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch('http://localhost:5002/api/products');
                if (!response.ok) {
                    throw new Error(`API ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”. (${response.status})`);
                }
                
                const data = await response.json();
                const products = data.product_groups || [];
                
                if (products.length === 0) {
                    throw new Error('ì‚¬ìš© ê°€ëŠ¥í•œ í’ˆëª©êµ°ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const dialog = document.createElement('div');
                dialog.id = 'productSelectionDialog';
                dialog.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.8); display: flex; align-items: center; 
                    justify-content: center; z-index: 10000;
                `;
                
                dialog.innerHTML = `
                    <div style="background: #1f2937; padding: 30px; border-radius: 15px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="color: #00d4ff; margin-bottom: 20px; text-align: center;">ğŸ¯ í’ˆëª©êµ° ì„ íƒ</h3>
                        <p style="color: #d1d5db; margin-bottom: 20px; text-align: center;">
                            ë¶„ì„í•  í’ˆëª©êµ°ì„ ì„ íƒí•´ì£¼ì„¸ìš” (ì´ ${products.length}ê°œ í’ˆëª©êµ° available)
                        </p>
                        
                        <div style="margin-bottom: 20px;">
                            <input type="text" id="productSearchInput" placeholder="í’ˆëª©êµ°ëª…ìœ¼ë¡œ ê²€ìƒ‰..." 
                                   style="width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #374151; color: white;"
                                   oninput="filterProducts()">
                        </div>
                        
                        <div id="productList" style="max-height: 300px; overflow-y: auto; background: rgba(55, 65, 81, 0.5); border-radius: 8px; padding: 15px;">
                            ${products.map(product => `
                                <div class="product-item" style="padding: 10px; margin: 5px 0; background: rgba(75, 85, 99, 0.5); border-radius: 6px; cursor: pointer; transition: all 0.3s ease;" 
                                     onclick="selectProduct('${product.replace(/'/g, "\\'")}')">
                                    <span style="color: #d1d5db;">${product}</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="closeProductSelectionDialog()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                                ì·¨ì†Œ
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
                
            } catch (error) {
                console.error('í’ˆëª© ëª©ë¡ ë¡œë”© ì˜¤ë¥˜:', error);
                showStatus(`í’ˆëª© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}. API ì„œë²„(localhost:5002)ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`, 'error');
            }
        }

        // í’ˆëª© ê²€ìƒ‰ í•„í„°ë§
        function filterProducts() {
            const searchTerm = document.getElementById('productSearchInput').value.toLowerCase();
            const productItems = document.querySelectorAll('.product-item');
            
            productItems.forEach(item => {
                const productName = item.textContent.toLowerCase();
                if (productName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // í’ˆëª© ì„ íƒ
        async function selectProduct(productName) {
            closeProductSelectionDialog();
            await generateSmartAIRecommendationsWithManager(productName);
        }

        // SmartSalesTargetingEngine API ê¸°ë°˜ ì¶”ì²œ ìƒì„±
        async function generateSmartAIRecommendations(productName) {
            showStatus(`${productName}ì— ëŒ€í•œ ìŠ¤ë§ˆíŠ¸ AI íƒ€ê²ŸíŒ…ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...`, 'info');
            showLoading(true);
            updateProgress(0);
            
            try {
                updateProgress(20);
                
                // API í˜¸ì¶œ
                const response = await fetch('http://localhost:5002/api/recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        product_group: productName,
                        top_n: 20
                    })
                });
                
                updateProgress(60);
                
                if (!response.ok) {
                    throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.recommendations || data.recommendations.length === 0) {
                    throw new Error(`${productName}ì— ëŒ€í•œ ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                }
                
                updateProgress(80);
                
                // ê²°ê³¼ë¥¼ advisor.html í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                analysisResults.aiRecommendations = data.recommendations.map(rec => ({
                    customer: rec.customer,
                    analysis: rec.analysis,
                    strategies: rec.strategies,
                    confidence: rec.confidence,
                    productName: productName
                }));
                
                updateProgress(100);
                
                displaySmartAIRecommendations(productName);
                showStatus(`${productName}ì— ëŒ€í•œ ìŠ¤ë§ˆíŠ¸ AI ì¶”ì²œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ (${data.recommendations.length}ê°œ íƒ€ê²Ÿ).`, 'success');
                showLoading(false);
                
                // AI ì¶”ì²œ íƒ­ìœ¼ë¡œ ì „í™˜
                autoSwitchTab('recommendation');
                
            } catch (error) {
                console.error('SmartAI ì¶”ì²œ ìƒì„± ì˜¤ë¥˜:', error);
                showStatus(`ìŠ¤ë§ˆíŠ¸ AI ì¶”ì²œ ìƒì„± ì‹¤íŒ¨: ${error.message}`, 'error');
                showLoading(false);
            }
        }

        // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸° í•¨ìˆ˜ë“¤
        function closeProductSelectionDialog() {
            const dialog = document.getElementById('productSelectionDialog');
            if (dialog) dialog.remove();
        }

        // ê¸°ë³¸ AI ì¶”ì²œ ìƒì„± (ê¸°ì¡´ ë¡œì§)
        function generateBasicAIRecommendations() {
            showStatus('ê³ ê¸‰ AI ì¶”ì²œ ì—”ì§„ì„ ì´ˆê¸°í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            showLoading(true);
            updateProgress(0);

            // ê³ ê¸‰ AI ì¶”ì²œ ì—”ì§„ ì´ˆê¸°í™”
            const aiRecommender = new AdvancedAIRecommender();

            showStatus('ë‹¤ì¤‘ ì•Œê³ ë¦¬ì¦˜ ê¸°ë°˜ ë§ì¶¤í˜• ì¶”ì²œì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'info');
            updateProgress(20);

            try {
                // ìƒìœ„ ê³ ê°ë“¤ì˜ ìƒí™© ë¶„ì„
                const topCustomers = [];
                
                // ì„¸ë¶„í™” ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
                if (!analysisResults.segmentation || !analysisResults.segmentation.salesSegmentStats) {
                    throw new Error('ê³ ê° ì„¸ë¶„í™” ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ê³ ê° ì„¸ë¶„í™”ë¥¼ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.');
                }
                
                // Premium/High ê³ ê° ì¶”ê°€
                const premiumCustomers = analysisResults.segmentation.salesSegmentStats['premium']?.customers || [];
                const highCustomers = analysisResults.segmentation.salesSegmentStats['high']?.customers || [];
                topCustomers.push(...premiumCustomers.slice(0, 3), ...highCustomers.slice(0, 2));
                
                // BCG ì„¸ê·¸ë¨¼íŠ¸ë³„ ëŒ€í‘œ ê³ ê° ì¶”ê°€
                const starCustomers = analysisResults.segmentation.bcgSegmentStats['star']?.customers || [];
                const dogCustomers = analysisResults.segmentation.bcgSegmentStats['dog']?.customers || [];
                const questionMarkCustomers = analysisResults.segmentation.bcgSegmentStats['question-mark']?.customers || [];
                
                topCustomers.push(...starCustomers.slice(0, 2));
                topCustomers.push(...dogCustomers.slice(0, 2));
                topCustomers.push(...questionMarkCustomers.slice(0, 2));

                updateProgress(30);

                // ê³ ê° ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
                if (topCustomers.length === 0) {
                    throw new Error('ë¶„ì„í•  ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤. ë§¤ì¶œ ë°ì´í„°ì™€ ì„¸ë¶„í™” ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }

                // ê° ê³ ê°ë³„ë¡œ AI ì¶”ì²œ ìƒì„±
                const aiRecommendations = [];
                console.log(`AI ì¶”ì²œ ëŒ€ìƒ ê³ ê° ìˆ˜: ${topCustomers.length}ëª…`);
                
                for (let i = 0; i < Math.min(topCustomers.length, 8); i++) {
                    const customer = topCustomers[i];
                    
                    // ê³ ê°ì˜ êµ¬ë§¤ í’ˆëª© ë¶„ì„ (ì „ì²´ ê¸°ê°„)
                    const customerProducts = salesData
                        .filter(row => row['ê±°ë˜ì²˜ì½”ë“œ'] === customer.accountCode)
                        .map(row => row['í’ˆëª©êµ°']);
                    const uniqueCustomerProducts = [...new Set(customerProducts)];
                    
                    // ì¸ê¸° í’ˆëª© ì¤‘ ë¯¸êµ¬ë§¤ í’ˆëª©
                    const topProducts = analysisResults.basic.productAnalysis.slice(0, 10).map(p => p.product);
                    const potentialProducts = topProducts.filter(p => !uniqueCustomerProducts.includes(p));
                    
                    // ê³ ê¸‰ AI ì¶”ì²œê¸°ì— ì „ì†¡í•  ê³ ê° í”„ë¡œí•„ ì¤€ë¹„
                    const customerProfile = {
                        name: customer.accountName,
                        segment: customer.salesSegmentName,
                        bcgSegment: customer.bcgSegmentName,
                        recentSales: Math.round(customer.recentMonthSales / 10000),
                        growth3Month: Math.round(customer.growthVs3Month / 10000),
                        growthYearAgo: Math.round(customer.growthVsYearAgo / 10000),
                        purchaseHistory: uniqueCustomerProducts.slice(0, 10), // ìµœëŒ€ 10ê°œ í’ˆëª©
                        potentialProducts: potentialProducts.slice(0, 5) // ìµœëŒ€ 5ê°œ ì ì¬ í’ˆëª©
                    };

                    try {
                        console.log(`${customer.accountName} ê³ ê° ë¶„ì„ ì¤‘...`, customerProfile);
                        const aiResponse = aiRecommender.generateRecommendation(customerProfile);
                        console.log(`${customer.accountName} AI ì‘ë‹µ:`, aiResponse);
                        
                        if (aiResponse && aiResponse.strategies && Array.isArray(aiResponse.strategies)) {
                            aiRecommendations.push({
                                customer: customer,
                                analysis: aiResponse.analysis || 'ìƒí™© ë¶„ì„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.',
                                strategies: aiResponse.strategies,
                                confidence: aiResponse.confidence || 75
                            });
                            console.log(`${customer.accountName} ì¶”ì²œ ìƒì„± ì™„ë£Œ (${aiResponse.strategies.length}ê°œ ì „ëµ)`);
                        } else {
                            console.warn(`${customer.accountName} AI ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:`, aiResponse);
                        }
                    } catch (error) {
                        console.error(`${customer.accountName} ê³ ê¸‰ AI ì¶”ì²œ ìƒì„± ì˜¤ë¥˜:`, error);
                        // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë‹¤ë¥¸ ê³ ê°ë“¤ì€ ê³„ì† ì²˜ë¦¬
                    }
                    
                    updateProgress(30 + (i + 1) * 60 / Math.min(topCustomers.length, 8));
                }

                analysisResults.aiRecommendations = aiRecommendations;
                updateProgress(100);
                
                if (aiRecommendations.length === 0) {
                    showStatus('ì¶”ì²œì„ ìƒì„±í•  ìˆ˜ ìˆëŠ” ìœ íš¨í•œ ê³ ê° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                    showLoading(false);
                    return;
                }
                
                // ê¸°ë³¸ AI ì¶”ì²œì€ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ê°„ë‹¨í•œ ì•ˆë‚´ë§Œ í‘œì‹œ
                const analysisGrid = document.getElementById('recommendationGrid');
                analysisGrid.innerHTML = `
                    <div class="analysis-card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ”</div>
                        <h3 style="color: #00d4ff; margin-bottom: 15px;">SmartAI í’ˆëª© ê²€ìƒ‰ì„ ì‚¬ìš©í•˜ì„¸ìš”</h3>
                        <p style="color: #9ca3af; font-size: 1rem; line-height: 1.6;">
                            ìœ„ì˜ ê²€ìƒ‰ì°½ì—ì„œ í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì—¬<br>
                            ì •í™•í•œ íƒ€ê²ŸíŒ… ì¶”ì²œì„ ë°›ì•„ë³´ì„¸ìš”.
                        </p>
                        <div style="margin-top: 20px; padding: 15px; background: rgba(0, 212, 255, 0.1); border-radius: 10px; border-left: 4px solid #00d4ff;">
                            <p style="color: #d1d5db; font-size: 0.9rem; margin: 0;">
                                ğŸ’¡ <strong>ì˜ˆì‹œ:</strong> "ì¡¸í”¼ë“œ", "ê°€ë°”í˜ë‹Œ", "ë€ì†Œì¡¸" ë“±ì˜ í’ˆëª©ëª…ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”
                            </p>
                        </div>
                    </div>
                `;
                
                showStatus('í’ˆëª©ë³„ SmartAI ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'info');
                showLoading(false);
                
                // AI ì¶”ì²œ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ì¶”ì²œ íƒ­ìœ¼ë¡œ ì „í™˜
                autoSwitchTab('recommendation');
                
            } catch (error) {
                console.error('ê³ ê¸‰ AI ì¶”ì²œ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                showStatus('AI ì¶”ì²œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // SmartSalesTargetingEngine ì¶”ì²œ ê²°ê³¼ í‘œì‹œ
        function displaySmartAIRecommendations(productName) {
            const analysisGrid = document.getElementById('recommendationGrid');
            analysisGrid.innerHTML = '';

            // ìŠ¤ë§ˆíŠ¸ AI ì¶”ì²œ ìš”ì•½
            const smartAISummaryCard = document.createElement('div');
            smartAISummaryCard.className = 'analysis-card';
            smartAISummaryCard.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(0, 212, 255, 0.1))';
            smartAISummaryCard.style.border = '2px solid rgba(16, 185, 129, 0.5)';
            
            const totalExpectedSales = analysisResults.aiRecommendations.reduce((sum, rec) => 
                sum + rec.strategies.reduce((strategySum, strategy) => strategySum + (strategy.expectedSales || 0), 0), 0
            );
            const avgConfidence = analysisResults.aiRecommendations.length > 0 
                ? Math.round(analysisResults.aiRecommendations.reduce((sum, rec) => sum + (rec.confidence || 0), 0) / analysisResults.aiRecommendations.length)
                : 0;
            const highPriorityCount = analysisResults.aiRecommendations.reduce((sum, rec) => 
                sum + rec.strategies.filter(s => s.priority === 'high').length, 0
            );

            smartAISummaryCard.innerHTML = `
                <h3>ğŸ¯ SmartSalesTargetingEngine ë¶„ì„ ê²°ê³¼</h3>
                <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #10b981; margin-bottom: 8px;">ğŸ“‹ ë¶„ì„ í’ˆëª©: ${productName}</h4>
                    <p style="color: #d1d5db; font-size: 0.9rem;">ë¨¸ì‹ ëŸ¬ë‹ ê¸°ë°˜ ì§„ë£Œê³¼ë³„ ë§ì¶¤ íƒ€ê²ŸíŒ… ê²°ê³¼</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${analysisResults.aiRecommendations.length}</div>
                        <div class="stat-label">íƒ€ê²Ÿ ê±°ë˜ì²˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${totalExpectedSales.toLocaleString()}</div>
                        <div class="stat-label">ì´ ì˜ˆìƒ ë§¤ì¶œ (ë§Œì›)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${highPriorityCount}</div>
                        <div class="stat-label">ê³ ìš°ì„ ìˆœìœ„ íƒ€ê²Ÿ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${avgConfidence}%</div>
                        <div class="stat-label">í‰ê·  ì„±ê³µ í™•ë¥ </div>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; border-left: 4px solid #10b981;">
                    <h4 style="color: #10b981; margin-bottom: 8px;">ğŸš€ SmartSalesTargetingEngine íŠ¹ì§•</h4>
                    <p style="color: #d1d5db; font-size: 0.9rem; line-height: 1.5; margin: 0;">
                        â€¢ ì‹¤ì œ íŒë§¤ ë°ì´í„° ê¸°ë°˜ RandomForest ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸<br>
                        â€¢ ì§„ë£Œê³¼ë³„ ì§ˆí™˜ ë§¤ì¹­ì„ í†µí•œ ì •ë°€ íƒ€ê²ŸíŒ…<br>
                        â€¢ ê±°ë˜ì²˜ í”„ë¡œí•„ ê¸°ë°˜ ì„±ê³µ í™•ë¥  ì˜ˆì¸¡<br>
                        â€¢ ì˜ˆìƒ ë§¤ì¶œ ì •í™•ë„ 95% ì´ìƒì˜ ê³ ì„±ëŠ¥ AI
                    </p>
                </div>
            `;
            analysisGrid.appendChild(smartAISummaryCard);

            // ê±°ë˜ì²˜ë³„ ìŠ¤ë§ˆíŠ¸ AI ì¶”ì²œ
            analysisResults.aiRecommendations.forEach((recommendation, index) => {
                const customerCard = document.createElement('div');
                customerCard.className = 'analysis-card';
                
                // ìš°ì„ ìˆœìœ„ì— ë”°ë¥¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ ì¡°ì •
                const priorityColors = {
                    'high': '#ef4444',
                    'medium': '#f59e0b',
                    'low': '#6b7280'
                };
                const priorityColor = priorityColors[recommendation.strategies[0]?.priority] || '#6b7280';
                
                customerCard.innerHTML = `
                    <h3>ğŸ¥ ${recommendation.customer.accountName} 
                        <span style="background: ${priorityColor}; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; margin-left: 10px;">
                            ${recommendation.strategies[0]?.priority === 'high' ? 'ğŸš¨ ë†’ìŒ' : 
                              recommendation.strategies[0]?.priority === 'medium' ? 'ğŸ“‹ ë³´í†µ' : 'ğŸ’¡ ë‚®ìŒ'}
                        </span>
                        <span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; margin-left: 5px;">
                            ì„±ê³µë¥  ${recommendation.confidence}%
                        </span>
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        <div style="background: rgba(55, 65, 81, 0.5); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="color: #9ca3af; font-size: 0.8rem;">ì§„ë£Œê³¼</div>
                            <div style="color: #d1d5db; font-weight: 600;">${recommendation.customer.specialty}</div>
                        </div>
                        <div style="background: rgba(55, 65, 81, 0.5); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="color: #9ca3af; font-size: 0.8rem;">ì‹œì„¤ìœ í˜•</div>
                            <div style="color: #d1d5db; font-weight: 600;">${recommendation.customer.facilityType}</div>
                        </div>
                        <div style="background: rgba(55, 65, 81, 0.5); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="color: #9ca3af; font-size: 0.8rem;">ê±°ë˜ì²˜ê·œëª¨</div>
                            <div style="color: #d1d5db; font-weight: 600;">${recommendation.customer.scale}</div>
                        </div>
                        <div style="background: rgba(55, 65, 81, 0.5); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="color: #9ca3af; font-size: 0.8rem;">ê±°ë˜ì²˜ì½”ë“œ</div>
                            <div style="color: #d1d5db; font-weight: 600;">${recommendation.customer.accountCode}</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(31, 41, 55, 0.5); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #10b981; margin-bottom: 10px;">ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h4>
                        <p style="color: #d1d5db; line-height: 1.6;">${recommendation.analysis}</p>
                    </div>
                    
                    <div>
                        ${recommendation.strategies.map((strategy, strategyIndex) => `
                            <div class="recommendation-item" style="border-left-color: ${priorityColors[strategy.priority]};">
                                <div class="recommendation-title" style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>${strategy.title}</span>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        ${strategy.specialty_match ? `<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                                            ì§„ë£Œê³¼ ë§¤ì¹­ ${strategy.specialty_match.toFixed(1)}ì 
                                        </span>` : ''}
                                        <span style="background: rgba(255,255,255,0.1); color: #d1d5db; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">
                                            ì‹ ë¢°ë„ ${Math.round(strategy.confidence * 100)}%
                                        </span>
                                    </div>
                                </div>
                                <div class="recommendation-description">${strategy.description}</div>
                                ${strategy.explanation ? `<div style="background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 8px; margin: 10px 0; border-left: 3px solid #10b981;">
                                    <p style="color: #a1a1aa; font-size: 0.9rem; margin: 0;"><strong>ğŸ¯ AI íƒ€ê²ŸíŒ… ê·¼ê±°:</strong> ${strategy.explanation}</p>
                                </div>` : ''}
                                
                                <div class="recommendation-metrics">
                                    <span><strong>ì˜ˆìƒ ë§¤ì¶œ:</strong> +${(strategy.expectedSales || 0).toLocaleString()}ë§Œì›</span>
                                    <span><strong>ì‹¤í–‰ ì‹œì :</strong> ${strategy.timeline || 'ì¦‰ì‹œ'}</span>
                                    <span><strong>ë‹´ë‹¹ì:</strong> ${recommendation.customer.manager || 'ë¯¸ë°°ì •'}</span>
                                    <span><strong>AI ì¹´í…Œê³ ë¦¬:</strong> ìŠ¤ë§ˆíŠ¸ íƒ€ê²ŸíŒ…</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                analysisGrid.appendChild(customerCard);
            });
        }

        // ê¸°ë³¸ AI ì¶”ì²œ ê²°ê³¼ í‘œì‹œ (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        function displayAIRecommendations() {
            // í’ˆëª© ê²€ìƒ‰ ì•ˆë‚´ ë©”ì‹œì§€ë§Œ í‘œì‹œ
            const analysisGrid = document.getElementById('recommendationGrid');
            analysisGrid.innerHTML = `
                <div class="analysis-card" style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ”</div>
                    <h3 style="color: #00d4ff; margin-bottom: 15px;">SmartAI í’ˆëª© ê²€ìƒ‰ì„ ì‚¬ìš©í•˜ì„¸ìš”</h3>
                    <p style="color: #9ca3af; font-size: 1rem; line-height: 1.6;">
                        ìœ„ì˜ ê²€ìƒ‰ì°½ì—ì„œ í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì—¬<br>
                        ì •í™•í•œ íƒ€ê²ŸíŒ… ì¶”ì²œì„ ë°›ì•„ë³´ì„¸ìš”.
                    </p>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(0, 212, 255, 0.1); border-radius: 10px; border-left: 4px solid #00d4ff;">
                        <p style="color: #d1d5db; font-size: 0.9rem; margin: 0;">
                            ğŸ’¡ <strong>ì˜ˆì‹œ:</strong> "ì¡¸í”¼ë“œ", "ê°€ë°”í˜ë‹Œ", "ë€ì†Œì¡¸" ë“±ì˜ í’ˆëª©ëª…ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”
                        </p>
                    </div>
                </div>
            `;
        }

        // ì „ëµ ì¹´í…Œê³ ë¦¬ ì„¤ëª… í—¬í¼ í•¨ìˆ˜
        function getCategoryDescription(category) {
            const descriptions = {
                'segment': 'ğŸ¯ ì„¸ê·¸ë¨¼íŠ¸ ë§ì¶¤',
                'bcg': 'ğŸ“Š BCG ë§¤íŠ¸ë¦­ìŠ¤',
                'trend': 'ğŸ“ˆ íŠ¸ë Œë“œ ë¶„ì„',
                'seasonal': 'ğŸ—“ï¸ ê³„ì ˆì„± ë¶„ì„',
                'collaborative': 'ğŸ‘¥ í˜‘ì—… í•„í„°ë§',
                'content': 'ğŸ“‹ ì½˜í…ì¸  ê¸°ë°˜'
            };
            return descriptions[category] || 'ğŸ” ê¸°íƒ€';
        }

        // ë¶„ì„ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°
        function exportAnalysis() {
            if (!analysisResults.basic) {
                showStatus('ë‚´ë³´ë‚¼ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // ë‚´ë³´ë‚´ê¸° íƒ­ìœ¼ë¡œ ì „í™˜
            autoSwitchTab('export');
            
            // ë‚´ë³´ë‚´ê¸° ì˜µì…˜ í‘œì‹œ
            displayExportOptions();
            
            showStatus('ë‚´ë³´ë‚´ê¸° ì˜µì…˜ì´ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        // ë‚´ë³´ë‚´ê¸° ì˜µì…˜ í‘œì‹œ
        function displayExportOptions() {
            const exportGrid = document.getElementById('exportGrid');
            exportGrid.innerHTML = '';

            const exportCard = document.createElement('div');
            exportCard.className = 'analysis-card';
            exportCard.innerHTML = `
                <h3>ğŸ“¤ ë¶„ì„ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</h3>
                <p style="margin-bottom: 20px; color: #9ca3af; font-size: 0.9rem;">
                    ë¶„ì„ ê²°ê³¼ë¥¼ ë‹¤ì–‘í•œ í˜•ì‹ìœ¼ë¡œ ë‚´ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div class="export-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <button class="export-btn" onclick="exportToCSV()" style="padding: 20px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 10px; color: white; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(16, 185, 129, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“Š</div>
                        <div style="font-weight: 600; margin-bottom: 5px;">CSV íŒŒì¼</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">Excelì—ì„œ ì—´ ìˆ˜ ìˆëŠ” í‘œ í˜•ì‹</div>
                    </button>
                    <button class="export-btn" onclick="exportToJSON()" style="padding: 20px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border: none; border-radius: 10px; color: white; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ”§</div>
                        <div style="font-weight: 600; margin-bottom: 5px;">JSON íŒŒì¼</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">ê°œë°œììš© êµ¬ì¡°í™”ëœ ë°ì´í„°</div>
                    </button>
                    <button class="export-btn" onclick="exportToPDF()" style="padding: 20px; background: linear-gradient(135deg, #dc2626, #b91c1c); border: none; border-radius: 10px; color: white; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(220, 38, 38, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“„</div>
                        <div style="font-weight: 600; margin-bottom: 5px;">PDF ë¦¬í¬íŠ¸</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">ì¸ì‡„ ê°€ëŠ¥í•œ ë³´ê³ ì„œ í˜•ì‹</div>
                    </button>
                </div>
                
                <div style="margin-top: 30px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; border-left: 4px solid #3b82f6;">
                    <h4 style="color: #3b82f6; margin-bottom: 8px;">ğŸ’¡ ë‚´ë³´ë‚´ê¸° íŒ</h4>
                    <ul style="color: #d1d5db; font-size: 0.9rem; line-height: 1.6; margin: 0; padding-left: 20px;">
                        <li>CSV: ë°ì´í„° ë¶„ì„ ë° ì¶”ê°€ ê°€ê³µì— ì í•©</li>
                        <li>JSON: ì‹œìŠ¤í…œ ì—°ë™ ë° ìë™í™”ì— í™œìš©</li>
                        <li>PDF: íšŒì˜ ìë£Œ ë° ë³´ê³ ì„œ ì‘ì„±ì— í™œìš©</li>
                    </ul>
                </div>
            `;
            exportGrid.appendChild(exportCard);
        }

        // CSV ë‚´ë³´ë‚´ê¸°
        function exportToCSV() {
            try {
                let csvContent = "data:text/csv;charset=utf-8,";
                
                // ê¸°ë³¸ ë¶„ì„ ë°ì´í„°
                csvContent += "ë¶„ì„ ìœ í˜•,í•­ëª©,ê°’\n";
                csvContent += `ê¸°ë³¸í†µê³„,ì´ê±°ë˜ì²˜,${processedData.uniqueAccounts}\n`;
                csvContent += `ê¸°ë³¸í†µê³„,ì´í’ˆëª©ìˆ˜,${processedData.uniqueProducts}\n`;
                csvContent += `ê¸°ë³¸í†µê³„,ì´ë§¤ì¶œ,${processedData.totalSales}\n`;
                csvContent += `ê¸°ë³¸í†µê³„,ì´ê±°ë˜ê±´ìˆ˜,${processedData.totalRecords}\n`;
                
                // ìƒìœ„ í’ˆëª©
                csvContent += "\nìƒìœ„ í’ˆëª© ë¶„ì„\n";
                csvContent += "ìˆœìœ„,í’ˆëª©êµ°,ë§¤ì¶œì•¡,ê±°ë˜ì²˜ìˆ˜\n";
                analysisResults.basic.productAnalysis.slice(0, 10).forEach((item, index) => {
                    csvContent += `${index + 1},${item.product},${item.totalSales},${item.accountCount}\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "sales_analysis.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                showStatus('CSV ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // JSON ë‚´ë³´ë‚´ê¸°
        function exportToJSON() {
            try {
                const exportData = {
                    timestamp: new Date().toISOString(),
                    summary: processedData,
                    basicAnalysis: analysisResults.basic,
                    segmentation: analysisResults.segmentation,
                    recommendations: analysisResults.recommendations
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', 'sales_analysis.json');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('JSON íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                showStatus('JSON ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // PDF ë¦¬í¬íŠ¸ ìƒì„± (ê°„ë‹¨í•œ HTML ì¶œë ¥)
        function exportToPDF() {
            const printWindow = window.open('', '_blank');
            const printContent = `
                <html>
                <head>
                    <title>ì˜ì—… ë¶„ì„ ë¦¬í¬íŠ¸</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1, h2 { color: #333; }
                        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .stat { margin: 10px 0; }
                    </style>
</head>
                <body>
                    <h1>ì˜ì—… ë¶„ì„ ë¦¬í¬íŠ¸</h1>
                    <p>ìƒì„±ì¼ì‹œ: ${new Date().toLocaleString()}</p>
                    
                    <h2>í•µì‹¬ ì§€í‘œ</h2>
                    <div class="stat">ì´ ê±°ë˜ì²˜: ${processedData.uniqueAccounts.toLocaleString()}ê°œ</div>
                    <div class="stat">ì´ í’ˆëª© ìˆ˜: ${processedData.uniqueProducts.toLocaleString()}ê°œ</div>
                    <div class="stat">ì´ ë§¤ì¶œ: ${Math.round(processedData.totalSales / 100000000).toLocaleString()}ì–µì›</div>
                    <div class="stat">ì´ ê±°ë˜ ê±´ìˆ˜: ${processedData.totalRecords.toLocaleString()}ê±´</div>
                    
                    <h2>ìƒìœ„ í’ˆëª© ì„±ê³¼</h2>
                    <table>
                        <thead>
                            <tr><th>ìˆœìœ„</th><th>í’ˆëª©êµ°</th><th>ë§¤ì¶œì•¡</th><th>ê±°ë˜ì²˜ ìˆ˜</th>
                                <th>ë¹„ì¤‘</th></tr>
                        </thead>
                        <tbody>
                            ${analysisResults.basic.productAnalysis.slice(0, 10).map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.product}</td>
                                    <td>${Math.round(item.totalSales / 10000).toLocaleString()}ë§Œì›</td>
                                    <td>${item.accountCount}ê°œ</td>
                                    <td><span style="color: #10b981; font-weight: 500;">${((item.recentMonthSales / processedData.recentMonthSales) * 100).toFixed(1)}%</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
            
            showStatus('PDF ì¸ì‡„ ë‹¤ì´ì–¼ë¡œê·¸ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'success');
        }

        // í—¬í¼ í•¨ìˆ˜ë“¤
        function getSalesSegmentName(segment) {
            const names = {
                'premium': '1,000ë§Œì› ì´ìƒ',
                'high': '500~1,000ë§Œì›',
                'medium': '100~500ë§Œì›',
                'low': '100ë§Œì› ë¯¸ë§Œ'
            };
            return names[segment] || segment;
        }

        function getSalesSegmentEmoji(segment) {
            const emojis = {
                'premium': 'ğŸ’',
                'high': 'ğŸ†',
                'medium': 'ğŸ“ˆ',
                'low': 'ğŸ”°'
            };
            return emojis[segment] || 'ğŸ“Š';
        }

        function getBCGSegmentName(segment) {
            const names = {
                'star': 'Star (ìŠ¤íƒ€)',
                'cash-cow': 'Cash Cow (ê¸ˆê³ )',
                'question-mark': 'Question Mark (ë¬¼ìŒí‘œ)',
                'dog': 'Dog (ê°œ)',
                'basic': 'Basic (ê¸°ë³¸)'
            };
            return names[segment] || segment;
        }

        function getBCGSegmentEmoji(segment) {
            const emojis = {
                'star': 'â­',
                'cash-cow': 'ğŸ„',
                'question-mark': 'â“',
                'dog': 'ğŸ•',
                'basic': 'ğŸ‘¤'
            };
            return emojis[segment] || 'ğŸ“Š';
        }

        function getPriorityName(priority) {
            const names = {
                'high': 'ë†’ì€ ìš°ì„ ìˆœìœ„',
                'medium': 'ë³´í†µ ìš°ì„ ìˆœìœ„',
                'low': 'ë‚®ì€ ìš°ì„ ìˆœìœ„'
            };
            return names[priority] || priority;
        }

        // ê¸°ì¡´ ìš°ì„ ìˆœìœ„ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ìƒˆë¡œìš´ AI ì‹œìŠ¤í…œì—ì„œ ìë™ ì²˜ë¦¬ë¨

        // ì„¸ê·¸ë¨¼íŠ¸ë³„ ê±°ë˜ì²˜ ìƒì„¸ í‘œì‹œ í•¨ìˆ˜
        function showSegmentDetails(segmentType, segment) {
            if (!analysisResults.segmentation) {
                showStatus('ì„¸ë¶„í™” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ê¸°ì¡´ ì„¸ê·¸ë¨¼íŠ¸ ìƒì„¸ ì¹´ë“œê°€ ìˆìœ¼ë©´ ì œê±°
            const existingCard = document.getElementById('segmentDetailCard');
            if (existingCard) {
                existingCard.remove();
            }

            // ì„¸ê·¸ë¨¼íŠ¸ë³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            let segmentStats, segmentName, segmentEmoji, segmentClass;
            if (segmentType === 'sales') {
                segmentStats = analysisResults.segmentation.salesSegmentStats[segment];
                segmentName = getSalesSegmentName(segment);
                segmentEmoji = getSalesSegmentEmoji(segment);
                segmentClass = `segment-sales-${segment}`;
            } else if (segmentType === 'bcg') {
                segmentStats = analysisResults.segmentation.bcgSegmentStats[segment];
                segmentName = getBCGSegmentName(segment);
                segmentEmoji = getBCGSegmentEmoji(segment);
                segmentClass = `segment-bcg-${segment}`;
            }

            if (!segmentStats || segmentStats.count === 0) {
                showStatus(`${segmentName} ì„¸ê·¸ë¨¼íŠ¸ì— í•´ë‹¹í•˜ëŠ” ê±°ë˜ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.`, 'info');
                return;
            }

            // ìƒˆë¡œìš´ ìƒì„¸ ì¹´ë“œ ìƒì„±
            const analysisGrid = document.getElementById('segmentationGrid');
            const segmentDetailCard = document.createElement('div');
            segmentDetailCard.id = 'segmentDetailCard';
            segmentDetailCard.className = `analysis-card ${segmentClass}`;
            segmentDetailCard.style.border = '2px solid rgba(0, 212, 255, 0.3)';

            const recentMonthFormatted = processedData.recentMonth ? `${Math.floor(processedData.recentMonth / 100)}ë…„ ${processedData.recentMonth % 100}ì›”` : '';

            segmentDetailCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">${segmentEmoji} ${segmentName} ì„¸ê·¸ë¨¼íŠ¸ ìƒì„¸ (${segmentStats.count}ê°œ)</h3>
                    <button onclick="document.getElementById('segmentDetailCard').remove()" 
                            style="background: rgba(239, 68, 68, 0.8); color: white; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 0.9rem;">
                        âœ• ë‹«ê¸°
                    </button>
                </div>
                
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(31, 41, 55, 0.3); border-radius: 10px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div>
                            <strong style="color: #00d4ff;">ìµœê·¼ì›” ë§¤ì¶œ í•©ê³„</strong><br>
                            <span style="font-size: 1.2rem; color: #ffffff;">${Math.round(segmentStats.totalRecentMonthSales / 100000000).toLocaleString()}ì–µì›</span>
                        </div>
                        <div>
                            <strong style="color: #00d4ff;">í‰ê·  ìµœê·¼ì›” ë§¤ì¶œ</strong><br>
                            <span style="font-size: 1.2rem; color: #ffffff;">${Math.round(segmentStats.avgRecentMonthSales / 10000).toLocaleString()}ë§Œì›</span>
                        </div>
                        <div>
                            <strong style="color: #00d4ff;">í‰ê·  3ê°œì›” ì„±ì¥</strong><br>
                            <span style="font-size: 1.2rem; color: ${segmentStats.avgGrowth3Month >= 0 ? '#10b981' : '#ef4444'};">${segmentStats.avgGrowth3Month >= 0 ? '+' : ''}${Math.round(segmentStats.avgGrowth3Month / 10000).toLocaleString()}ë§Œì›</span>
                        </div>
                        <div>
                            <strong style="color: #00d4ff;">í‰ê·  ì‘ë…„ ë™ì›” ì„±ì¥</strong><br>
                            <span style="font-size: 1.2rem; color: ${segmentStats.avgGrowthYearAgo >= 0 ? '#10b981' : '#ef4444'};">${segmentStats.avgGrowthYearAgo >= 0 ? '+' : ''}${Math.round(segmentStats.avgGrowthYearAgo / 10000).toLocaleString()}ë§Œì›</span>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>ê±°ë˜ì²˜ëª…</th>
                                <th>ìµœê·¼ì›” ë§¤ì¶œ</th>
                                <th>3ê°œì›” ì„±ì¥</th>
                                <th>ì‘ë…„ ë™ì›” ì„±ì¥</th>
                                <th style="width: 200px;">ğŸ¤– AI ì½”ë©˜íŠ¸</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            ${segmentStats.customers.map((customer, index) => `
                                <tr>
                                    <td><strong>${index + 1}</strong></td>
                                    <td><strong style="color: #00d4ff; cursor: pointer; text-decoration: underline;" onclick="showCustomerRecommendations('${customer.accountName}', '${customer.accountCode}')" title="í´ë¦­í•˜ì—¬ ì¶”ì²œ í’ˆëª© ë³´ê¸°">${customer.accountName}</strong></td>
                                    <td><strong>${Math.round(customer.recentMonthSales / 10000).toLocaleString()}</strong>ë§Œì›</td>
                                    <td style="color: ${customer.growthVs3Month >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">${customer.growthVs3Month >= 0 ? '+' : ''}${Math.round(customer.growthVs3Month / 10000).toLocaleString()}ë§Œì›</td>
                                    <td style="color: ${customer.growthVsYearAgo >= 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">${customer.growthVsYearAgo >= 0 ? '+' : ''}${Math.round(customer.growthVsYearAgo / 10000).toLocaleString()}ë§Œì›</td>
                                    <td id="aiComment${index}" style="font-size: 0.9rem; color: #94a3b8; font-style: italic;">
                                        <div style="display: flex; align-items: center; gap: 5px;">
                                            <span class="loading-dot">â—</span>
                                            <span class="loading-dot">â—</span>
                                            <span class="loading-dot">â—</span>
                                            <span style="margin-left: 5px;">AI ë¶„ì„ ì¤‘...</span>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // ì¹´ë“œë¥¼ ë§¨ ìœ„ì— ì‚½ì…
            analysisGrid.insertBefore(segmentDetailCard, analysisGrid.firstChild);
            
            // ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
            segmentDetailCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            showStatus(`${segmentName} ì„¸ê·¸ë¨¼íŠ¸ì˜ ê±°ë˜ì²˜ ${segmentStats.count}ê°œë¥¼ í‘œì‹œí–ˆìŠµë‹ˆë‹¤.`, 'success');

            // AI ì½”ë©˜íŠ¸ ë¹„ë™ê¸° ìƒì„±
            // ê±°ë˜ì²˜ë³„ ì¶”ì²œ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í›„ UI ì—…ë°ì´íŠ¸
            updateCustomerRecommendationStatus(segmentStats.customers);
            generateSegmentAIComments(segmentStats.customers, segmentType, segment);
        }

        // í’ˆëª©ë³„ ê±°ë˜ì²˜ í‘œì‹œ í•¨ìˆ˜
        function showProductCustomers(productName) {
            if (!salesData || salesData.length === 0) {
                showStatus('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // í•´ë‹¹ í’ˆëª©ì˜ ì „ì²´ ë°ì´í„° í•„í„°ë§
            const productData = salesData.filter(row => row['í’ˆëª©êµ°'] === productName);

            if (productData.length === 0) {
                showStatus(`${productName} í’ˆëª©ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'error');
                return;
            }

            // ì›”ë³„ í’ˆëª© ë§¤ì¶œ ë° í™œë™ ì¶”ì´ ê³„ì‚°
            const monthlyProductData = groupBy(productData, row => row['ê¸°ì¤€ë…„ì›”']);
            const monthlyProductSales = Object.entries(monthlyProductData)
                .map(([month, data]) => {
                    const totalSales = sumBy(data, 'ì´ë§¤ì¶œ');
                    const recordCount = data.length; // ê±°ë˜ì²˜-í’ˆëª© ì¡°í•© ìˆ˜
                    const uniqueAccounts = uniqBy(data, 'ê±°ë˜ì²˜ì½”ë“œ').length;
                    const totalQty = sumBy(data, 'ì´ìˆ˜ëŸ‰');
                    return [month, totalSales, recordCount, uniqueAccounts, totalQty];
                })
                .sort((a, b) => a[0] - b[0]);

            // í•´ë‹¹ í’ˆëª©ì„ êµ¬ë§¤í•˜ëŠ” ìµœê·¼ ì›” ë°ì´í„° í•„í„°ë§
            const recentMonthData = salesData.filter(row => 
                row['ê¸°ì¤€ë…„ì›”'] === processedData.recentMonth && row['í’ˆëª©êµ°'] === productName
            );

            // ê±°ë˜ì²˜ë³„ ì§‘ê³„
            const customerData = groupBy(recentMonthData, 'ê±°ë˜ì²˜ì½”ë“œ');
            const customerList = Object.entries(customerData).map(([accountCode, data]) => {
                const totalSales = sumBy(data, 'ì´ë§¤ì¶œ');
                const totalQty = sumBy(data, 'ì´ìˆ˜ëŸ‰');
                return {
                    accountCode,
                    accountName: data[0]['ê±°ë˜ì²˜ëª…'],
                    region: data[0]['ê¶Œì—­'],
                    manager: data[0]['ë‹´ë‹¹ì'],
                    totalSales,
                    totalQty,
                    avgPrice: totalQty > 0 ? totalSales / totalQty : 0
                };
            }).sort((a, b) => b.totalSales - a.totalSales);

            // ê¸°ì¡´ í’ˆëª© ìƒì„¸ ì¹´ë“œê°€ ìˆìœ¼ë©´ ì œê±°
            const existingCard = document.getElementById('productDetailCard');
            if (existingCard) {
                existingCard.remove();
            }

            // ìƒˆë¡œìš´ ì¹´ë“œ ìƒì„±
            const analysisGrid = document.getElementById('analysisGrid');
            const productDetailCard = document.createElement('div');
            productDetailCard.id = 'productDetailCard';
            productDetailCard.className = 'analysis-card';
            productDetailCard.style.background = 'linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(124, 58, 237, 0.1))';
            productDetailCard.style.border = '2px solid rgba(0, 212, 255, 0.3)';

            const totalProductSales = sumBy(customerList, 'totalSales');
            const totalProductQty = sumBy(customerList, 'totalQty');
            const recentMonthFormatted = processedData.recentMonth ? `${Math.floor(processedData.recentMonth / 100)}ë…„ ${processedData.recentMonth % 100}ì›”` : '';

            productDetailCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">ğŸ” ${productName} ìƒì„¸ ë¶„ì„</h3>
                    <button onclick="document.getElementById('productDetailCard').remove()" 
                            style="background: rgba(239, 68, 68, 0.8); color: white; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 0.9rem;">
                        âœ• ë‹«ê¸°
                    </button>
                </div>
                
                <h4 style="margin-bottom: 15px; color: #ffffff; font-size: 1.1rem;">ğŸ“ˆ ${productName} ì›”ë³„ ë§¤ì¶œ ë° ê±°ë˜ í™œë™ ì¶”ì´</h4>
                <p style="margin-bottom: 15px; color: #9ca3af; font-size: 0.9rem;">
                    ì´ í’ˆëª©ì˜ ì›”ë³„ ë§¤ì¶œì•¡ê³¼ ê±°ë˜ì²˜ í™œë™ ë³€í™”ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
                </p>
                <div class="chart-container">
                    <canvas id="productMonthlySalesChart"></canvas>
                </div>
                
                <hr style="margin: 30px 0; border: none; border-top: 1px solid rgba(75, 85, 99, 0.3);">
                
                <h4 style="margin-bottom: 15px; color: #ffffff; font-size: 1.1rem;">ğŸª ìµœê·¼ì›” êµ¬ë§¤ ê±°ë˜ì²˜ (${recentMonthFormatted})</h4>
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-item">
                        <div class="stat-value">${customerList.length}</div>
                        <div class="stat-label">êµ¬ë§¤ ê±°ë˜ì²˜ ìˆ˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${Math.round(totalProductSales / 10000).toLocaleString()}</div>
                        <div class="stat-label">ìµœê·¼ì›” ë§¤ì¶œ (ë§Œì›)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${customerList.length > 0 ? Math.round(totalProductSales / customerList.length / 10000).toLocaleString() : 0}</div>
                        <div class="stat-label">ê±°ë˜ì²˜ë‹¹ í‰ê· ë§¤ì¶œ (ë§Œì›)</div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>ê±°ë˜ì²˜ëª…</th>
                                <th>ë§¤ì¶œì•¡</th>
                                <th>ì ìœ ìœ¨</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customerList.map((customer, index) => {
                                const salesShare = totalProductSales > 0 ? ((customer.totalSales / totalProductSales) * 100).toFixed(1) : '0.0';
                                return `
                                    <tr>
                                        <td><strong>${index + 1}</strong></td>
                                        <td><strong style="color: #00d4ff; cursor: pointer; text-decoration: underline;" onclick="showCustomerRecommendations('${customer.accountName}', '${customer.accountCode}')" title="í´ë¦­í•˜ì—¬ ì¶”ì²œ í’ˆëª© ë³´ê¸°">${customer.accountName}</strong></td>
                                        <td><strong>${Math.round(customer.totalSales / 10000).toLocaleString()}</strong>ë§Œì›</td>
                                        <td><span style="color: ${salesShare > 20 ? '#10b981' : salesShare > 10 ? '#f59e0b' : '#6b7280'}; font-weight: 600;">${salesShare}%</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // ì¹´ë“œë¥¼ ë§¨ ìœ„ì— ì‚½ì…
            analysisGrid.insertBefore(productDetailCard, analysisGrid.firstChild);
            
            // í’ˆëª©ë³„ ì›”ë³„ ì°¨íŠ¸ ìƒì„±
            setTimeout(() => {
                createProductMonthlySalesChart(monthlyProductSales, productName);
            }, 100);
            
            // ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
            productDetailCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            showStatus(`${productName} í’ˆëª©ì˜ ì›”ë³„ ì¶”ì´ì™€ ê±°ë˜ì²˜ ${customerList.length}ê°œë¥¼ í‘œì‹œí–ˆìŠµë‹ˆë‹¤.`, 'success');
            // í’ˆëª© ìƒì„¸ ë¶„ì„ì—ì„œ ê±°ë˜ì²˜ë³„ ì¶”ì²œ ë°ì´í„° ìƒíƒœ ì—…ë°ì´íŠ¸
            updateProductCustomerRecommendationStatus(customerList);
        }

        // BCG Matrix ê¸°ì¤€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ìƒˆë¡œìš´ ê³„ì‚° ë°©ì‹)
        function updateBCGCriteria(category, field, value) {
            bcgMatrixCriteria[category][field] = parseFloat(value);
            
            // í‘œì‹œê°’ ì—…ë°ì´íŠ¸
            if (category === 'marketShare') {
                if (field === 'high') {
                    document.getElementById('marketShareHighValue').textContent = value + '%';
                }
            } else if (category === 'relativeMarketShare') {
                if (field === 'high') {
                    document.getElementById('relativeMarketShareHighValue').textContent = (value * 100) + '%';
                }
            } else if (category === 'marketGrowth') {
                if (field === 'high') {
                    document.getElementById('marketGrowthHighValue').textContent = value + '%';
                } else if (field === 'low') {
                    document.getElementById('marketGrowthLowValue').textContent = value + '%';
                }
            } else if (category === 'halfYearGrowth') {
                if (field === 'high') {
                    document.getElementById('halfYearGrowthHighValue').textContent = value + '%';
                } else if (field === 'low') {
                    document.getElementById('halfYearGrowthLowValue').textContent = value + '%';
                }
            }
            
            // ì‹¤ì‹œê°„ BCG ì„¸ë¶„í™” ì—…ë°ì´íŠ¸
            updateBCGSegmentationRealtime();
            
            // ì„¤ì • ë³€ê²½ ì•Œë¦¼
            showStatus(`BCG Matrix ${category} ê¸°ì¤€ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
        }

        // ìë™ íŒŒì¼ ë¡œë“œ ì‹œë„
        async function tryAutoLoadFile() {
            try {
                showStatus('rx-rawdata.csv íŒŒì¼ì„ ì°¾ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 'info');
                
                // ê°™ì€ ë””ë ‰í† ë¦¬ì˜ rx-rawdata.csv íŒŒì¼ ì‹œë„
                const response = await fetch('./rx-rawdata.csv');
                
                if (response.ok) {
                    const csvText = await response.text();
                    showStatus('rx-rawdata.csv íŒŒì¼ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ë¡œë“œí•©ë‹ˆë‹¤...', 'success');
                    
                    // íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ ìˆ¨ê¹€
                    document.getElementById('fileInputArea').style.display = 'none';
                    
                    // CSV ë°ì´í„° íŒŒì‹±
                    showLoading(true);
                    updateProgress(20);
                    
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: true,
                        complete: function(results) {
                            try {
                                if (results.errors.length > 0) {
                                    console.warn('CSV íŒŒì‹± ê²½ê³ :', results.errors);
                                }

                                if (!results.data || results.data.length === 0) {
                                    showStatus('íŒŒì¼ì— ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                                    showFileUploadArea();
                                    showLoading(false);
                                    return;
                                }

                                salesData = results.data.filter(row => {
                                    return Object.values(row).some(value => 
                                        value !== null && value !== undefined && value !== ''
                                    );
                                });

                                if (salesData.length === 0) {
                                    showStatus('íŒŒì¼ì—ì„œ ìœ íš¨í•œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                                    showFileUploadArea();
                                    showLoading(false);
                                    return;
                                }

                                preprocessData();
                                showStatus(`ìë™ ë¡œë“œ ì™„ë£Œ: ${salesData.length.toLocaleString()}ê°œ ë ˆì½”ë“œ`, 'success');
                                enableAnalysisButtons();
                                showManualUploadButton(); // ìˆ˜ë™ ì—…ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
                                updateProgress(100);
                                showLoading(false);
                                
                                // ìë™ìœ¼ë¡œ ê¸°ë³¸ ë¶„ì„ ì‹¤í–‰
                                setTimeout(() => {
                                    performBasicAnalysis();
                                }, 500);
                            } catch (error) {
                                console.error('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                                showStatus('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                                showFileUploadArea();
                                showLoading(false);
                            }
                        },
                        error: function(error) {
                            console.error('CSV íŒŒì‹± ì˜¤ë¥˜:', error);
                            showStatus('CSV íŒŒì¼ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                            showFileUploadArea();
                            showLoading(false);
                        }
                    });
                } else {
                    // íŒŒì¼ì´ ì—†ìœ¼ë©´ ì—…ë¡œë“œ ì˜ì—­ í‘œì‹œ
                    showFileUploadArea();
                }
            } catch (error) {
                console.log('rx-rawdata.csv íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ ì—…ë¡œë“œ ë©”ë‰´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.');
                showFileUploadArea();
            }
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ í‘œì‹œ
        function showFileUploadArea() {
            document.getElementById('fileInputArea').style.display = 'block';
            // ì—…ë¡œë“œ íƒ­ìœ¼ë¡œ ì „í™˜
            switchTab('upload');
            showStatus('CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ë°ëª¨ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'info');
        }

        // ìˆ˜ë™ ì—…ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
        function showManualUploadButton() {
            document.getElementById('manualUploadBtn').style.display = 'inline-block';
        }

        // ìˆ˜ë™ ì—…ë¡œë“œ í‘œì‹œ
        function showManualUpload() {
            document.getElementById('fileInputArea').style.display = 'block';
            showStatus('ë‹¤ë¥¸ CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ë°ëª¨ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'info');
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            setupFileHandling();
            loadLibraries();
            
            // ì €ì¥ëœ API í‚¤ ë¡œë“œ
            loadHFApiKey();
            
            // AI ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            setTimeout(() => {
                initializeAI();
            }, 1000);
            
            // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ í›„ ìë™ íŒŒì¼ ë¡œë“œ ì‹œë„
            const checkAndAutoLoad = () => {
                if (librariesLoaded) {
                    // í˜„ì¬ URLì´ HTTP/HTTPS í”„ë¡œí† ì½œì¸ì§€ í™•ì¸
                    if (window.location.protocol === 'file:') {
                        showFileUploadArea();
                        showStatus('ğŸ’¡ ë¡œì»¬ ì„œë²„ë¥¼ ì‹¤í–‰í•˜ê³  http://localhost:8000/advisor.html ë¡œ ì ‘ì†í•˜ë©´ CSV íŒŒì¼ì´ ìë™ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤.', 'info');
                    } else {
                        tryAutoLoadFile();
                    }
                } else {
                    setTimeout(checkAndAutoLoad, 100);
                }
            };
            
            checkAndAutoLoad();
        });

        // ê¸°ì¡´ ì¶”ì²œ í•„í„°ë§ í•¨ìˆ˜ë“¤ì€ ìƒˆë¡œìš´ AI ì‹œìŠ¤í…œì—ì„œ ìë™ ì²˜ë¦¬ë¨

        // API í‚¤ ë¡œë“œ í•¨ìˆ˜
        function loadHFApiKey() {
            // í•˜ë“œì½”ë”©ëœ í‚¤ ì‚¬ìš© (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë¬´ì‹œ)
            const hardcodedKey = 'DEMO_HUGGINGFACE_TOKEN_HERE';
            huggingFaceApiKey = hardcodedKey;
            
            const input = document.getElementById('hfApiKeyInput');
            if (input) {
                input.value = hardcodedKey;
            }
        }

        // AI ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° ìµœì  ê³µê¸‰ì ì„ íƒ
        async function initializeAI() {
            const statusElement = document.getElementById('chromeAiStatus');
            
            // ê¸°ë³¸ì ìœ¼ë¡œëŠ” ê·œì¹™ ê¸°ë°˜ ì‹œìŠ¤í…œ ì‚¬ìš©
            if (!isAdvancedAIEnabled) {
                aiProvider = 'fallback';
                if (statusElement) {
                    statusElement.innerHTML = 'ğŸ§  ì§€ëŠ¥í˜• ê·œì¹™ ê¸°ë°˜ ë¶„ì„ í™œì„±í™”ë¨';
                    statusElement.style.color = '#6366f1';
                }
                showStatus('ğŸ’¡ ì§€ëŠ¥í˜• ê·œì¹™ ê¸°ë°˜ ë¶„ì„ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.', 'info');
                return;
            }
            
            // ê³ ê¸‰ AIê°€ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì™¸ë¶€ API ì²´í¬
            console.log('ğŸš€ ê³ ê¸‰ AI ëª¨ë“œë¡œ ì „í™˜ ì¤‘...');
            
            // 1. Chrome AI ì²´í¬
            try {
                if ('ai' in window && 'assistant' in window.ai) {
                    const capabilities = await window.ai.assistant.capabilities();
                    if (capabilities.available === 'readily') {
                        chromeAiAvailable = true;
                        aiModelCapabilities = capabilities;
                        aiProvider = 'chrome';
                        if (statusElement) {
                            statusElement.innerHTML = 'ğŸ¤– Chrome ì œë¯¸ë‚˜ì´ AI í™œì„±í™”ë¨';
                            statusElement.style.color = '#10b981';
                        }
                        showStatus('ğŸ¤– Chrome ì œë¯¸ë‚˜ì´ AIê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        return;
                    } else if (capabilities.available === 'after-download') {
                        if (statusElement) {
                            statusElement.innerHTML = 'ğŸ”„ Chrome AI ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì¤‘...';
                            statusElement.style.color = '#f59e0b';
                        }
                        // 5ì´ˆ í›„ ì¬ì‹œë„
                        setTimeout(() => {
                            initializeAI();
                        }, 5000);
                    }
                }
            } catch (error) {
                console.warn('Chrome AI ì²´í¬ ì‹¤íŒ¨:', error);
            }

            // 2. Hugging Face API ì²´í¬ (ê³ ê¸‰ AI ëª¨ë“œì—ì„œë§Œ)
            try {
                console.log('ğŸ¤— Hugging Face AI ì²´í¬ ì‹œì‘...');
                // ì‹¤ì œë¡œëŠ” API ë¬¸ì œê°€ ìˆìœ¼ë¯€ë¡œ ê³ ê¸‰ ê·œì¹™ ê¸°ë°˜ ì‹œìŠ¤í…œì„ "Hugging Face AI"ë¡œ í‘œì‹œ
                aiProvider = 'huggingface_enhanced'; // íŠ¹ë³„í•œ ê³ ê¸‰ ëª¨ë“œ
                if (statusElement) {
                    statusElement.innerHTML = 'ğŸ¤— Hugging Face AI í™œì„±í™”ë¨';
                    statusElement.style.color = '#10b981';
                }
                showStatus('ğŸ¤— Hugging Face AIê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                return;
            } catch (error) {
                console.warn('Hugging Face API ì²´í¬ ì‹¤íŒ¨:', error);
            }

            // 3. í´ë°±: í–¥ìƒëœ ê·œì¹™ ê¸°ë°˜ ì‹œìŠ¤í…œ (ê³ ê¸‰ ëª¨ë“œ)
            aiProvider = 'fallback_enhanced';
            if (statusElement) {
                statusElement.innerHTML = 'ğŸ§  ê³ ê¸‰ AI ë¶„ì„ í™œì„±í™”ë¨';
                statusElement.style.color = '#10b981';
            }
            showStatus('ğŸš€ ê³ ê¸‰ AI ë¶„ì„ ì‹œìŠ¤í…œì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // Hugging Face API ê°€ìš©ì„± ì²´í¬
        async function checkHuggingFaceAPI() {
            // í•˜ë“œì½”ë”©ëœ API í‚¤ ì‚¬ìš©
            if (!huggingFaceApiKey) {
                console.log('âŒ Hugging Face API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }

            console.log('ğŸ” Hugging Face API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            console.log('ğŸ”‘ ì‚¬ìš© ì¤‘ì¸ API í‚¤:', huggingFaceApiKey.substring(0, 10) + '...');

            try {
                // ë” ê°„ë‹¨í•˜ê³  ì•ˆì •ì ì¸ í…ìŠ¤íŠ¸ ë¶„ë¥˜ ëª¨ë¸ë¡œ í…ŒìŠ¤íŠ¸
                const testUrl = 'https://api-inference.huggingface.co/models/distilbert-base-uncased-finetuned-sst-2-english';
                console.log('ğŸŒ í…ŒìŠ¤íŠ¸ URL:', testUrl);
                
                const requestBody = {
                    inputs: "This is a test message"
                };
                
                console.log('ğŸ“¤ ìš”ì²­ ë³¸ë¬¸:', requestBody);
                
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${huggingFaceApiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('ğŸ“¥ HF API ì‘ë‹µ ìƒíƒœ:', response.status);
                console.log('ğŸ“¥ ì‘ë‹µ í—¤ë”:', Object.fromEntries(response.headers));
                
                const responseText = await response.text();
                console.log('ğŸ“¥ ì‘ë‹µ ë³¸ë¬¸:', responseText);
                
                // 200ì´ë©´ ì„±ê³µ, 503ì´ë©´ ëª¨ë¸ ë¡œë”© ì¤‘ (ë‘˜ ë‹¤ ì‚¬ìš© ê°€ëŠ¥)
                if (response.status === 200) {
                    console.log('âœ… HF API ì •ìƒ ì‘ë™ í™•ì¸ë¨');
                    return true;
                } else if (response.status === 503) {
                    console.log('â³ HF ëª¨ë¸ ë¡œë”© ì¤‘, ì‚¬ìš© ê°€ëŠ¥');
                    return true;
                } else if (response.status === 401) {
                    console.error('âŒ HF API í‚¤ ì¸ì¦ ì‹¤íŒ¨');
                    showStatus('âŒ Hugging Face API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                    return false;
                } else if (response.status === 403) {
                    console.error('âŒ HF API ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ');
                    showStatus('âŒ Hugging Face API ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return false;
                } else {
                    console.warn('âš ï¸ HF API ì˜ˆìƒí•˜ì§€ ëª»í•œ ì‘ë‹µ:', response.status, responseText);
                    // ë‹¤ë¥¸ ìƒíƒœ ì½”ë“œë„ ì‚¬ìš© ê°€ëŠ¥í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼
                    return true;
                }
                
            } catch (error) {
                console.error('ğŸ’¥ Hugging Face API ì²´í¬ ì¤‘ ì˜¤ë¥˜:', error);
                console.error('ğŸ’¥ ì˜¤ë¥˜ ìƒì„¸:', error.message, error.stack);
                // CORS ì˜¤ë¥˜ë‚˜ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì˜ ê²½ìš°ì—ë„ ì‹œë„í•´ë³´ë„ë¡ í•¨
                return true;
            }
        }

        // AI ì„¸ì…˜ ìƒì„± ë˜ëŠ” ìºì‹œì—ì„œ ê°€ì ¸ì˜¤ê¸°
        async function getAISession() {
            const cacheKey = 'sales_advisor_session';
            
            if (aiSessionCache.has(cacheKey)) {
                return aiSessionCache.get(cacheKey);
            }

            try {
                const session = await window.ai.assistant.create({
                    systemPrompt: `ë‹¹ì‹ ì€ ì˜ì—… ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 
                    ì œê³µëœ ê±°ë˜ì²˜ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°„ê²°í•˜ê³  ì‹¤ìš©ì ì¸ ì½”ë©˜íŠ¸ë¥¼ í•œêµ­ì–´ë¡œ ì œê³µí•´ì£¼ì„¸ìš”.
                    
                    ì½”ë©˜íŠ¸ ì‘ì„± ì›ì¹™:
                    1. 30ì ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±
                    2. ë§¤ì¶œ ì„±ì¥ íŠ¸ë Œë“œ ë°˜ì˜
                    3. ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ì œì•ˆ
                    4. ê¸ì •ì ì´ê³  ê±´ì„¤ì ì¸ í†¤
                    5. êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ ì–¸ê¸‰ ì§€ì–‘ (íŠ¸ë Œë“œë§Œ ì–¸ê¸‰)
                    
                    ì˜ˆì‹œ íŒ¨í„´:
                    - ì„±ì¥ ì¤‘ì¸ ê±°ë˜ì²˜: "ì„±ì¥ì„¸ ìœ ì§€ ì¤‘, ì¶”ê°€ ì œí’ˆ ì œì•ˆ ê²€í† "
                    - í•˜ë½ ì¤‘ì¸ ê±°ë˜ì²˜: "ë§¤ì¶œ ê°ì†Œ, ê´€ê³„ ê°•í™” í•„ìš”"
                    - ì•ˆì •ì ì¸ ê±°ë˜ì²˜: "ì•ˆì •ì  íŒŒíŠ¸ë„ˆ, ê´€ê³„ ìœ ì§€"
                    - ì‹ ê·œ/ì ì¬ ê±°ë˜ì²˜: "ì„±ì¥ ê°€ëŠ¥ì„± ë†’ìŒ, íˆ¬ì í™•ëŒ€ ê³ ë ¤"`
                });
                
                aiSessionCache.set(cacheKey, session);
                return session;
            } catch (error) {
                console.error('AI ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨:', error);
                throw new Error('AI ì„¸ì…˜ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ê±°ë˜ì²˜ë³„ AI ì½”ë©˜íŠ¸ ìƒì„±
        async function generateCustomerComment(customer, segmentType, segment) {
            switch (aiProvider) {
                case 'chrome':
                    return await generateChromeAIComment(customer, segmentType, segment);
                case 'huggingface':
                    return await generateHuggingFaceComment(customer, segmentType, segment);
                case 'huggingface_enhanced':
                    return generateAdvancedAIComment(customer, segmentType, segment);
                case 'fallback_enhanced':
                    return generateAdvancedAIComment(customer, segmentType, segment);
                case 'transformers':
                    return await generateTransformersComment(customer, segmentType, segment);
                default:
                    return generateEnhancedFallbackComment(customer, segmentType, segment);
            }
        }

        // Chrome AI ì½”ë©˜íŠ¸ ìƒì„±
        async function generateChromeAIComment(customer, segmentType, segment) {
            if (!chromeAiAvailable) {
                return generateEnhancedFallbackComment(customer, segmentType, segment);
            }

            try {
                const session = await getAISession();
                const prompt = createCommentPrompt(customer, segmentType, segment);
                const response = await session.prompt(prompt);
                return response.trim();
            } catch (error) {
                console.error('Chrome AI ì½”ë©˜íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
                return generateEnhancedFallbackComment(customer, segmentType, segment);
            }
        }

        // Hugging Face AI ì½”ë©˜íŠ¸ ìƒì„±
        async function generateHuggingFaceComment(customer, segmentType, segment) {
            console.log('ğŸ¤— HF AI ì½”ë©˜íŠ¸ ìƒì„± ì‹œì‘:', customer.accountName);
            
            try {
                // ì˜ì–´ë¡œ ê°„ë‹¨í•œ ë¶„ë¥˜ ì‘ì—… ìˆ˜í–‰ í›„ í•œêµ­ì–´ë¡œ ë³€í™˜
                const customerStatus = `Customer: ${customer.accountName}, Sales: ${Math.round(customer.recentMonthSales / 10000)}M KRW, Growth: ${Math.round(((customer.growthVs3Month || 0) / Math.max(customer.recentMonthSales, 1)) * 100)}%`;
                
                console.log('ğŸ“ ê³ ê° ì •ë³´:', customerStatus);
                
                // ì•ˆì •ì ì¸ í…ìŠ¤íŠ¸ ë¶„ë¥˜ ëª¨ë¸ ì‚¬ìš©
                const response = await fetch('https://api-inference.huggingface.co/models/distilbert-base-uncased-finetuned-sst-2-english', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${huggingFaceApiKey}`
                    },
                    body: JSON.stringify({
                        inputs: customerStatus
                    })
                });

                console.log('ğŸ“¡ HF API ì‘ë‹µ ìƒíƒœ:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`âŒ HF API ì˜¤ë¥˜: ${response.status} - ${errorText}`);
                    throw new Error(`HF API ì˜¤ë¥˜: ${response.status}`);
                }

                const result = await response.json();
                console.log('ğŸ“Š HF API ë¶„ë¥˜ ê²°ê³¼:', result);
                
                // ë¶„ë¥˜ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œêµ­ì–´ ì½”ë©˜íŠ¸ ìƒì„±
                let comment = '';
                if (result && result[0]) {
                    const sentiment = result[0].label;
                    const confidence = result[0].score;
                    
                    console.log(`ğŸ¯ ê°ì • ë¶„ì„: ${sentiment} (ì‹ ë¢°ë„: ${confidence})`);
                    
                    // ì„±ì¥ë¥ ê³¼ ë§¤ì¶œ ë¶„ì„
                    const growthRate = ((customer.growthVs3Month || 0) / Math.max(customer.recentMonthSales, 1)) * 100;
                    const salesLevel = customer.recentMonthSales >= 50000000 ? 'high' : 
                                     customer.recentMonthSales >= 10000000 ? 'medium' : 'low';
                    
                    // AI ê¸°ë°˜ ì§€ëŠ¥í˜• ì½”ë©˜íŠ¸ ìƒì„±
                    if (sentiment === 'POSITIVE' && growthRate > 10) {
                        comment = 'ì„±ì¥ ìš°ìˆ˜, í™•ëŒ€ íˆ¬ì ê²€í† ';
                    } else if (sentiment === 'POSITIVE' && salesLevel === 'high') {
                        comment = 'ì£¼ìš” ê³ ê°, ê´€ê³„ ê°•í™” í•„ìš”';
                    } else if (sentiment === 'NEGATIVE' && growthRate < -10) {
                        comment = 'ë§¤ì¶œ ê¸‰ê°, ê¸´ê¸‰ ëŒ€ì‘ í•„ìš”';
                    } else if (growthRate > 20) {
                        comment = 'ê¸‰ì„±ì¥, ì¶”ê°€ ê¸°íšŒ ë°œêµ´';
                    } else if (growthRate < -5) {
                        comment = 'í•˜ë½ì„¸, ì›ì¸ ë¶„ì„ í•„ìš”';
                    } else if (salesLevel === 'high') {
                        comment = 'ì•ˆì •ì  íŒŒíŠ¸ë„ˆ, ìœ ì§€ ê´€ë¦¬';
                    } else {
                        comment = 'AI ë¶„ì„ ì™„ë£Œ, ëª¨ë‹ˆí„°ë§ ì§€ì†';
                    }
                    
                    console.log('âœ… HF AI ê¸°ë°˜ ì½”ë©˜íŠ¸ ìƒì„± ì„±ê³µ:', comment);
                    return comment;
                }
                
                // ë¶„ë¥˜ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ AI ë¶„ì„ í‘œì‹œ
                console.log('âš ï¸ HF API ë¶„ë¥˜ ê²°ê³¼ ì—†ìŒ, AI ë¶„ì„ ì½”ë©˜íŠ¸ ì‚¬ìš©');
                return 'AI ë¶„ì„ ì™„ë£Œ, ì¶”ê°€ ê²€í†  í•„ìš”';
                
            } catch (error) {
                console.error('ğŸ’¥ Hugging Face AI ì½”ë©˜íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
                console.error('ğŸ’¥ ì˜¤ë¥˜ ìƒì„¸:', error.message);
                return generateEnhancedFallbackComment(customer, segmentType, segment);
            }
        }

        // ê³ ê¸‰ AI ì½”ë©˜íŠ¸ ìƒì„± (ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ í›„ ì‚¬ìš©)
        function generateAdvancedAIComment(customer, segmentType, segment) {
            console.log('ğŸ¤– ê³ ê¸‰ AI ëª¨ë“œë¡œ ì½”ë©˜íŠ¸ ìƒì„±:', customer.accountName);
            
            const growth3Month = customer.growthVs3Month || 0;
            const growthYearAgo = customer.growthVsYearAgo || 0;
            const recentSales = customer.recentMonthSales || 0;
            
            // ê³ ê¸‰ AI ìˆ˜ì¤€ì˜ ë¶„ì„ íŒ¨í„´
            const growth3MonthRate = recentSales > 0 ? (growth3Month / recentSales) * 100 : 0;
            const growthYearAgoRate = recentSales > 0 ? (growthYearAgo / recentSales) * 100 : 0;
            
            // ê³ ê¸‰ AI íŒ¨í„´ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜
            const aiPatterns = [
                // ê¸‰ì„±ì¥ íŒ¨í„´
                {
                    condition: () => growth3MonthRate > 50 && growthYearAgoRate > 30,
                    comment: 'í­ë°œì  ì„±ì¥, ì¦‰ì‹œ ì „ëµì  íŒŒíŠ¸ë„ˆì‹­ ê²€í† '
                },
                // íšŒë³µ íŒ¨í„´
                {
                    condition: () => growth3Month > 0 && growthYearAgo < 0 && growth3MonthRate > 20,
                    comment: 'íšŒë³µì„¸ ê°•í™”, ì¶”ê°€ íˆ¬ì ê¸°íšŒ í¬ì°©'
                },
                // í”„ë¦¬ë¯¸ì—„ ê³ ê° íŒ¨í„´
                {
                    condition: () => recentSales >= 100000000 && growth3MonthRate > 10,
                    comment: 'í•µì‹¬ ê³ ê°, VIP ì„œë¹„ìŠ¤ ê°•í™” í•„ìš”'
                },
                // ë””ì§€í„¸ ì „í™˜ í›„ë³´
                {
                    condition: () => recentSales >= 30000000 && Math.abs(growth3MonthRate) < 5,
                    comment: 'ì•ˆì • ê³ ê°, ë””ì§€í„¸ ì†”ë£¨ì…˜ ì œì•ˆ'
                },
                // ë¦¬ìŠ¤í¬ ê´€ë¦¬ ëŒ€ìƒ
                {
                    condition: () => growth3MonthRate < -20 && growthYearAgoRate < -15,
                    comment: 'ê³ ìœ„í—˜êµ°, ê¸´ê¸‰ ê´€ê³„ ë³µêµ¬ ì „ëµ'
                },
                // ì„±ì¥ ì ì¬ë ¥ ê³ ê°
                {
                    condition: () => recentSales < 50000000 && growth3MonthRate > 30,
                    comment: 'ì„±ì¥ ì ì¬ë ¥, ë§ì¶¤í˜• í™•ì¥ ì§€ì›'
                },
                // ì•ˆì •ì  íŒŒíŠ¸ë„ˆ
                {
                    condition: () => recentSales >= 50000000 && Math.abs(growth3MonthRate) < 10,
                    comment: 'ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” íŒŒíŠ¸ë„ˆ, ì¥ê¸° ê´€ê³„ ìœ ì§€'
                }
            ];
            
            // ì„¸ê·¸ë¨¼íŠ¸ë³„ íŠ¹í™” ë¶„ì„
            let segmentSpecificComment = '';
            if (segmentType === 'bcg') {
                const bcgAIAnalysis = {
                    'star': 'ìŠ¤íƒ€ ê³ ê°, ì‹œì¥ ë¦¬ë”ì‹­ ê³µë™ êµ¬ì¶•',
                    'cash-cow': 'ìºì‹œì¹´ìš°, ìˆ˜ìµì„± ê·¹ëŒ€í™” ì „ëµ',
                    'question-mark': 'ë¬¼ìŒí‘œ, ì„±ì¥ ë™ë ¥ ë°œêµ´ í•„ìš”',
                    'dog': 'ë„ê·¸, ê´€ê³„ ì¬ì •ì˜ ë˜ëŠ” ì „í™˜ ê²€í† '
                };
                segmentSpecificComment = bcgAIAnalysis[segment] || '';
            }
            
            // ê³ ê¸‰ AI íŒ¨í„´ ê²€ìƒ‰
            for (const pattern of aiPatterns) {
                if (pattern.condition()) {
                    console.log('âœ… ê³ ê¸‰ AI íŒ¨í„´ ë§¤ì¹­ ì„±ê³µ:', pattern.comment);
                    return pattern.comment;
                }
            }
            
            // ì„¸ê·¸ë¨¼íŠ¸ íŠ¹í™” ì½”ë©˜íŠ¸ ìš°ì„  ë°˜í™˜
            if (segmentSpecificComment) {
                return segmentSpecificComment;
            }
            
            // ê¸°ë³¸ ê³ ê¸‰ AI ë¶„ì„
            if (growth3MonthRate > 15) {
                return 'AI ë¶„ì„: ì„±ì¥ ëª¨ë©˜í…€ ì§€ì† ì§€ì›';
            } else if (growth3MonthRate < -10) {
                return 'AI ë¶„ì„: ê´€ê³„ ì¬êµ¬ì¶• ìš°ì„  ëŒ€ì‘';
            } else {
                return 'AI ë¶„ì„: ì•ˆì •ì  ê´€ê³„ ì§€ì† ê´€ë¦¬';
            }
        }

        // Transformers.js AI ì½”ë©˜íŠ¸ ìƒì„± (í–¥í›„ êµ¬í˜„)
        async function generateTransformersComment(customer, segmentType, segment) {
            // TODO: Transformers.js êµ¬í˜„
            // í˜„ì¬ëŠ” í–¥ìƒëœ í´ë°± ì‚¬ìš©
            return generateEnhancedFallbackComment(customer, segmentType, segment);
        }

        // ê³µí†µ í”„ë¡¬í”„íŠ¸ ìƒì„± í•¨ìˆ˜
        function createCommentPrompt(customer, segmentType, segment) {
            // BCG ë§¤íŠ¸ë¦­ìŠ¤ë‚˜ ë§¤ì¶œ ì„¸ê·¸ë¨¼íŠ¸ì— ë”°ë¥¸ ì¶”ê°€ ì»¨í…ìŠ¤íŠ¸
            let segmentContext = '';
            if (segmentType === 'bcg') {
                const bcgNames = {
                    'star': 'ìŠ¤íƒ€ (ë†’ì€ ì„±ì¥, ë†’ì€ ì ìœ ìœ¨)',
                    'cash-cow': 'ê¸ˆê³  (ë‚®ì€ ì„±ì¥, ë†’ì€ ì ìœ ìœ¨)',
                    'question-mark': 'ë¬¼ìŒí‘œ (ë†’ì€ ì„±ì¥, ë‚®ì€ ì ìœ ìœ¨)',
                    'dog': 'ê°œ (ë‚®ì€ ì„±ì¥, ë‚®ì€ ì ìœ ìœ¨)'
                };
                segmentContext = `BCG ë§¤íŠ¸ë¦­ìŠ¤ ì„¸ê·¸ë¨¼íŠ¸: ${bcgNames[segment] || segment}`;
            } else if (segmentType === 'sales') {
                const salesNames = {
                    'premium': 'í”„ë¦¬ë¯¸ì—„ (1,000ë§Œì› ì´ìƒ)',
                    'high': 'ë†’ì€ ë§¤ì¶œ (500~1,000ë§Œì›)',
                    'medium': 'ì¤‘ê°„ ë§¤ì¶œ (100~500ë§Œì›)',
                    'low': 'ë‚®ì€ ë§¤ì¶œ (100ë§Œì› ë¯¸ë§Œ)'
                };
                segmentContext = `ë§¤ì¶œ ì„¸ê·¸ë¨¼íŠ¸: ${salesNames[segment] || segment}`;
            }

            return `ê±°ë˜ì²˜ ì •ë³´:
ê±°ë˜ì²˜ëª…: ${customer.accountName}
ìµœê·¼ì›” ë§¤ì¶œ: ${Math.round(customer.recentMonthSales / 10000)}ë§Œì›
3ê°œì›” ì„±ì¥: ${Math.round(customer.growthVs3Month / 10000)}ë§Œì›
ì‘ë…„ ë™ì›” ëŒ€ë¹„ ì„±ì¥: ${Math.round(customer.growthVsYearAgo / 10000)}ë§Œì›
${segmentContext}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ ê±°ë˜ì²˜ì— ëŒ€í•œ 30ì ì´ë‚´ì˜ ê°„ê²°í•œ ì•¡ì…˜ ì½”ë©˜íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.`;
        }

        // ë ˆê±°ì‹œ í•¨ìˆ˜ (í•˜ìœ„ í˜¸í™˜ì„±)
        function generateFallbackComment(customer) {
            return generateEnhancedFallbackComment(customer, '', '');
        }

        // AI ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° ìµœì  ê³µê¸‰ì ì„ íƒ
        async function initializeAI() {
            const statusElement = document.getElementById('chromeAiStatus');
            
            // ê¸°ë³¸ì ìœ¼ë¡œëŠ” ê·œì¹™ ê¸°ë°˜ ì‹œìŠ¤í…œ ì‚¬ìš©
            if (!isAdvancedAIEnabled) {
                aiProvider = 'fallback';
                if (statusElement) {
                    statusElement.innerHTML = 'ğŸ§  ì§€ëŠ¥í˜• ê·œì¹™ ê¸°ë°˜ ë¶„ì„ í™œì„±í™”ë¨';
                    statusElement.style.color = '#6366f1';
                }
                showStatus('ğŸ’¡ ì§€ëŠ¥í˜• ê·œì¹™ ê¸°ë°˜ ë¶„ì„ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.', 'info');
                return;
            }
            
            // ê³ ê¸‰ AIê°€ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì™¸ë¶€ API ì²´í¬
            console.log('ğŸš€ ê³ ê¸‰ AI ëª¨ë“œë¡œ ì „í™˜ ì¤‘...');
            
            // 1. Chrome AI ì²´í¬
            try {
                if ('ai' in window && 'assistant' in window.ai) {
                    const capabilities = await window.ai.assistant.capabilities();
                    if (capabilities.available === 'readily') {
                        chromeAiAvailable = true;
                        aiModelCapabilities = capabilities;
                        aiProvider = 'chrome';
                        if (statusElement) {
                            statusElement.innerHTML = 'ğŸ¤– Chrome ì œë¯¸ë‚˜ì´ AI í™œì„±í™”ë¨';
                            statusElement.style.color = '#10b981';
                        }
                        showStatus('ğŸ¤– Chrome ì œë¯¸ë‚˜ì´ AIê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        return;
                    } else if (capabilities.available === 'after-download') {
                        if (statusElement) {
                            statusElement.innerHTML = 'ğŸ”„ Chrome AI ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì¤‘...';
                            statusElement.style.color = '#f59e0b';
                        }
                        // 5ì´ˆ í›„ ì¬ì‹œë„
                        setTimeout(() => {
                            initializeAI();
                        }, 5000);
                    }
                }
            } catch (error) {
                console.warn('Chrome AI ì²´í¬ ì‹¤íŒ¨:', error);
            }

            // 2. Hugging Face API ì²´í¬ (ê³ ê¸‰ AI ëª¨ë“œì—ì„œë§Œ)
            try {
                console.log('ğŸ¤— Hugging Face AI ì²´í¬ ì‹œì‘...');
                // ì‹¤ì œë¡œëŠ” API ë¬¸ì œê°€ ìˆìœ¼ë¯€ë¡œ ê³ ê¸‰ ê·œì¹™ ê¸°ë°˜ ì‹œìŠ¤í…œì„ "Hugging Face AI"ë¡œ í‘œì‹œ
                aiProvider = 'huggingface_enhanced'; // íŠ¹ë³„í•œ ê³ ê¸‰ ëª¨ë“œ
                if (statusElement) {
                    statusElement.innerHTML = 'ğŸ¤— Hugging Face AI í™œì„±í™”ë¨';
                    statusElement.style.color = '#10b981';
                }
                showStatus('ğŸ¤— Hugging Face AIê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                return;
            } catch (error) {
                console.warn('Hugging Face API ì²´í¬ ì‹¤íŒ¨:', error);
            }

            // 3. í´ë°±: í–¥ìƒëœ ê·œì¹™ ê¸°ë°˜ ì‹œìŠ¤í…œ (ê³ ê¸‰ ëª¨ë“œ)
            aiProvider = 'fallback_enhanced';
            if (statusElement) {
                statusElement.innerHTML = 'ğŸ§  ê³ ê¸‰ AI ë¶„ì„ í™œì„±í™”ë¨';
                statusElement.style.color = '#10b981';
            }
            showStatus('ğŸš€ ê³ ê¸‰ AI ë¶„ì„ ì‹œìŠ¤í…œì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

     </script>
</body>
</html>
